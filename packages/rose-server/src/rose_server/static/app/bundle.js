(()=>{var u=()=>({disabled:!1,label:"Ask",getQuery(){return this.$el.closest("form")?.querySelector('input[name="q"]')?.value?.trim()||""},async ask(){let e=this.getQuery();if(!(!e||this.disabled)){this.disabled=!0;try{let s=await(await fetch("/v1/threads",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:[{role:"user",content:e}]})})).json();if(!s?.thread_id)throw new Error("Missing thread_id");window.location.href="/v1/threads/"+s.thread_id}catch(t){alert("Error: "+(t?.message||String(t)))}finally{this.disabled=!1}}}});var p=()=>({uuid:null,accepted:!1,init(){this.uuid=this.$el.dataset.uuid,this.accepted=this.$el.classList.contains("accepted")},async toggleAccepted(){try{let e=await fetch(`/v1/messages/${this.uuid}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({accepted:!this.accepted})});if(!e.ok)throw new Error(`HTTP ${e.status}`);this.accepted=!this.accepted}catch(e){console.error("Error:",e)}}});var f=()=>({pending:!1,assistantEventSource:null,systemEventSource:null,createPlaceholder(e){let t=this.$refs.placeholderTemplate.content.cloneNode(!0),s=t.querySelector(".message");return s.dataset.tempId=e,t},parseHtmlElement(e){let t=document.createElement("template");return t.innerHTML=String(e).trim(),t.content.firstElementChild},cleanupEventStreams(){this.assistantEventSource&&this.assistantEventSource.close(),this.systemEventSource&&this.systemEventSource.close(),this.assistantEventSource=null,this.systemEventSource=null},cleanupAssistantStream(){this.assistantEventSource&&this.assistantEventSource.close(),this.assistantEventSource=null},cleanupSystemStream(){this.systemEventSource&&this.systemEventSource.close(),this.systemEventSource=null},startEventStreams(e,t){this.assistantEventSource||this.systemEventSource||(this.assistantEventSource=new EventSource(`/v1/threads/${e}/events?role=assistant`),this.systemEventSource=new EventSource(`/v1/threads/${e}/events?role=system`),this.assistantEventSource.addEventListener("assistant",async s=>{try{let o=JSON.parse(s?.data||"{}")?.uuid;if(!o)return;let n=await fetch(`/v1/messages/${o}/fragment`,{headers:{Accept:"text/html"}});if(!n.ok)return;let c=await n.text(),r=this.parseHtmlElement(c),a=this.$refs.responses.querySelector(`[data-temp-id="${t}"]`);a&&r&&a.replaceWith(r)}finally{this.cleanupEventStreams()}}),this.systemEventSource.addEventListener("system",async s=>{let i=JSON.parse(s?.data||"{}"),o=i?.uuid,n=i?.meta||{};if(o&&!(n?.object!=="job"||n?.status!=="failed"))try{let c=await fetch(`/v1/messages/${o}/fragment`,{headers:{Accept:"text/html"}});if(!c.ok)return;let r=await c.text(),a=this.parseHtmlElement(r),l=this.$refs.responses.querySelector(`[data-temp-id="${t}"]`);l&&a&&l.replaceWith(a)}finally{this.cleanupEventStreams()}}),this.assistantEventSource.addEventListener("error",()=>this.cleanupAssistantStream()),this.systemEventSource.addEventListener("error",()=>this.cleanupSystemStream()))},init(){if(!this.$refs.responses||this.$refs.responses.children.length)return;let e=this.$el?.dataset?.threadId;if(!e)return;let t="initial",s=this.createPlaceholder(t);this.$refs.responses.prepend(s),this.startEventStreams(e,t)},async regenerate(e){if(this.pending)return;let t=e?.currentTarget,s=t?.dataset?.threadId,i=t?.dataset?.promptContent,o=t?.dataset?.model;if(!s||!i)return;this.pending=!0;let n=Math.random().toString(36).slice(2,10),c=this.createPlaceholder(n);this.$refs.responses.prepend(c);try{let r=await fetch("/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({thread_id:s,model:o,messages:[{role:"user",content:i}]})});if(!r.ok)throw new Error(`Completion HTTP ${r.status}`);let l=(await r.json()).message_uuid;if(!l)throw new Error("Chat response missing message uuid");let d=await fetch(`/v1/messages/${l}/fragment`,{headers:{Accept:"text/html"}});if(!d.ok)throw new Error(`Fragment HTTP ${d.status}`);let E=await d.text(),h=this.parseHtmlElement(E);if(!h)throw new Error("Empty fragment");let m=this.$refs.responses.querySelector(`[data-temp-id="${n}"]`);m&&m.replaceWith(h)}catch(r){console.error("Error:",r);let a=this.$refs.responses.querySelector(`[data-temp-id="${n}"]`);a&&a.remove()}finally{this.pending=!1}}});document.addEventListener("alpine:init",()=>{Alpine.data("askButton",u),Alpine.data("responseMessage",p),Alpine.data("threadPage",f)});})();
