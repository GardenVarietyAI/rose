(()=>{var f=()=>({disabled:!1,label:"Ask",getQuery(){return this.$el.closest("form")?.querySelector('[name="q"]:not([disabled])')?.value?.trim()||""},getLensId(){return this.$el.closest("form")?.querySelector('select[name="lens_id"]')?.value?.trim()||""||null},async ask(){let e=this.getQuery();if(!(!e||this.disabled)){this.disabled=!0;try{let t=this.getLensId(),r=await(await fetch("/v1/threads",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:[{role:"user",content:e}],lens_id:t||void 0})})).json();if(!r?.thread_id)throw new Error("Missing thread_id");window.location.href="/v1/threads/"+r.thread_id}catch(t){alert("Error: "+(t?.message||String(t)))}finally{this.disabled=!1}}}});var p=()=>({uuid:null,accepted:!1,collapsed:!1,expanded:!1,init(){this.uuid=this.$el.dataset.uuid,this.accepted=this.$el.classList.contains("accepted")},async toggleAccepted(){try{let e=await fetch(`/v1/messages/${this.uuid}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({accepted:!this.accepted})});if(!e.ok)throw new Error(`HTTP ${e.status}`);this.accepted=!this.accepted}catch(e){console.error("Error:",e)}}});var g=()=>({value:"",isMultiline:!1,multilineThreshold:80,settingsOpen:!1,init(){this.value=this.$el?.dataset?.initialQuery||"",this.updateMode(),this.$watch("value",()=>this.updateMode())},updateMode(){let e=this.value.length>this.multilineThreshold||this.value.includes(`
`);e!==this.isMultiline&&(this.isMultiline=e,this.$nextTick(()=>{let t=this.isMultiline?this.$refs?.multi:this.$refs?.single;t&&(t.focus(),typeof t.setSelectionRange=="function"&&t.setSelectionRange(t.value.length,t.value.length),this.isMultiline&&this.autogrow(t))}))},handlePaste(e){let t=e?.clipboardData?.getData("text")||"";if(!t.includes(`
`))return;e.preventDefault();let s=e.target,r=typeof s?.selectionStart=="number"?s.selectionStart:this.value.length,a=typeof s?.selectionEnd=="number"?s.selectionEnd:this.value.length;this.value=`${this.value.slice(0,r)}${t}${this.value.slice(a)}`,this.isMultiline=!0,this.$nextTick(()=>{let n=this.$refs?.multi;if(n){if(n.focus(),typeof n.setSelectionRange=="function"){let i=r+t.length;n.setSelectionRange(i,i)}this.autogrow(n)}})},autogrow(e){e&&(e.style.height="auto",e.style.height=`${e.scrollHeight}px`)},submit(){let e=this.$refs?.form;e&&e.requestSubmit()},clearLenses(){let e=this.$refs?.lensSelect;e&&(e.value="")}});var v=()=>({pending:!1,assistantEventSource:null,systemEventSource:null,createPlaceholder(e){let t=this.$refs.placeholderTemplate.content.cloneNode(!0),s=t.querySelector(".message");return s.dataset.tempId=e,t},parseHtmlElement(e){let t=document.createElement("template");return t.innerHTML=String(e).trim(),t.content.firstElementChild},cleanupEventStreams(){this.assistantEventSource&&this.assistantEventSource.close(),this.systemEventSource&&this.systemEventSource.close(),this.assistantEventSource=null,this.systemEventSource=null},cleanupAssistantStream(){this.assistantEventSource&&this.assistantEventSource.close(),this.assistantEventSource=null},cleanupSystemStream(){this.systemEventSource&&this.systemEventSource.close(),this.systemEventSource=null},startEventStreams(e,t,{afterAssistantUuid:s=null,afterSystemUuid:r=null}={}){if(this.assistantEventSource||this.systemEventSource)return;let a=new URL(`/v1/threads/${e}/events`,window.location.origin);a.searchParams.set("role","assistant"),s&&a.searchParams.set("after_uuid",s);let n=new URL(`/v1/threads/${e}/events`,window.location.origin);n.searchParams.set("role","system"),r&&n.searchParams.set("after_uuid",r),this.assistantEventSource=new EventSource(a),this.systemEventSource=new EventSource(n),this.assistantEventSource.addEventListener("assistant",async i=>{try{let c=JSON.parse(i?.data||"{}")?.uuid;if(!c)return;let l=await fetch(`/v1/messages/${c}/fragment`,{headers:{Accept:"text/html"}});if(!l.ok)return;let h=await l.text(),d=this.parseHtmlElement(h),u=this.$refs.responses.querySelector(`[data-temp-id="${t}"]`);u&&d&&u.replaceWith(d)}finally{this.cleanupEventStreams()}}),this.systemEventSource.addEventListener("system",async i=>{let o=JSON.parse(i?.data||"{}"),c=o?.uuid,l=o?.meta||{};if(c&&!(l?.object!=="job"||l?.status!=="failed"))try{let h=await fetch(`/v1/messages/${c}/fragment`,{headers:{Accept:"text/html"}});if(!h.ok)return;let d=await h.text(),u=this.parseHtmlElement(d),m=this.$refs.responses.querySelector(`[data-temp-id="${t}"]`);m&&u&&m.replaceWith(u)}finally{this.cleanupEventStreams()}}),this.assistantEventSource.addEventListener("error",()=>this.cleanupAssistantStream()),this.systemEventSource.addEventListener("error",()=>this.cleanupSystemStream())},init(){if(!this.$refs.responses||this.$refs.responses.children.length)return;let e=this.$el?.dataset?.threadId;if(!e)return;let t="initial",s=this.createPlaceholder(t);this.$refs.responses.prepend(s),this.startEventStreams(e,t)},async regenerate(e){if(this.pending)return;let t=e?.currentTarget,s=t?.dataset?.threadId,r=t?.dataset?.model;if(!s)return;this.pending=!0;let a=Math.random().toString(36).slice(2,10),n=this.createPlaceholder(a);this.$refs.responses.prepend(n);try{let o=this.$refs.responses.querySelector(".message[data-uuid]")?.dataset?.uuid||null,c=this.$refs?.lensSelect?.value||"",l=await fetch("/v1/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({thread_id:s,model:r,generate_assistant:!0,lens_id:c||void 0})});if(!l.ok)throw new Error(`Create message HTTP ${l.status}`);this.startEventStreams(s,a,{afterAssistantUuid:o})}catch(i){console.error("Error:",i);let o=this.$refs.responses.querySelector(`[data-temp-id="${a}"]`);o&&o.remove()}finally{this.pending=!1}}});document.addEventListener("alpine:init",()=>{Alpine.data("askButton",f),Alpine.data("responseMessage",p),Alpine.data("searchForm",g),Alpine.data("threadPage",v)});})();
