(()=>{var L=()=>({disabled:!1,label:"Ask",async ask(){let e=this.$el.closest("form")?.querySelector('[name="q"]:not([disabled])')?.value?.trim()||"";if(!(!e||this.disabled)){this.disabled=!0;try{let o=this.$el.closest("form")?.querySelector('select[name="lens_id"]')?.value?.trim()||"",l=await(await fetch("/v1/ask",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:e,lens_id:o||void 0})})).json();if(!l?.thread_id)throw new Error("Missing thread_id");let c=o?`?lens_id=${encodeURIComponent(o)}`:"";window.location.href="/v1/threads/"+l.thread_id+c}catch(t){alert("Error: "+(t?.message||String(t)))}finally{this.disabled=!1}}}});var _=()=>({uuid:null,accepted:!1,collapsed:!1,expanded:!1,editing:!1,draft:"",original:"",editable:!1,saving:!1,init(){this.uuid=this.$el.dataset.uuid,this.accepted=this.$el.classList.contains("accepted");let e=this.$refs?.sourceContent;this.editable=!!e;let t=this.$el.querySelector(".message-content");if(t&&!this.editable){let o=t.textContent?.trim()||"";t.innerHTML=this.$markdown(o)}if(!this.editable)return;let n=e.content?.textContent;this.original=(n??t?.innerText??"").trimEnd(),this.draft=this.original},startEdit(){this.editable&&(this.editing=!0,this.draft=this.original,this.$nextTick(()=>this.$refs?.editor?.focus()))},cancelEdit(){this.editable&&(this.editing=!1,this.draft=this.original)},async saveEdit(){if(!(!this.editable||this.saving)){this.saving=!0;try{let e=await fetch(`/v1/messages/${this.uuid}/revisions`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({content:this.draft})});if(!e.ok)throw new Error(`HTTP ${e.status}`);window.location.reload()}catch(e){console.error("Error:",e),this.saving=!1}}},async toggleAccepted(){try{let e=await fetch(`/v1/messages/${this.uuid}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({accepted:!this.accepted})});if(!e.ok)throw new Error(`HTTP ${e.status}`);this.accepted=!this.accepted}catch(e){console.error("Error:",e)}}});function S(e){let t=[];for(let n of e)if(n.type==="text")if(t.length>0&&t[t.length-1].type==="text"){let o=t[t.length-1];o.value+=n.value}else t.push({type:"text",value:n.value});else t.push(n);return(t.length===0||t[t.length-1].type!=="text")&&t.push({type:"text",value:""}),t}function P(e){let t=[];for(let n of e)n.type==="text"&&n.value&&t.push(n.value);return t.join("")}function M(e,t=[]){let n=[];for(let o of t)n.push({type:"lens",lensId:o.lensId,atName:o.atName});return e&&n.push({type:"text",value:e}),S(n)}function O(e,t){let n=Math.max(0,Math.min(t.tokenIndex,e.length-1)),o=e[n],s=o.type==="text"?o.value.length:0,l=Math.max(0,Math.min(t.offset,s));return{tokenIndex:n,offset:l}}function q(e,t){let{tokens:n,caret:o}=e;if(t.type==="insertText"){let{at:s,text:l}=t,c=[...n],d=c[s.tokenIndex];if(d.type!=="text")throw new Error("Cannot insert text into non-text token");let f=d.value.slice(0,s.offset),r=d.value.slice(s.offset);c[s.tokenIndex]={type:"text",value:f+l+r};let a=S(c),m={tokenIndex:s.tokenIndex,offset:s.offset+l.length},g=O(a,m),k={type:"deleteRange",from:s,to:{tokenIndex:s.tokenIndex,offset:s.offset+l.length}};return{buffer:{tokens:a,caret:g},inverse:k}}if(t.type==="deleteRange"){let{from:s,to:l}=t,c=[...n],d=[];if(s.tokenIndex===l.tokenIndex){let i=c[s.tokenIndex];if(i.type!=="text")throw new Error("Cannot delete from non-text token");let u=i.value.slice(0,s.offset),T=i.value.slice(s.offset,l.offset),y=i.value.slice(l.offset);c[s.tokenIndex]={type:"text",value:u+y};let I=S(c),v={tokenIndex:s.tokenIndex,offset:s.offset},N=O(I,v);return{buffer:{tokens:I,caret:N},inverse:{type:"insertText",at:s,text:T}}}let f=c[s.tokenIndex],r=c[l.tokenIndex];if(f.type!=="text"||r.type!=="text")throw new Error("Cross-token delete requires text tokens at boundaries");let a=f.value.slice(0,s.offset),m=f.value.slice(s.offset),g=r.value.slice(0,l.offset),k=r.value.slice(l.offset);for(let i=s.tokenIndex;i<=l.tokenIndex;i++)d.push(c[i]);d[0]={type:"text",value:m},d[d.length-1]={type:"text",value:g};let x=[];for(let i=0;i<d.length;i++){let u=d[i];if(u.type==="text")if(x.length>0&&x[x.length-1].type==="text"){let T=x[x.length-1];x[x.length-1]={type:"text",value:T.value+u.value}}else x.push(u);else x.push(u)}for(let i=l.tokenIndex;i>=s.tokenIndex;i--)c.splice(i,1);c.splice(s.tokenIndex,0,{type:"text",value:a+k});let p=S(c),w={tokenIndex:s.tokenIndex,offset:s.offset},E=O(p,w);return{buffer:{tokens:p,caret:E},inverse:{type:"insertTokens",at:s,tokens:x}}}if(t.type==="replaceToken"){let{index:s,token:l}=t,c=[...n],d=c[s];c[s]=l;let f=S(c),r=O(f,o);return{buffer:{tokens:f,caret:r},inverse:{type:"replaceToken",index:s,token:d}}}if(t.type==="insertTokens"){let{at:s,tokens:l}=t,c=[...n],d=c[s.tokenIndex];if(d.type!=="text")throw new Error("Cannot insert tokens into non-text token");let f=d.value.slice(0,s.offset),r=d.value.slice(s.offset),a=[...l];if(a.length>0){let h=a[0];h.type==="text"?a[0]={type:"text",value:f+h.value}:f&&a.unshift({type:"text",value:f});let i=a[a.length-1];i.type==="text"?a[a.length-1]={type:"text",value:i.value+r}:r&&a.push({type:"text",value:r})}else a.push({type:"text",value:f+r});c.splice(s.tokenIndex,1,...a);let m=S(c),g=l[l.length-1],k=0,x=0;if(g&&g.type!=="text"){let h=0;for(let v=0;v<s.tokenIndex;v++){let N=n[v];N.type==="text"&&(h+=N.value.length)}h+=s.offset;let i=h;for(let v of l)v.type==="text"&&(i+=v.value.length);let u=0;for(let v of l)v.type!=="text"&&u++;let T=0,y=0,I=!1;for(let v=0;v<m.length;v++){let N=m[v];if(N.type==="text"){if(!I&&T>=h&&(I=!0),i<=T+N.value.length){k=v,x=i-T;break}T+=N.value.length}else if(I&&(y++,y===u)){k=v+1,x=0;break}}}else{let h=f.length;for(let u of l)u.type==="text"&&(h+=u.value.length);let i=0;for(let u=0;u<m.length;u++){let T=m[u];if(T.type==="text"){if(h<=i+T.value.length){k=u,x=h-i;break}i+=T.value.length}}}let w=O(m,{tokenIndex:k,offset:x});return{buffer:{tokens:m,caret:w},inverse:{type:"deleteRange",from:s,to:w}}}throw new Error(`Unknown op type: ${t.type}`)}function A(e){let t=document.createElement("div");return t.textContent=e||"",t.textContent||""}function j(e,t){t.textContent="";let n=new Map,o=0;for(let s=0;s<e.length;s++){let l=e[s];if(l.type==="lens"){let c=document.createElement("span");c.setAttribute("x-data",`lensToken('${l.lensId}', '${l.atName}')`),c.setAttribute("x-on:click","removeLens()"),c.setAttribute("data-token","lens"),t.appendChild(c),n.set(s,{node:c,textStart:o,textEnd:o})}else if(l.type==="text"){let c=document.createTextNode(A(l.value));t.appendChild(c),n.set(s,{node:c,textStart:o,textEnd:o+l.value.length}),o+=l.value.length}}return n}function H(e,t,n){let o=t.get(e.tokenIndex);if(!o)return null;if(o.node.nodeType===Node.TEXT_NODE)return{node:o.node,offset:e.offset};if(e.offset===0)return{node:n,offset:Array.from(n.childNodes).indexOf(o.node)};let s=e.tokenIndex+1,l=t.get(s);return l?{node:n,offset:Array.from(n.childNodes).indexOf(l.node)}:{node:n,offset:n.childNodes.length}}function C(e,t,n,o){for(let[s,l]of n.entries())if(l.node===e)return e.nodeType===Node.TEXT_NODE?{tokenIndex:s,offset:Math.min(t,l.textEnd-l.textStart)}:{tokenIndex:s,offset:0};if(e===o){let s=Array.from(o.childNodes);if(t>=s.length){let c=n.size-1,d=n.get(c);return d&&d.node.nodeType===Node.TEXT_NODE?{tokenIndex:c,offset:d.textEnd-d.textStart}:{tokenIndex:c,offset:0}}let l=s[t];for(let[c,d]of n.entries())if(d.node===l)return{tokenIndex:c,offset:0}}return{tokenIndex:n.size-1,offset:0}}var X=/(?:^|[^A-Za-z0-9-])@([A-Za-z0-9-]*)/g;function D(e,t){let n="",o=[],s=0,l=-1;for(let g=0;g<e.length;g++){let k=e[g];if(k.type==="text"){let x=n.length;n+=k.value,o.push({tokenIndex:g,startChar:x,endChar:n.length}),g<t.tokenIndex?s+=k.value.length:g===t.tokenIndex&&(s+=t.offset,l=o.length-1)}else o.push({tokenIndex:g,startChar:n.length,endChar:n.length}),g<t.tokenIndex&&(l=o.length-1)}if(l===-1||n.length===0)return null;let c=n.slice(0,s),d=Array.from(c.matchAll(X));if(d.length===0)return null;let f=d[d.length-1],r=f[0].startsWith("@")?0:1,a=f.index+r,m=a+f[0].length-r;if(m!==s)return null;for(let g of o)if(a>=g.startChar&&a<g.endChar)return m>g.endChar?null:{tokenIndex:g.tokenIndex,startOffset:a-g.startChar,endOffset:m-g.startChar,query:f[1].toLowerCase(),raw:f[0].slice(r)};return null}function B(e){let t=e,n={tokens:M(""),caret:{tokenIndex:0,offset:0}},o=null,s=!1,l=()=>{if(!t||!o||document.activeElement!==t)return;let r=H(n.caret,o,t);if(!r)return;let a=window.getSelection();if(!a)return;let m=document.createRange();m.setStart(r.node,r.offset),m.collapse(!0),a.removeAllRanges(),a.addRange(m)},c=()=>{if(!t||!o)return;let r=window.getSelection();if(!r||!r.rangeCount)return;let a=r.getRangeAt(0);n.caret=C(a.startContainer,a.startOffset,o,t)},d=()=>{if(!t)return;let r=[],a=new Map,m=0,g=0,k=!1;for(let h of t.childNodes){if(h.nodeType===Node.ELEMENT_NODE&&h.dataset?.token==="lens"){r.push({type:"lens",lensId:h.dataset.lensId,atName:h.dataset.atName}),a.set(g++,{node:h,textStart:m,textEnd:m});continue}if(h.nodeType===Node.TEXT_NODE){let i=h.textContent||"";r.push({type:"text",value:i}),a.set(g++,{node:h,textStart:m,textEnd:m+i.length}),m+=i.length;continue}h.nodeType===Node.ELEMENT_NODE&&h.tagName==="BR"&&(k=!0)}let x=r.some((h,i)=>h.type==="text"&&i>0&&r[i-1].type==="text"),p=r.length>0&&r[r.length-1].type==="lens";(x||p||k)&&(k=!0);let w=n.caret,E=window.getSelection();if(E&&E.rangeCount){let h=E.getRangeAt(0);w=C(h.startContainer,h.startOffset,a,t)}if(k){let h=S(r);w=O(h,w),n={tokens:h,caret:w},f()}else{let h=S(r);w=O(h,w),n={tokens:h,caret:w},o=a}},f=()=>{if(!(!t||s)){s=!0;try{o=j(n.tokens,t),l(),window.Alpine&&window.Alpine.initTree(t)}finally{s=!1}}};return{getBuffer(){return n},setBuffer(r){n=r,f()},loadFromQuery(r,a){let m=[];a?.lensId&&a?.atName&&m.push({lensId:a.lensId,atName:a.atName});let g=M(r,m),k=g.length-1,x=g[k];n={tokens:g,caret:{tokenIndex:k,offset:x?.type==="text"?x.value.length:0}},f()},syncFromDOM(){d()},syncBufferOnly(){if(!t)return;let r=[],a=new Map,m=0,g=0;for(let h of t.childNodes)if(h.nodeType===Node.ELEMENT_NODE&&h.dataset?.token==="lens")r.push({type:"lens",lensId:h.dataset.lensId,atName:h.dataset.atName}),a.set(g++,{node:h,textStart:m,textEnd:m});else if(h.nodeType===Node.TEXT_NODE){let i=h.textContent||"";r.push({type:"text",value:i}),a.set(g++,{node:h,textStart:m,textEnd:m+i.length}),m+=i.length}r.length===0&&(r.push({type:"text",value:""}),a.set(0,{node:null,textStart:0,textEnd:0}));let k=window.getSelection(),x={tokenIndex:0,offset:0};if(k&&k.rangeCount){let h=k.getRangeAt(0);x=C(h.startContainer,h.startOffset,a,t)}let p=r.length-1;x.tokenIndex=Math.max(0,Math.min(x.tokenIndex,p));let w=r[x.tokenIndex],E=w?.type==="text"?w.value.length:0;x.offset=Math.max(0,Math.min(x.offset,E)),n={tokens:r,caret:x},o=a},serialize(){return P(n.tokens)},detectMention(){return D(n.tokens,n.caret)},insertLensToken(r,a,m){if(!t)return;let g=window.getSelection();if(!g||!g.rangeCount)return;let k=o.get(r.tokenIndex);if(!k||!k.node)return;let x=k.node,p=x.textContent||"",w=p.slice(0,r.startOffset),E=p.slice(r.endOffset),h=document.createElement("span");h.setAttribute("x-data",`lensToken('${a}', '${m}')`),h.setAttribute("x-on:click","removeLens()"),h.setAttribute("data-token","lens");let i=x.parentNode;if(!i)return;if(w){let y=document.createTextNode(w);i.insertBefore(y,x)}if(i.insertBefore(h,x),E){let y=document.createTextNode(E);i.insertBefore(y,x)}else{let y=document.createTextNode(" ");i.insertBefore(y,x)}i.removeChild(x),window.Alpine&&window.Alpine.initTree(h);let u=document.createRange(),T=h.nextSibling;T&&T.nodeType===Node.TEXT_NODE&&(u.setStart(T,0),u.collapse(!0),g.removeAllRanges(),g.addRange(u)),this.syncBufferOnly()},applyOperation(r){c();let a=q(n,r);return n=a.buffer,f(),a.inverse},removeLens(r){if(!t)return;let a=t.querySelector(`[data-token="lens"][data-lens-id="${r}"]`);!a||!a.parentNode||(a.parentNode.removeChild(a),this.syncBufferOnly())},placeCaretAtEnd(){if(!t)return;let r=window.getSelection();if(!r)return;let a=t.lastChild;if(!a)return;let m=document.createRange();a.nodeType===Node.TEXT_NODE?m.setStart(a,a.textContent?.length||0):m.setStartAfter(a),m.collapse(!0),r.removeAllRanges(),r.addRange(m),this.syncBufferOnly()},onInput(r){t&&t.addEventListener("input",()=>{c(),r()})},destroy(){o=null}}}var z=()=>({queryValue:"",settingsOpen:!1,submitting:!1,mentionOpen:!1,mentionIndex:0,mentionQuery:"",mentionOptions:[],lensOptions:[],idToAtName:{},errorMessage:"",controller:null,showError(e){this.errorMessage=e,setTimeout(()=>this.errorMessage="",5e3)},init(){let e=this.$store.search.query||"",t=this.$store.search.lens_map||{};this.queryValue=e.replace(/^@\S+\s*/,""),this.buildLensState(t),this.controller=B(this.$refs?.editor),this.$watch("queryValue",n=>{this.$store.search.query=n}),this.$watch("$store.search.lens_id",(n,o)=>{let s=this.$refs?.lensSelect;s&&(s.value=n),o!==void 0&&this.controller.removeLens(o),this.syncFromStore(),o!==void 0&&this.controller&&document.activeElement===this.$refs?.editor&&this.controller.placeCaretAtEnd()}),this.$nextTick(()=>{this.syncFromStore(),e||this.$refs?.editor?.focus()})},syncFromStore(){if(!this.controller)return;this.controller.loadFromQuery(this.queryValue,this.getSelectedLens());let e=this.$refs?.textarea;e&&(e.value=this.queryValue)},syncToStore(){if(!this.controller)throw new Error("Buffer controller not initialized");this.controller.syncBufferOnly();let e=this.controller.serialize();if(e!==this.queryValue){this.queryValue=e;let t=this.$refs?.textarea;t&&(t.value=e)}this.updateMentionState()},updateMentionState(){if(!this.controller)return;let e=this.controller.detectMention();if(!e){this.mentionOpen=!1,this.mentionQuery="",this.mentionOptions=this.lensOptions,this.mentionIndex=0;return}let t=e.query,n=this.lensOptions.filter(s=>s.atName.startsWith(t)),o=this.mentionOpen&&this.mentionQuery===t;this.mentionOpen=n.length>0,this.mentionQuery=t,this.mentionOptions=n,this.mentionIndex=o?Math.min(this.mentionIndex,Math.max(n.length-1,0)):0},buildLensState(e){let t=Object.entries(e).map(([o,s])=>({lensId:s,atName:o.toLowerCase()})).filter(o=>o.atName),n=Object.fromEntries(Object.entries(e).map(([o,s])=>[s,o]));this.lensOptions=t,this.mentionOptions=t,this.idToAtName=n},getSelectedLens(){let e=this.$store.search.lens_id||"";if(!e)return null;let t=this.idToAtName[e]||"";return{lensId:e,atName:t}},selectMention(){if(!this.controller||!this.mentionOpen||!this.mentionOptions.length)return;let e=this.controller.detectMention();if(!e)return;let t=this.mentionOptions[this.mentionIndex];t&&(this.controller.insertLensToken(e,t.lensId,t.atName),this.$store.search.lens_id=t.lensId,this.queryValue=this.controller.serialize(),this.mentionOpen=!1,this.mentionQuery="",this.mentionOptions=this.lensOptions,this.mentionIndex=0)},handleEditorKeydown(e){if(!this.mentionOpen){e.key==="Enter"&&(e.preventDefault(),this.submit());return}if(e.key==="ArrowDown"){e.preventDefault();let t=Math.max(this.mentionOptions.length-1,0);this.mentionIndex=Math.min(this.mentionIndex+1,t);return}if(e.key==="ArrowUp"){e.preventDefault(),this.mentionIndex=Math.max(this.mentionIndex-1,0);return}if(e.key==="Enter"||e.key===" "){e.preventDefault(),this.selectMention();return}e.key==="Escape"&&(e.preventDefault(),this.mentionOpen=!1,this.mentionQuery="",this.mentionOptions=this.lensOptions,this.mentionIndex=0)},async submit(){if(this.submitting)return;let e=this.$refs?.form;if(!e)throw new Error("Form ref not found");this.submitting=!0;try{let n=this.$refs?.lensSelect?.value?.trim()||this.$store.search.lens_id||"",o=this.queryValue.trim(),s=Number(this.$store.search.limit);if(!s||s<1)throw new Error("Invalid search limit");let l={q:o,exact:!!this.$store.search.exact,limit:s,lens_id:n||void 0},c=await fetch("/v1/search/fragment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});if(!c.ok)throw new Error(`Search failed (HTTP ${c.status})`);let d=await c.text(),f=document.querySelector("#search-root");if(!f)throw new Error("Page missing #search-root element");f.outerHTML=d;let r=new URLSearchParams;l.q&&r.set("q",l.q),l.exact&&r.set("exact","true"),l.limit&&r.set("limit",String(l.limit)),l.lens_id&&r.set("lens_id",l.lens_id);let a=r.toString()?`${e.action}?${r.toString()}`:e.action;window.history.replaceState({},"",a)}catch(t){let n=t instanceof Error?t.message:String(t);this.showError(`Search failed: ${n}`)}finally{this.submitting=!1}}});var U=(e,t)=>({lensId:e,rawAtName:t,init(){if(!this.lensId||!this.rawAtName)throw new Error("lensId and rawAtName are required");this.render()},render(){let n=this.$el,o=A(this.rawAtName.toLowerCase());n.className="query-token",n.dataset.token="lens",n.dataset.lensId=this.lensId,n.dataset.atName=o,n.textContent=`@${o}`,n.setAttribute("contenteditable","false"),n.style.cursor="pointer"},removeLens(){this.$store.search.clearLens()}});var F=()=>({pending:!1,assistantEventSource:null,jobPollTimeout:null,jobPollAttempt:0,createPlaceholder(e){let t=this.$refs.placeholderTemplate.content.cloneNode(!0),n=t.querySelector(".message");return n.dataset.tempId=e,t},parseHtmlElement(e){let t=document.createElement("template");return t.innerHTML=String(e).trim(),t.content.firstElementChild},cleanupAssistantStream(){this.assistantEventSource&&this.assistantEventSource.close(),this.assistantEventSource=null},cleanupJobPoll(){this.jobPollTimeout&&clearTimeout(this.jobPollTimeout),this.jobPollTimeout=null,this.jobPollAttempt=0},async pollJobStatus(e,t){try{let n=await fetch(`/v1/threads/${e}/activity`,{headers:{Accept:"application/json"}});if(!n.ok)return;if((await n.json())?.job_events?.[0]?.status==="failed"){let c=this.$refs.responses.querySelector(`[data-temp-id="${t}"]`);c&&c.remove(),this.cleanupJobPoll();return}this.jobPollAttempt+=1;let l=Math.min(1e3*Math.pow(2,this.jobPollAttempt),3e4);this.jobPollTimeout=setTimeout(()=>this.pollJobStatus(e,t),l)}catch(n){console.error("Error polling job status:",n),this.jobPollAttempt+=1;let o=Math.min(1e3*Math.pow(2,this.jobPollAttempt),3e4);this.jobPollTimeout=setTimeout(()=>this.pollJobStatus(e,t),o)}},startEventStreams(e,t,{afterAssistantUuid:n=null}={}){if(this.assistantEventSource)return;let o=new URL(`/v1/threads/${e}/stream`,window.location.origin);o.searchParams.set("role","assistant"),n&&o.searchParams.set("after_uuid",n),this.assistantEventSource=new EventSource(o),this.assistantEventSource.addEventListener("assistant",async s=>{try{let c=JSON.parse(s?.data||"{}")?.uuid;if(!c)return;let d=await fetch(`/v1/messages/${c}/fragment`,{headers:{Accept:"text/html"}});if(!d.ok)return;let f=await d.text(),r=this.parseHtmlElement(f),a=this.$refs.responses.querySelector(`[data-temp-id="${t}"]`);a&&r&&a.replaceWith(r),this.cleanupJobPoll()}finally{this.cleanupAssistantStream()}}),this.assistantEventSource.addEventListener("error",()=>this.cleanupAssistantStream()),this.jobPollAttempt=0,this.pollJobStatus(e,t)},init(){if(!this.$refs.responses||this.$refs.responses.children.length)return;let e=this.$el?.dataset?.threadId;if(!e)return;let t="initial",n=this.createPlaceholder(t);this.$refs.responses.prepend(n),this.startEventStreams(e,t)},async regenerate(e){if(this.pending)return;let t=e?.currentTarget,n=t?.dataset?.threadId,o=t?.dataset?.model,s=t?.dataset?.promptContent;if(!n||!s)return;this.pending=!0;let l=Math.random().toString(36).slice(2,10),c=this.createPlaceholder(l);this.$refs.responses.prepend(c);try{let f=this.$refs.responses.querySelector(".message[data-uuid]")?.dataset?.uuid||null,r=await fetch("/v1/ask",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:s,thread_id:n,lens_id:this.$refs?.lensSelect?.value||void 0,model:o})});if(!r.ok)throw new Error(`Ask HTTP ${r.status}`);this.startEventStreams(n,l,{afterAssistantUuid:f})}catch(d){console.error("Error:",d);let f=this.$refs.responses.querySelector(`[data-temp-id="${l}"]`);f&&f.remove()}finally{this.pending=!1}}});function V(e,t){if(typeof e!="string")throw new TypeError("highlightCode expects a string");let n=Q(e,t),o=[],s=[],l=[],c=[],d=[],f=i=>{if(!Number.isInteger(i)||i<0)throw new TypeError("encodeIndex expects a non-negative integer");let u="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",T=u.length,y=i,I="";do I=u[y%T]+I,y=Math.floor(y/T);while(y>0);return I},r=i=>`HLSTR${f(i)}`,a=i=>`HLCMT${f(i)}`,m=i=>`HLKW${f(i)}`,g=i=>`HLBI${f(i)}`,k=i=>`HLNUM${f(i)}`,x=i=>{let u="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",T=u.length,y=0;for(let I of String(i)){let v=u.indexOf(I);if(v===-1)throw new Error("Invalid placeholder encoding");y=y*T+v}return y},p=e;n==="python"?(p=p.replace(/#[^\n]*/g,i=>{let u=s.length;return s.push(i),a(u)}),p=p.replace(/'''[\s\S]*?'''|"""[\s\S]*?"""/g,i=>{let u=o.length;return o.push(i),r(u)}),p=p.replace(/'([^'\\]|\\.)*?'|"([^"\\]|\\.)*?"/g,i=>{let u=o.length;return o.push(i),r(u)})):n==="sql"?(p=p.replace(/--[^\n]*/g,i=>{let u=s.length;return s.push(i),a(u)}),p=p.replace(/'([^'\\]|\\.)*?'/g,i=>{let u=o.length;return o.push(i),r(u)})):(p=p.replace(/\/\/[^\n]*/g,i=>{let u=s.length;return s.push(i),a(u)}),p=p.replace(/\/\*[\s\S]*?\*\//g,i=>{let u=s.length;return s.push(i),a(u)}),p=p.replace(/'([^'\\]|\\.)*?'|"([^"\\]|\\.)*?"|`([^`\\]|\\.)*?`/g,i=>{let u=o.length;return o.push(i),r(u)})),p=R(p);let w=i=>i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),E=K(n);if(E.length>0){let i=n==="sql"?"gi":"g",u=new RegExp(`\\b(${E.map(w).join("|")})\\b`,i);p=p.replace(u,T=>{let y=l.length;return l.push(T),m(y)})}let h=W(n);if(h.length>0){let i=n==="sql"?"gi":"g",u=new RegExp(`\\b(${h.map(w).join("|")})\\b`,i);p=p.replace(u,T=>{let y=c.length;return c.push(T),g(y)})}return p=p.replace(/\b\d+(\.\d+)?\b/g,i=>{let u=d.length;return d.push(i),k(u)}),p=p.replace(/\u0001HLSTR([A-Za-z]+)\u0001/g,(i,u)=>{let T=x(u),y=o[T];if(y===void 0)throw new Error("Invalid string placeholder index");return`<span class="hl-str">${R(y)}</span>`}),p=p.replace(/\u0001HLCMT([A-Za-z]+)\u0001/g,(i,u)=>{let T=x(u),y=s[T];if(y===void 0)throw new Error("Invalid comment placeholder index");return`<span class="hl-cmt">${R(y)}</span>`}),p=p.replace(/\u0001HLNUM([A-Za-z]+)\u0001/g,(i,u)=>{let T=x(u),y=d[T];if(y===void 0)throw new Error("Invalid number placeholder index");return`<span class="hl-num">${y}</span>`}),p=p.replace(/\u0001HLBI([A-Za-z]+)\u0001/g,(i,u)=>{let T=x(u),y=c[T];if(y===void 0)throw new Error("Invalid builtin placeholder index");return`<span class="hl-bi">${y}</span>`}),p=p.replace(/\u0001HLKW([A-Za-z]+)\u0001/g,(i,u)=>{let T=x(u),y=l[T];if(y===void 0)throw new Error("Invalid keyword placeholder index");return`<span class="hl-kw">${y}</span>`}),p}function R(e){if(typeof e!="string")throw new TypeError("escapeHtml expects a string");return e.replace(/[&<>"']/g,t=>t==="&"?"&amp;":t==="<"?"&lt;":t===">"?"&gt;":t==='"'?"&quot;":"&apos;")}function Q(e,t){if(t){let n=t.toLowerCase();return n==="js"||n==="javascript"||n==="typescript"||n==="ts"?"javascript":n==="py"||n==="python"?"python":n==="sql"||n==="postgres"||n==="postgresql"||n==="mysql"?"sql":n==="go"||n==="golang"?"go":n==="rs"||n==="rust"?"rust":n==="sh"||n==="bash"||n==="shell"?"shell":n}return/\b(def|class)\s+\w+[\(:]/.test(e)?"python":/\b(const|let|var|function)\s+\w+/.test(e)?"javascript":/^\s*(SELECT|INSERT|UPDATE|DELETE|CREATE|ALTER|DROP)\b/mi.test(e)?"sql":/\bfn\s+\w+\(/.test(e)?"rust":/\bfunc\s+\w+\(/.test(e)?"go":"generic"}function K(e){let t={python:["def","class","if","else","elif","for","while","return","import","from","as","try","except","finally","with","lambda","yield","async","await","raise","pass","break","continue","in","is","not","and","or"],javascript:["function","const","let","var","if","else","for","while","return","import","export","default","class","extends","async","await","yield","typeof","new","delete","this","super","static","try","catch","finally","throw","break","continue","switch","case"],sql:["SELECT","FROM","WHERE","JOIN","INNER","LEFT","RIGHT","OUTER","ON","INSERT","INTO","VALUES","UPDATE","SET","DELETE","CREATE","TABLE","ALTER","DROP","INDEX","ORDER","BY","GROUP","HAVING","LIMIT","OFFSET","AS","AND","OR","NOT","IN","LIKE","BETWEEN"],go:["func","package","import","var","const","type","struct","interface","if","else","for","range","return","defer","go","chan","select","case","switch","break","continue"],rust:["fn","let","mut","const","static","struct","enum","impl","trait","type","if","else","match","for","while","loop","return","break","continue","use","mod","pub","crate"],shell:["if","then","else","elif","fi","for","while","do","done","case","esac","function","return","exit","export","source"],generic:[]};return t[e]||t.generic}function W(e){let t={python:["True","False","None","self","str","int","float","bool","list","dict","tuple","set","len","range","print","open","type","isinstance","super","__init__","__name__"],javascript:["true","false","null","undefined","NaN","Infinity","console","window","document","Array","Object","String","Number","Boolean","Math","Date","Promise","JSON"],sql:["NULL","TRUE","FALSE","COUNT","SUM","AVG","MIN","MAX","DISTINCT","EXISTS"],go:["true","false","nil","make","new","len","cap","append","copy","delete","panic","recover"],rust:["true","false","None","Some","Ok","Err","Vec","String","Option","Result","println","panic"],shell:["echo","cd","ls","pwd","cat","grep","sed","awk","find","chmod","chown"],generic:["true","false","null","undefined"]};return t[e]||t.generic}function b(e){if(typeof e!="string")throw new TypeError("escapeHtml expects a string");return e.replace(/[&<>"']/g,t=>t==="&"?"&amp;":t==="<"?"&lt;":t===">"?"&gt;":t==='"'?"&quot;":"&#39;")}function $(e){if(typeof e!="string")throw new TypeError("parseInline expects a string");let t=[],n=[],o=[],s=d=>`ROSECODE${d}`,l=d=>`ROSELINK${d}`,c=d=>`ROSEAUTOLINK${d}`;return e=e.replace(/`([^`]*?)`/g,(d,f)=>{let r=t.length;return t.push(b(f)),s(r)}),e=e.replace(/\[([^\]]+)\]\(([^)]+)\)/g,(d,f,r)=>{let a=r.trim();if(!(/^(https?|mailto|tel):/i.test(a)||/^[/.#]/.test(a)))return f;let g=n.length,k=b(f),x=b(a);return n.push(`<a href="${x}" target="_blank" rel="noopener noreferrer">${k}</a>`),l(g)}),e=e.replace(/\bhttps?:\/\/[^\s<>"']+/g,d=>{let f=d,r="";for(;/[),.;:!?\\\]]$/.test(f);)r=f.slice(-1)+r,f=f.slice(0,-1);if(!f)return b(d);let a=o.length,m=b(f);return o.push(`<a href="${m}" target="_blank" rel="noopener noreferrer">${m}</a>${b(r)}`),c(a)}),e=b(e),e=e.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),e=e.replace(/__([^_]+)__/g,"<strong>$1</strong>"),e=e.replace(/\*([^*]+)\*/g,"<em>$1</em>"),e=e.replace(/_([^_]+)_/g,"<em>$1</em>"),e=e.replace(/\u0001ROSELINK(\d+)\u0001/g,(d,f)=>{let r=n[Number(f)];if(r===void 0)throw new Error("Invalid link placeholder index");return r}),e=e.replace(/\u0001ROSEAUTOLINK(\d+)\u0001/g,(d,f)=>{let r=o[Number(f)];if(r===void 0)throw new Error("Invalid auto-link placeholder index");return r}),e=e.replace(/\u0001ROSECODE(\d+)\u0001/g,(d,f)=>{let r=t[Number(f)];if(r===void 0)throw new Error("Invalid code placeholder index");return`<code>${r}</code>`}),e}function J(e){if(typeof e!="string")throw new TypeError("markdownToHtml expects a string");let t=1e5;if(e.length>t){let w=e.slice(0,t),E=`<div class="markdown-error">Content exceeds ${t} characters, showing truncated...`;return E+=`</div><pre>${b(w)}</pre>`,E}e=e.replace(/\r\n?/g,`
`);let n=e.split(`
`),o="",s=!1,l=!1,c=!1,d=!1,f=[],r=[],a="",m=[];function g(){f.length>0&&(o+=`<p>${$(f.join(" "))}</p>
`,f=[])}function k(){c&&(o+=`<blockquote>${r.join(`<br />
`)}</blockquote>
`,r=[],c=!1)}function x(){if(!d)return;let w=m.join(`
`),E=a?` class="language-${b(a)}"`:"",h=V(w,a);o+=`<pre><code${E}>${h}</code></pre>
`,a="",m=[],d=!1}function p(){s&&(o+=`</ul>
`,s=!1),l&&(o+=`</ol>
`,l=!1)}for(let w=0;w<n.length;w++){let E=n[w],h=E.match(/^```([^\s`]+)?\s*$/);if(h){g(),p(),k(),d?x():(d=!0,a=(h[1]||"").trim(),m=[]);continue}if(d){m.push(E);continue}if(!E.trim()){g(),p(),k();continue}if(/^(\-\-\-|\*\*\*|___)\s*$/.test(E.trim())){g(),p(),k(),o+=`<hr />
`;continue}if(/^\s*>\s?/.test(E)){g(),p(),c||(c=!0);let y=E.replace(/^\s*>\s?/,"");r.push($(y));continue}let i=E.match(/^(#{1,6})\s+(.*)$/);if(i){g(),p(),k();let y=i[1].length,I=i[2].trim();o+=`<h${y}>${$(I)}</h${y}>
`;continue}let u=E.match(/^\s*(\d+)\.\s+(.*)$/);if(u){g(),k(),s&&(o+=`</ul>
`,s=!1),l||(o+=`<ol>
`,l=!0),o+=`<li>${$(u[2])}</li>
`;continue}let T=E.match(/^\s*[-*+]\s+(.*)$/);if(T){g(),k(),l&&(o+=`</ol>
`,l=!1),s||(o+=`<ul>
`,s=!0),o+=`<li>${$(T[1])}</li>
`;continue}k(),p(),f.push(E)}return x(),g(),p(),k(),o.trim()}document.addEventListener("alpine:init",()=>{if(!window.TRANSPORT?.search)throw new Error("TRANSPORT.search not found");Alpine.store("search",{...window.TRANSPORT.search,clearLens(){this.lens_id=""}}),Alpine.magic("markdown",()=>J),Alpine.data("askButton",L),Alpine.data("responseMessage",_),Alpine.data("searchForm",z),Alpine.data("lensToken",U),Alpine.data("threadMessagesPage",F)});})();
