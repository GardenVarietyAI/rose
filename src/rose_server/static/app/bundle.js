(()=>{var v=()=>({disabled:!1,label:"Ask",async ask(){let e=this.$el.closest("form")?.querySelector('[name="q"]:not([disabled])')?.value?.trim()||"";if(!(!e||this.disabled)){this.disabled=!0;try{let n=this.$el.closest("form")?.querySelector('select[name="lens_id"]')?.value?.trim()||"",i=await(await fetch("/v1/threads",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:[{role:"user",content:e}],lens_id:n||void 0})})).json();if(!i?.thread_id)throw new Error("Missing thread_id");let o=n?`?lens_id=${encodeURIComponent(n)}`:"";window.location.href="/v1/threads/"+i.thread_id+o}catch(t){alert("Error: "+(t?.message||String(t)))}finally{this.disabled=!1}}}});var x=()=>({uuid:null,accepted:!1,collapsed:!1,expanded:!1,editing:!1,draft:"",original:"",editable:!1,saving:!1,init(){this.uuid=this.$el.dataset.uuid,this.accepted=this.$el.classList.contains("accepted");let e=this.$refs?.sourceContent;if(this.editable=!!e,!this.editable)return;let t=e.content?.textContent;this.original=(t??this.$el.querySelector(".message-content")?.innerText??"").trimEnd(),this.draft=this.original},startEdit(){this.editable&&(this.editing=!0,this.draft=this.original,this.$nextTick(()=>this.$refs?.editor?.focus()))},cancelEdit(){this.editable&&(this.editing=!1,this.draft=this.original)},async saveEdit(){if(!(!this.editable||this.saving)){this.saving=!0;try{let e=await fetch(`/v1/messages/${this.uuid}/revisions`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({content:this.draft})});if(!e.ok)throw new Error(`HTTP ${e.status}`);window.location.reload()}catch(e){console.error("Error:",e),this.saving=!1}}},async toggleAccepted(){try{let e=await fetch(`/v1/messages/${this.uuid}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({accepted:!this.accepted})});if(!e.ok)throw new Error(`HTTP ${e.status}`);this.accepted=!this.accepted}catch(e){console.error("Error:",e)}}});function p(e){if(!e)return;e.focus();let t=window.getSelection();if(!t)return;let s=document.createRange();s.selectNodeContents(e),s.collapse(!1),t.removeAllRanges(),t.addRange(s)}var C=/[.,!?;:)]/;function $(e){return e===" "||C.test(e)}var M=/\u200B/g,b=/\u00A0/g,L=/\s+/g;function f(e){return(e||"").replace(M,"").replace(b," ").replace(L," ").trim()}function E(e){let t=document.createElement("div");return t.textContent=e||"",t.textContent||""}var u={TEXT:"text",MENTION:"mention",HASHTAG:"hashtag",COMMAND:"command"},N={"@":u.MENTION,"#":u.HASHTAG,"/":u.COMMAND},_=/[A-Za-z0-9-]/,k=/^[@#/]([A-Za-z0-9-]*)/;function g(e){if(!e)return[];let t=[],s=0;for(;s<e.length;){let n=e.slice(s),r=n[0];if((s===0||!_.test(e[s-1]))&&N[r]){let a=n.match(k);if(a){let c=a[0],h=a[1],d=N[r];t.push({type:d,value:h,raw:c}),s+=c.length;continue}}let o=n.match(/^[^@#/]+/);if(o){let a=o[0];t.push({type:u.TEXT,value:a,raw:a}),s+=a.length}else t.push({type:u.TEXT,value:r,raw:r}),s+=1}return t}function y(e){return e.map(t=>t.raw).join("")}function S(e,t){for(let s=e.length-1;s>=0;s--)if(e[s].type===t)return{token:e[s],index:s};return null}function T(e,t){return e.filter((s,n)=>n!==t)}var q=/[.*+?^${}()|[\]\\]/g,O=()=>({queryValue:"",settingsOpen:!1,submitting:!1,mentionOpen:!1,mentionIndex:0,mentionQuery:"",mentionOptions:[],lensOptions:[],resolveOnNextInput:!1,idToAtName:{},errorMessage:"",showError(e){this.errorMessage=e,setTimeout(()=>this.errorMessage="",5e3)},init(){let e=this.getLensMap(),t=this.$store.search.query||"",s=this.$store.search.lens_id||"",n=Object.entries(e).find(([,i])=>i===s)?.[0]||"",r=n?this.stripAtNameFromQuery(t,n):t;this.queryValue=r,this.buildLensState(e),this.$watch("queryValue",i=>{this.$store.search.query=i}),this.$watch("$store.search.lens_id",i=>{let o=this.$refs?.lensSelect;o&&(o.value=i),this.syncEditor({force:!0});let a=this.$refs?.editor;a&&document.activeElement===a&&p(a)}),this.$nextTick(()=>{this.syncEditor({force:!0}),t||this.$refs?.editor?.focus()})},syncEditor({force:e=!1}={}){let t=this.$refs?.editor;t&&(e||document.activeElement!==t)&&this.renderEditor({editor:t});let s=this.$refs?.textarea;s&&(s.value=this.queryValue)},syncFromEditor(){let e=this.$refs?.editor;if(!e)throw new Error("Editor ref not found");let t=this.serializeEditor(e);if(t!==this.queryValue){this.queryValue=t;let n=this.$refs?.textarea;n&&(n.value=t)}let s=this.getMentionText({editor:e});this.updateMentionState({text:s}),this.resolveOnNextInput&&(this.resolveOnNextInput=!1,this.resolveCompletedMention())},serializeEditor(e){let t=[];for(let s of e.childNodes)if(s.nodeType===Node.TEXT_NODE){let n=f(s.textContent);n&&t.push(n)}else if(s.nodeType===Node.ELEMENT_NODE&&s.dataset?.token!=="lens"){let n=f(s.textContent);n&&t.push(n)}return t.join(" ")},buildSubmitQuery(){let t=this.getSelectedLens()?.atName?.toLowerCase()||"",s=this.queryValue.trim();return t?s?`@${t} ${s}`:`@${t}`:s},getLensMap(){return this.$store.search.lens_map||{}},buildLensState(e){let t=Object.entries(e).map(([n,r])=>({lensId:r,atName:n.toLowerCase()})).filter(n=>n.atName),s=Object.fromEntries(Object.entries(e).map(([n,r])=>[r,n]));this.lensOptions=t,this.mentionOptions=t,this.idToAtName=s},getSelectedLens(){let e=this.$store.search.lens_id||"";if(!e)return null;let t=this.idToAtName[e]||"";return{lensId:e,atName:t}},setSelectedLensId(e){this.$store.search.lens_id=e;let t=this.$refs?.lensSelect;t&&(t.value=e)},stripAtNameFromQuery(e,t){if(!e||!t)return e;let s=t.replace(q,"\\$&");return f(e.replace(new RegExp(`@${s}`,"gi"),""))},renderEditor({editor:e}={}){if(!e)return;let t=this.getSelectedLens(),s=t?.lensId||"",n=t?.atName||"",r=document.createDocumentFragment();if(s&&n){let i=document.createElement("span");i.setAttribute("x-data",`lensToken('${s}', '${n}')`),i.setAttribute("x-on:click","removeLens()"),r.appendChild(i),r.appendChild(document.createTextNode(" "))}r.appendChild(document.createTextNode(E(this.queryValue))),e.textContent="",e.appendChild(r)},getMentionText({editor:e}={}){if(!e)return this.queryValue;let t=window.getSelection(),s=e.textContent||"";if(t&&t.rangeCount){let o=t.getRangeAt(0).cloneRange();o.selectNodeContents(e),o.setEnd(t.focusNode,t.focusOffset),s=o.toString()}let n=this.getSelectedLens(),r=n?.atName?n.atName.toLowerCase():"";if(!r)return s;let i=`@${r} `;return s.startsWith(i)?s.slice(i.length):s},resetMentionState(){this.mentionOpen=!1,this.mentionQuery="",this.mentionIndex=0,this.mentionOptions=this.lensOptions},updateMentionState({text:e}={}){let s=g(e||"");if(s.length===0){this.resetMentionState();return}let n=s[s.length-1];if(n.type!==u.MENTION){this.resetMentionState();return}let r=n.value.toLowerCase(),i=this.lensOptions.filter(o=>o.atName.startsWith(r));this.mentionOpen=i.length>0,this.mentionQuery=r,this.mentionOptions=i,this.mentionIndex=0},resolveCompletedMention({lensMap:e}={}){let t=e||this.getLensMap(),s=g(this.queryValue),n=S(s,u.MENTION);if(!n)return;let r=t[n.token.value.toLowerCase()];if(!r)return;this.setSelectedLensId(r),this.queryValue=y(T(s,n.index)).trim(),this.mentionOpen=!1,this.mentionQuery="",this.syncEditor({force:!0});let i=this.$refs?.editor;i&&p(i)},selectMention(e){if(!e)return;let t=this.$refs?.editor;if(!t)return;let s=this.getMentionText({editor:t}),n=f(s),r=g(n),i=S(r,u.MENTION),o=r;i&&i.token.value.toLowerCase()===this.mentionQuery.toLowerCase()&&(o=T(r,i.index));let a=y(o).trim();this.setSelectedLensId(e.lensId),this.queryValue=a?`${a} `:"",this.mentionOpen=!1,this.mentionQuery="",this.syncEditor({force:!0}),p(t)},handleEditorKeydown(e){if(!this.mentionOpen){$(e.key)&&(this.resolveOnNextInput=!0),e.key==="Enter"&&(e.preventDefault(),this.submit());return}let t={ArrowDown:()=>this.mentionIndex=Math.min(this.mentionIndex+1,this.mentionOptions.length-1),ArrowUp:()=>this.mentionIndex=Math.max(this.mentionIndex-1,0),Enter:()=>this.selectMention(this.mentionOptions[this.mentionIndex])," ":()=>this.selectMention(this.mentionOptions[this.mentionIndex]),Escape:()=>this.mentionOpen=!1};t[e.key]&&(e.preventDefault(),t[e.key]())},async submit(){if(this.submitting)return;let e=this.$refs?.form;if(!e)throw new Error("Form ref not found");this.submitting=!0;try{let s=this.$refs?.lensSelect?.value?.trim()||this.$store.search.lens_id||"",n=this.buildSubmitQuery(),r=Number(this.$store.search.limit);if(!r||r<1)throw new Error("Invalid search limit");let i={q:n,exact:!!this.$store.search.exact,limit:r,lens_id:s||void 0},o=await fetch(e.action,{method:"POST",headers:{"Content-Type":"application/json",Accept:"text/html"},body:JSON.stringify(i)});if(!o.ok)throw new Error(`Search failed (HTTP ${o.status})`);let a=await o.text(),h=new DOMParser().parseFromString(a,"text/html").querySelector("#search-root"),d=document.querySelector("#search-root");if(!h)throw new Error("Response missing #search-root element");if(!d)throw new Error("Page missing #search-root element");d.replaceWith(h);let l=new URLSearchParams;i.q&&l.set("q",i.q),i.exact&&l.set("exact","true"),i.limit&&l.set("limit",String(i.limit)),i.lens_id&&l.set("lens_id",i.lens_id);let m=l.toString()?`${e.action}?${l.toString()}`:e.action;window.history.replaceState({},"",m)}catch(t){let s=t instanceof Error?t.message:String(t);this.showError(`Search failed: ${s}`)}finally{this.submitting=!1}},clearLenses(){this.$store.search.clearLens()}});var A=(e,t)=>({lensId:e,rawAtName:t,init(){if(!this.lensId||!this.rawAtName)throw new Error("lensId and rawAtName are required");this.render()},render(){let s=this.$el,n=E(this.rawAtName.toLowerCase());s.className="query-token",s.dataset.token="lens",s.dataset.lensId=this.lensId,s.dataset.atName=n,s.textContent=`@${n}`,s.setAttribute("contenteditable","false"),s.style.cursor="pointer"},removeLens(){this.$store.search.clearLens()}});var I=()=>({pending:!1,assistantEventSource:null,systemEventSource:null,createPlaceholder(e){let t=this.$refs.placeholderTemplate.content.cloneNode(!0),s=t.querySelector(".message");return s.dataset.tempId=e,t},parseHtmlElement(e){let t=document.createElement("template");return t.innerHTML=String(e).trim(),t.content.firstElementChild},cleanupEventStreams(){this.assistantEventSource&&this.assistantEventSource.close(),this.systemEventSource&&this.systemEventSource.close(),this.assistantEventSource=null,this.systemEventSource=null},cleanupAssistantStream(){this.assistantEventSource&&this.assistantEventSource.close(),this.assistantEventSource=null},cleanupSystemStream(){this.systemEventSource&&this.systemEventSource.close(),this.systemEventSource=null},startEventStreams(e,t,{afterAssistantUuid:s=null,afterSystemUuid:n=null}={}){if(this.assistantEventSource||this.systemEventSource)return;let r=new URL(`/v1/threads/${e}/events`,window.location.origin);r.searchParams.set("role","assistant"),s&&r.searchParams.set("after_uuid",s);let i=new URL(`/v1/threads/${e}/events`,window.location.origin);i.searchParams.set("role","system"),n&&i.searchParams.set("after_uuid",n),this.assistantEventSource=new EventSource(r),this.systemEventSource=new EventSource(i),this.assistantEventSource.addEventListener("assistant",async o=>{try{let c=JSON.parse(o?.data||"{}")?.uuid;if(!c)return;let h=await fetch(`/v1/messages/${c}/fragment`,{headers:{Accept:"text/html"}});if(!h.ok)return;let d=await h.text(),l=this.parseHtmlElement(d),m=this.$refs.responses.querySelector(`[data-temp-id="${t}"]`);m&&l&&m.replaceWith(l)}finally{this.cleanupEventStreams()}}),this.systemEventSource.addEventListener("system",async o=>{let a=JSON.parse(o?.data||"{}"),c=a?.uuid,h=a?.meta||{};if(c&&!(h?.object!=="job"||h?.status!=="failed"))try{let d=await fetch(`/v1/messages/${c}/fragment`,{headers:{Accept:"text/html"}});if(!d.ok)return;let l=await d.text(),m=this.parseHtmlElement(l),w=this.$refs.responses.querySelector(`[data-temp-id="${t}"]`);w&&m&&w.replaceWith(m)}finally{this.cleanupEventStreams()}}),this.assistantEventSource.addEventListener("error",()=>this.cleanupAssistantStream()),this.systemEventSource.addEventListener("error",()=>this.cleanupSystemStream())},init(){if(!this.$refs.responses||this.$refs.responses.children.length)return;let e=this.$el?.dataset?.threadId;if(!e)return;let t="initial",s=this.createPlaceholder(t);this.$refs.responses.prepend(s),this.startEventStreams(e,t)},async regenerate(e){if(this.pending)return;let t=e?.currentTarget,s=t?.dataset?.threadId,n=t?.dataset?.model;if(!s)return;this.pending=!0;let r=Math.random().toString(36).slice(2,10),i=this.createPlaceholder(r);this.$refs.responses.prepend(i);try{let a=this.$refs.responses.querySelector(".message[data-uuid]")?.dataset?.uuid||null,c=await fetch("/v1/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({thread_id:s,model:n,generate_assistant:!0,lens_id:this.$refs?.lensSelect?.value||void 0})});if(!c.ok)throw new Error(`Create message HTTP ${c.status}`);this.startEventStreams(s,r,{afterAssistantUuid:a})}catch(o){console.error("Error:",o);let a=this.$refs.responses.querySelector(`[data-temp-id="${r}"]`);a&&a.remove()}finally{this.pending=!1}}});document.addEventListener("alpine:init",()=>{if(!window.TRANSPORT?.search)throw new Error("TRANSPORT.search not found");Alpine.store("search",{...window.TRANSPORT.search,clearLens(){this.lens_id=""}}),Alpine.data("askButton",v),Alpine.data("responseMessage",x),Alpine.data("searchForm",O),Alpine.data("lensToken",A),Alpine.data("threadPage",I)});})();
