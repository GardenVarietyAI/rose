(()=>{var R=()=>({disabled:!1,label:"Ask",async ask(){let e=this.$el.closest("form")?.querySelector('[name="q"]:not([disabled])')?.value?.trim()||"";if(!(!e||this.disabled)){this.disabled=!0;try{let r=this.$el.closest("form")?.querySelector('select[name="lens_id"]')?.value?.trim()||"",a=await(await fetch("/v1/ask",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:e,lens_id:r||void 0})})).json();if(!a?.thread_id)throw new Error("Missing thread_id");let c=r?`?lens_id=${encodeURIComponent(r)}`:"";window.location.href="/v1/threads/"+a.thread_id+c}catch(t){alert("Error: "+(t?.message||String(t)))}finally{this.disabled=!1}}}});var P=()=>({uuid:null,accepted:!1,collapsed:!1,expanded:!1,editing:!1,draft:"",original:"",editable:!1,saving:!1,init(){this.uuid=this.$el.dataset.uuid,this.accepted=this.$el.classList.contains("accepted");let e=this.$refs?.sourceContent;this.editable=!!e;let t=this.$el.querySelector(".message-content");if(t&&!this.editable){let r=t.textContent?.trim()||"";t.innerHTML=this.$markdown(r)}if(!this.editable)return;let n=e.content?.textContent;this.original=(n??t?.innerText??"").trimEnd(),this.draft=this.original},startEdit(){this.editable&&(this.editing=!0,this.draft=this.original,this.$nextTick(()=>this.$refs?.editor?.focus()))},cancelEdit(){this.editable&&(this.editing=!1,this.draft=this.original)},async saveEdit(){if(!(!this.editable||this.saving)){this.saving=!0;try{let e=await fetch(`/v1/messages/${this.uuid}/revisions`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({content:this.draft})});if(!e.ok)throw new Error(`HTTP ${e.status}`);window.location.reload()}catch(e){console.error("Error:",e),this.saving=!1}}},async toggleAccepted(){try{let e=await fetch(`/v1/messages/${this.uuid}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({accepted:!this.accepted})});if(!e.ok)throw new Error(`HTTP ${e.status}`);this.accepted=!this.accepted}catch(e){console.error("Error:",e)}}});function b(e){let t=[];for(let n of e)if(n.type==="text")if(t.length>0&&t[t.length-1].type==="text"){let r=t[t.length-1];r.value+=n.value}else t.push({type:"text",value:n.value});else t.push(n);return(t.length===0||t[t.length-1].type!=="text")&&t.push({type:"text",value:""}),t}function L(e){let t=[];for(let n of e)n.type==="text"&&n.value&&t.push(n.value);return t.join("")}function _(e,t=[]){let n=[];for(let r of t)n.push({type:"lens",lensId:r.lensId,atName:r.atName});return e&&n.push({type:"text",value:e}),b(n)}function N(e,t){let n=Math.max(0,Math.min(t.tokenIndex,e.length-1)),r=e[n],s=r.type==="text"?r.value.length:0,a=Math.max(0,Math.min(t.offset,s));return{tokenIndex:n,offset:a}}function q(e,t){let{tokens:n,caret:r}=e;if(t.type==="insertText"){let{at:s,text:a}=t,c=[...n],f=c[s.tokenIndex];if(f.type!=="text")throw new Error("Cannot insert text into non-text token");let d=f.value.slice(0,s.offset),o=f.value.slice(s.offset);c[s.tokenIndex]={type:"text",value:d+a+o};let l=b(c),m={tokenIndex:s.tokenIndex,offset:s.offset+a.length},g=N(l,m),k={type:"deleteRange",from:s,to:{tokenIndex:s.tokenIndex,offset:s.offset+a.length}};return{buffer:{tokens:l,caret:g},inverse:k}}if(t.type==="deleteRange"){let{from:s,to:a}=t,c=[...n],f=[];if(s.tokenIndex===a.tokenIndex){let i=c[s.tokenIndex];if(i.type!=="text")throw new Error("Cannot delete from non-text token");let u=i.value.slice(0,s.offset),T=i.value.slice(s.offset,a.offset),y=i.value.slice(a.offset);c[s.tokenIndex]={type:"text",value:u+y};let I=b(c),v={tokenIndex:s.tokenIndex,offset:s.offset},$=N(I,v);return{buffer:{tokens:I,caret:$},inverse:{type:"insertText",at:s,text:T}}}let d=c[s.tokenIndex],o=c[a.tokenIndex];if(d.type!=="text"||o.type!=="text")throw new Error("Cross-token delete requires text tokens at boundaries");let l=d.value.slice(0,s.offset),m=d.value.slice(s.offset),g=o.value.slice(0,a.offset),k=o.value.slice(a.offset);for(let i=s.tokenIndex;i<=a.tokenIndex;i++)f.push(c[i]);f[0]={type:"text",value:m},f[f.length-1]={type:"text",value:g};let x=[];for(let i=0;i<f.length;i++){let u=f[i];if(u.type==="text")if(x.length>0&&x[x.length-1].type==="text"){let T=x[x.length-1];x[x.length-1]={type:"text",value:T.value+u.value}}else x.push(u);else x.push(u)}for(let i=a.tokenIndex;i>=s.tokenIndex;i--)c.splice(i,1);c.splice(s.tokenIndex,0,{type:"text",value:l+k});let p=b(c),E={tokenIndex:s.tokenIndex,offset:s.offset},w=N(p,E);return{buffer:{tokens:p,caret:w},inverse:{type:"insertTokens",at:s,tokens:x}}}if(t.type==="replaceToken"){let{index:s,token:a}=t,c=[...n],f=c[s];c[s]=a;let d=b(c),o=N(d,r);return{buffer:{tokens:d,caret:o},inverse:{type:"replaceToken",index:s,token:f}}}if(t.type==="insertTokens"){let{at:s,tokens:a}=t,c=[...n],f=c[s.tokenIndex];if(f.type!=="text")throw new Error("Cannot insert tokens into non-text token");let d=f.value.slice(0,s.offset),o=f.value.slice(s.offset),l=[...a];if(l.length>0){let h=l[0];h.type==="text"?l[0]={type:"text",value:d+h.value}:d&&l.unshift({type:"text",value:d});let i=l[l.length-1];i.type==="text"?l[l.length-1]={type:"text",value:i.value+o}:o&&l.push({type:"text",value:o})}else l.push({type:"text",value:d+o});c.splice(s.tokenIndex,1,...l);let m=b(c),g=a[a.length-1],k=0,x=0;if(g&&g.type!=="text"){let h=0;for(let v=0;v<s.tokenIndex;v++){let $=n[v];$.type==="text"&&(h+=$.value.length)}h+=s.offset;let i=h;for(let v of a)v.type==="text"&&(i+=v.value.length);let u=0;for(let v of a)v.type!=="text"&&u++;let T=0,y=0,I=!1;for(let v=0;v<m.length;v++){let $=m[v];if($.type==="text"){if(!I&&T>=h&&(I=!0),i<=T+$.value.length){k=v,x=i-T;break}T+=$.value.length}else if(I&&(y++,y===u)){k=v+1,x=0;break}}}else{let h=d.length;for(let u of a)u.type==="text"&&(h+=u.value.length);let i=0;for(let u=0;u<m.length;u++){let T=m[u];if(T.type==="text"){if(h<=i+T.value.length){k=u,x=h-i;break}i+=T.value.length}}}let E=N(m,{tokenIndex:k,offset:x});return{buffer:{tokens:m,caret:E},inverse:{type:"deleteRange",from:s,to:E}}}throw new Error(`Unknown op type: ${t.type}`)}function C(e){let t=document.createElement("div");return t.textContent=e||"",t.textContent||""}function D(e,t){t.textContent="";let n=new Map,r=0;for(let s=0;s<e.length;s++){let a=e[s];if(a.type==="lens"){let c=document.createElement("span");c.setAttribute("x-data",`lensToken('${a.lensId}', '${a.atName}')`),c.setAttribute("x-on:click","removeLens()"),c.setAttribute("data-token","lens"),t.appendChild(c),n.set(s,{node:c,textStart:r,textEnd:r})}else if(a.type==="text"){let c=document.createTextNode(C(a.value));t.appendChild(c),n.set(s,{node:c,textStart:r,textEnd:r+a.value.length}),r+=a.value.length}}return n}function j(e,t,n){let r=t.get(e.tokenIndex);if(!r)return null;if(r.node.nodeType===Node.TEXT_NODE)return{node:r.node,offset:e.offset};if(e.offset===0)return{node:n,offset:Array.from(n.childNodes).indexOf(r.node)};let s=e.tokenIndex+1,a=t.get(s);return a?{node:n,offset:Array.from(n.childNodes).indexOf(a.node)}:{node:n,offset:n.childNodes.length}}function A(e,t,n,r){for(let[s,a]of n.entries())if(a.node===e)return e.nodeType===Node.TEXT_NODE?{tokenIndex:s,offset:Math.min(t,a.textEnd-a.textStart)}:{tokenIndex:s,offset:0};if(e===r){let s=Array.from(r.childNodes);if(t>=s.length){let c=n.size-1,f=n.get(c);return f&&f.node.nodeType===Node.TEXT_NODE?{tokenIndex:c,offset:f.textEnd-f.textStart}:{tokenIndex:c,offset:0}}let a=s[t];for(let[c,f]of n.entries())if(f.node===a)return{tokenIndex:c,offset:0}}return{tokenIndex:n.size-1,offset:0}}var W=/(?:^|[^A-Za-z0-9-])@([A-Za-z0-9-]*)/g;function B(e,t){let n="",r=[],s=0,a=-1;for(let g=0;g<e.length;g++){let k=e[g];if(k.type==="text"){let x=n.length;n+=k.value,r.push({tokenIndex:g,startChar:x,endChar:n.length}),g<t.tokenIndex?s+=k.value.length:g===t.tokenIndex&&(s+=t.offset,a=r.length-1)}else r.push({tokenIndex:g,startChar:n.length,endChar:n.length}),g<t.tokenIndex&&(a=r.length-1)}if(a===-1||n.length===0)return null;let c=n.slice(0,s),f=Array.from(c.matchAll(W));if(f.length===0)return null;let d=f[f.length-1],o=d[0].startsWith("@")?0:1,l=d.index+o,m=l+d[0].length-o;if(m!==s)return null;for(let g of r)if(l>=g.startChar&&l<g.endChar)return m>g.endChar?null:{tokenIndex:g.tokenIndex,startOffset:l-g.startChar,endOffset:m-g.startChar,query:d[1].toLowerCase(),raw:d[0].slice(o)};return null}function H(e){let t=e,n={tokens:_(""),caret:{tokenIndex:0,offset:0}},r=null,s=!1,a=()=>{if(!t||!r||document.activeElement!==t)return;let o=j(n.caret,r,t);if(!o)return;let l=window.getSelection();if(!l)return;let m=document.createRange();m.setStart(o.node,o.offset),m.collapse(!0),l.removeAllRanges(),l.addRange(m)},c=()=>{if(!t||!r)return;let o=window.getSelection();if(!o||!o.rangeCount)return;let l=o.getRangeAt(0);n.caret=A(l.startContainer,l.startOffset,r,t)},f=()=>{if(!t)return;let o=[],l=new Map,m=0,g=0,k=!1;for(let h of t.childNodes){if(h.nodeType===Node.ELEMENT_NODE&&h.dataset?.token==="lens"){o.push({type:"lens",lensId:h.dataset.lensId,atName:h.dataset.atName}),l.set(g++,{node:h,textStart:m,textEnd:m});continue}if(h.nodeType===Node.TEXT_NODE){let i=h.textContent||"";o.push({type:"text",value:i}),l.set(g++,{node:h,textStart:m,textEnd:m+i.length}),m+=i.length;continue}h.nodeType===Node.ELEMENT_NODE&&h.tagName==="BR"&&(k=!0)}let x=o.some((h,i)=>h.type==="text"&&i>0&&o[i-1].type==="text"),p=o.length>0&&o[o.length-1].type==="lens";(x||p||k)&&(k=!0);let E=n.caret,w=window.getSelection();if(w&&w.rangeCount){let h=w.getRangeAt(0);E=A(h.startContainer,h.startOffset,l,t)}if(k){let h=b(o);E=N(h,E),n={tokens:h,caret:E},d()}else{let h=b(o);E=N(h,E),n={tokens:h,caret:E},r=l}},d=()=>{if(!(!t||s)){s=!0;try{r=D(n.tokens,t),a(),window.Alpine&&window.Alpine.initTree(t)}finally{s=!1}}};return{getBuffer(){return n},setBuffer(o){n=o,d()},loadFromQuery(o,l){let m=[];l?.lensId&&l?.atName&&m.push({lensId:l.lensId,atName:l.atName});let g=_(o,m),k=g.length-1,x=g[k];n={tokens:g,caret:{tokenIndex:k,offset:x?.type==="text"?x.value.length:0}},d()},syncFromDOM(){f()},syncBufferOnly(){if(!t)return;let o=[],l=new Map,m=0,g=0;for(let h of t.childNodes)if(h.nodeType===Node.ELEMENT_NODE&&h.dataset?.token==="lens")o.push({type:"lens",lensId:h.dataset.lensId,atName:h.dataset.atName}),l.set(g++,{node:h,textStart:m,textEnd:m});else if(h.nodeType===Node.TEXT_NODE){let i=h.textContent||"";o.push({type:"text",value:i}),l.set(g++,{node:h,textStart:m,textEnd:m+i.length}),m+=i.length}o.length===0&&(o.push({type:"text",value:""}),l.set(0,{node:null,textStart:0,textEnd:0}));let k=window.getSelection(),x={tokenIndex:0,offset:0};if(k&&k.rangeCount){let h=k.getRangeAt(0);x=A(h.startContainer,h.startOffset,l,t)}let p=o.length-1;x.tokenIndex=Math.max(0,Math.min(x.tokenIndex,p));let E=o[x.tokenIndex],w=E?.type==="text"?E.value.length:0;x.offset=Math.max(0,Math.min(x.offset,w)),n={tokens:o,caret:x},r=l},serialize(){return L(n.tokens)},detectMention(){return B(n.tokens,n.caret)},insertLensToken(o,l,m){if(!t)return;let g=window.getSelection();if(!g||!g.rangeCount)return;let k=r.get(o.tokenIndex);if(!k||!k.node)return;let x=k.node,p=x.textContent||"",E=p.slice(0,o.startOffset),w=p.slice(o.endOffset),h=document.createElement("span");h.setAttribute("x-data",`lensToken('${l}', '${m}')`),h.setAttribute("x-on:click","removeLens()"),h.setAttribute("data-token","lens");let i=x.parentNode;if(!i)return;if(E){let y=document.createTextNode(E);i.insertBefore(y,x)}if(i.insertBefore(h,x),w){let y=document.createTextNode(w);i.insertBefore(y,x)}else{let y=document.createTextNode(" ");i.insertBefore(y,x)}i.removeChild(x),window.Alpine&&window.Alpine.initTree(h);let u=document.createRange(),T=h.nextSibling;T&&T.nodeType===Node.TEXT_NODE&&(u.setStart(T,0),u.collapse(!0),g.removeAllRanges(),g.addRange(u)),this.syncBufferOnly()},applyOperation(o){c();let l=q(n,o);return n=l.buffer,d(),l.inverse},removeLens(o){if(!t)return;let l=t.querySelector(`[data-token="lens"][data-lens-id="${o}"]`);!l||!l.parentNode||(l.parentNode.removeChild(l),this.syncBufferOnly())},placeCaretAtEnd(){if(!t)return;let o=window.getSelection();if(!o)return;let l=t.lastChild;if(!l)return;let m=document.createRange();l.nodeType===Node.TEXT_NODE?m.setStart(l,l.textContent?.length||0):m.setStartAfter(l),m.collapse(!0),o.removeAllRanges(),o.addRange(m),this.syncBufferOnly()},onInput(o){t&&t.addEventListener("input",()=>{c(),o()})},destroy(){r=null}}}var z=()=>({queryValue:"",settingsOpen:!1,submitting:!1,mentionOpen:!1,mentionIndex:0,mentionQuery:"",mentionOptions:[],lensOptions:[],idToAtName:{},errorMessage:"",controller:null,showError(e){this.errorMessage=e,setTimeout(()=>this.errorMessage="",5e3)},init(){let e=this.$store.search.query||"",t=this.$store.search.lens_map||{};this.queryValue=e.replace(/^@\S+\s*/,""),this.buildLensState(t),this.controller=H(this.$refs?.editor),this.$watch("queryValue",n=>{this.$store.search.query=n}),this.$watch("$store.search.lens_id",(n,r)=>{let s=this.$refs?.lensSelect;s&&(s.value=n),r!==void 0&&this.controller.removeLens(r),this.syncFromStore(),r!==void 0&&this.controller&&document.activeElement===this.$refs?.editor&&this.controller.placeCaretAtEnd()}),this.$nextTick(()=>{this.syncFromStore(),e||this.$refs?.editor?.focus()})},syncFromStore(){if(!this.controller)return;this.controller.loadFromQuery(this.queryValue,this.getSelectedLens());let e=this.$refs?.textarea;e&&(e.value=this.queryValue)},syncToStore(){if(!this.controller)throw new Error("Buffer controller not initialized");this.controller.syncBufferOnly();let e=this.controller.serialize();if(e!==this.queryValue){this.queryValue=e;let t=this.$refs?.textarea;t&&(t.value=e)}this.updateMentionState()},updateMentionState(){if(!this.controller)return;let e=this.controller.detectMention();if(!e){this.mentionOpen=!1,this.mentionQuery="",this.mentionOptions=this.lensOptions,this.mentionIndex=0;return}let t=e.query,n=this.lensOptions.filter(s=>s.atName.startsWith(t)),r=this.mentionOpen&&this.mentionQuery===t;this.mentionOpen=n.length>0,this.mentionQuery=t,this.mentionOptions=n,this.mentionIndex=r?Math.min(this.mentionIndex,Math.max(n.length-1,0)):0},buildLensState(e){let t=Object.entries(e).map(([r,s])=>({lensId:s,atName:r.toLowerCase()})).filter(r=>r.atName),n=Object.fromEntries(Object.entries(e).map(([r,s])=>[s,r]));this.lensOptions=t,this.mentionOptions=t,this.idToAtName=n},getSelectedLens(){let e=this.$store.search.lens_id||"";if(!e)return null;let t=this.idToAtName[e]||"";return{lensId:e,atName:t}},selectMention(){if(!this.controller||!this.mentionOpen||!this.mentionOptions.length)return;let e=this.controller.detectMention();if(!e)return;let t=this.mentionOptions[this.mentionIndex];t&&(this.controller.insertLensToken(e,t.lensId,t.atName),this.$store.search.lens_id=t.lensId,this.queryValue=this.controller.serialize(),this.mentionOpen=!1,this.mentionQuery="",this.mentionOptions=this.lensOptions,this.mentionIndex=0)},handleEditorKeydown(e){if(!this.mentionOpen){e.key==="Enter"&&(e.preventDefault(),this.submit());return}if(e.key==="ArrowDown"){e.preventDefault();let t=Math.max(this.mentionOptions.length-1,0);this.mentionIndex=Math.min(this.mentionIndex+1,t);return}if(e.key==="ArrowUp"){e.preventDefault(),this.mentionIndex=Math.max(this.mentionIndex-1,0);return}if(e.key==="Enter"||e.key===" "){e.preventDefault(),this.selectMention();return}e.key==="Escape"&&(e.preventDefault(),this.mentionOpen=!1,this.mentionQuery="",this.mentionOptions=this.lensOptions,this.mentionIndex=0)},async submit(){if(this.submitting)return;let e=this.$refs?.form;if(!e)throw new Error("Form ref not found");this.submitting=!0;try{let n=this.$refs?.lensSelect?.value?.trim()||this.$store.search.lens_id||"",r=this.queryValue.trim(),s=Number(this.$store.search.limit);if(!s||s<1)throw new Error("Invalid search limit");let a={q:r,exact:!!this.$store.search.exact,limit:s,lens_id:n||void 0},c=await fetch("/v1/search/fragment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!c.ok)throw new Error(`Search failed (HTTP ${c.status})`);let f=await c.text(),d=document.querySelector("#search-root");if(!d)throw new Error("Page missing #search-root element");d.outerHTML=f;let o=new URLSearchParams;a.q&&o.set("q",a.q),a.exact&&o.set("exact","true"),a.limit&&o.set("limit",String(a.limit)),a.lens_id&&o.set("lens_id",a.lens_id);let l=o.toString()?`${e.action}?${o.toString()}`:e.action;window.history.replaceState({},"",l)}catch(t){let n=t instanceof Error?t.message:String(t);this.showError(`Search failed: ${n}`)}finally{this.submitting=!1}}});var F=(e,t)=>({lensId:e,rawAtName:t,init(){if(!this.lensId||!this.rawAtName)throw new Error("lensId and rawAtName are required");this.render()},render(){let n=this.$el,r=C(this.rawAtName.toLowerCase());n.className="query-token",n.dataset.token="lens",n.dataset.lensId=this.lensId,n.dataset.atName=r,n.textContent=`@${r}`,n.setAttribute("contenteditable","false"),n.style.cursor="pointer"},removeLens(){this.$store.search.clearLens()}});var G={},U=()=>({preview:!1,importing:!1,complete:!1,threads:[],parseReport:null,selectedFormat:null,banner:{visible:!1,type:"",message:"",timeout:null},get currentValidator(){return G[this.selectedFormat]},handleFormatChange(){this.threads=[],this.parseReport=null,this.preview=!1,this.closeBanner(),this.$refs.fileInput&&(this.$refs.fileInput.value="")},showBanner(e,t){this.banner.visible=!0,this.banner.type=e,this.banner.message=t,this.banner.timeout&&clearTimeout(this.banner.timeout),this.banner.timeout=setTimeout(()=>{this.banner.visible=!1},5e3)},closeBanner(){this.banner.visible=!1,this.banner.timeout&&clearTimeout(this.banner.timeout)},get selectedCount(){return this.threads.filter(e=>e.selected).length},get totalMessageCount(){return this.threads.filter(e=>e.selected).reduce((e,t)=>e+1+t.assistantMessages.length,0)},get parseReportSummary(){if(!this.parseReport)return"";let e=this.parseReport,t=[];if(t.push(`${e.parsed} records parsed`),e.skipped>0){let n=[];e.errors.invalidJSON.length>0&&n.push(`${e.errors.invalidJSON.length} invalid JSON`),e.errors.emptyContent>0&&n.push(`${e.errors.emptyContent} empty content`),e.errors.validationErrors.length>0&&n.push(`${e.errors.validationErrors.length} validation errors`),t.push(`${e.skipped} skipped: ${n.join(", ")}`)}return t.join(", ")},handleFileSelect(e){let t=e.target.files?.[0];if(!t)return;let n=new FileReader;n.onload=r=>{try{let s=r.target.result,{threads:a,report:c}=this.currentValidator.parse(s);this.threads=a,this.parseReport=c,this.preview=!0,c.skipped>0&&this.showBanner("error",this.parseReportSummary)}catch(s){console.error("Parse error:",s),this.showBanner("error",`Failed to parse file: ${s.message}`)}},n.readAsText(t)},toggleAll(){let e=this.threads.every(t=>t.selected);this.threads.forEach(t=>t.selected=!e)},cancelImport(){this.preview=!1,this.threads=[],this.parseReport=null,this.closeBanner(),this.$refs.fileInput.value=""},async executeImport(){if(!(this.importing||this.selectedCount===0)){this.importing=!0;try{let e=[];for(let s of this.threads.filter(a=>a.selected)){e.push({thread_id:s.threadId,role:s.userMessage.role,content:s.userMessage.content,model:s.userMessage.model,created_at:s.userMessage.created_at,import_external_id:s.userMessage.uuid,meta:{imported_external_id:s.userMessage.uuid,imported_external_session_id:s.userMessage.sessionId,imported_external_created_at:s.userMessage.timestamp}});for(let a of s.assistantMessages)e.push({thread_id:s.threadId,role:a.role,content:a.content,model:a.model,created_at:a.created_at,import_external_id:a.uuid,meta:{imported_external_id:a.uuid,imported_external_session_id:a.sessionId,imported_external_created_at:a.timestamp}})}let t=await fetch("/v1/import/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({import_source:this.currentValidator.importSource,messages:e})});if(!t.ok)throw new Error("Could not import records.");let n=await t.json();this.preview=!1,this.complete=!0;let r=n.skipped_duplicates>0?`Imported ${n.imported} messages (skipped ${n.skipped_duplicates} duplicates)`:`Successfully imported ${n.imported} messages`;this.showBanner("success",r)}catch(e){console.error("Import error:",e),this.showBanner("error",`Failed to import: ${e.message}`),this.importing=!1}}}});var V=()=>({pending:!1,assistantEventSource:null,jobPollTimeout:null,jobPollAttempt:0,createPlaceholder(e){let t=this.$refs.placeholderTemplate.content.cloneNode(!0),n=t.querySelector(".message");return n.dataset.tempId=e,t},parseHtmlElement(e){let t=document.createElement("template");return t.innerHTML=String(e).trim(),t.content.firstElementChild},cleanupAssistantStream(){this.assistantEventSource&&this.assistantEventSource.close(),this.assistantEventSource=null},cleanupJobPoll(){this.jobPollTimeout&&clearTimeout(this.jobPollTimeout),this.jobPollTimeout=null,this.jobPollAttempt=0},async pollJobStatus(e,t){try{let n=await fetch(`/v1/threads/${e}/activity`,{headers:{Accept:"application/json"}});if(!n.ok)return;if((await n.json())?.job_events?.[0]?.status==="failed"){let c=this.$refs.responses.querySelector(`[data-temp-id="${t}"]`);c&&c.remove(),this.cleanupJobPoll();return}this.jobPollAttempt+=1;let a=Math.min(1e3*Math.pow(2,this.jobPollAttempt),3e4);this.jobPollTimeout=setTimeout(()=>this.pollJobStatus(e,t),a)}catch(n){console.error("Error polling job status:",n),this.jobPollAttempt+=1;let r=Math.min(1e3*Math.pow(2,this.jobPollAttempt),3e4);this.jobPollTimeout=setTimeout(()=>this.pollJobStatus(e,t),r)}},startEventStreams(e,t,{afterAssistantUuid:n=null}={}){if(this.assistantEventSource)return;let r=new URL(`/v1/threads/${e}/stream`,window.location.origin);r.searchParams.set("role","assistant"),n&&r.searchParams.set("after_uuid",n),this.assistantEventSource=new EventSource(r),this.assistantEventSource.addEventListener("assistant",async s=>{try{let c=JSON.parse(s?.data||"{}")?.uuid;if(!c)return;let f=await fetch(`/v1/messages/${c}/fragment`,{headers:{Accept:"text/html"}});if(!f.ok)return;let d=await f.text(),o=this.parseHtmlElement(d),l=this.$refs.responses.querySelector(`[data-temp-id="${t}"]`);l&&o&&l.replaceWith(o),this.cleanupJobPoll()}finally{this.cleanupAssistantStream()}}),this.assistantEventSource.addEventListener("error",()=>this.cleanupAssistantStream()),this.jobPollAttempt=0,this.pollJobStatus(e,t)},init(){if(!this.$refs.responses||this.$refs.responses.children.length)return;let e=this.$el?.dataset?.threadId;if(!e)return;let t="initial",n=this.createPlaceholder(t);this.$refs.responses.prepend(n),this.startEventStreams(e,t)},async regenerate(e){if(this.pending)return;let t=e?.currentTarget,n=t?.dataset?.threadId,r=t?.dataset?.model,s=t?.dataset?.promptContent;if(!n||!s)return;this.pending=!0;let a=Math.random().toString(36).slice(2,10),c=this.createPlaceholder(a);this.$refs.responses.prepend(c);try{let d=this.$refs.responses.querySelector(".message[data-uuid]")?.dataset?.uuid||null,o=await fetch("/v1/ask",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:s,thread_id:n,lens_id:this.$refs?.lensSelect?.value||void 0,model:r})});if(!o.ok)throw new Error(`Ask HTTP ${o.status}`);this.startEventStreams(n,a,{afterAssistantUuid:d})}catch(f){console.error("Error:",f);let d=this.$refs.responses.querySelector(`[data-temp-id="${a}"]`);d&&d.remove()}finally{this.pending=!1}}});var J=()=>({}),X=e=>({open(){this.$store.threads.setCurrentThread(e),this.$refs.popover.showPopover()},close(){this.$refs.popover.hidePopover(),this.$store.threads.clearCurrentThread()},get isDeleting(){return this.$store.threads.isDeleting(e)},async confirmDelete(){this.$store.threads.setDeleting(!0);try{let t=await fetch(`/v1/threads/${e}`,{method:"DELETE"});if(!t.ok){let n=await t.json().catch(()=>({}));throw new Error(n.detail||`HTTP ${t.status}`)}window.location.reload()}catch(t){console.error("Delete error:",t),alert(`Failed to delete thread: ${t.message}`),this.$store.threads.setDeleting(!1)}}});function Q(e,t){if(typeof e!="string")throw new TypeError("highlightCode expects a string");let n=Z(e,t),r=[],s=[],a=[],c=[],f=[],d=i=>{if(!Number.isInteger(i)||i<0)throw new TypeError("encodeIndex expects a non-negative integer");let u="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",T=u.length,y=i,I="";do I=u[y%T]+I,y=Math.floor(y/T);while(y>0);return I},o=i=>`HLSTR${d(i)}`,l=i=>`HLCMT${d(i)}`,m=i=>`HLKW${d(i)}`,g=i=>`HLBI${d(i)}`,k=i=>`HLNUM${d(i)}`,x=i=>{let u="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",T=u.length,y=0;for(let I of String(i)){let v=u.indexOf(I);if(v===-1)throw new Error("Invalid placeholder encoding");y=y*T+v}return y},p=e;n==="python"?(p=p.replace(/#[^\n]*/g,i=>{let u=s.length;return s.push(i),l(u)}),p=p.replace(/'''[\s\S]*?'''|"""[\s\S]*?"""/g,i=>{let u=r.length;return r.push(i),o(u)}),p=p.replace(/'([^'\\]|\\.)*?'|"([^"\\]|\\.)*?"/g,i=>{let u=r.length;return r.push(i),o(u)})):n==="sql"?(p=p.replace(/--[^\n]*/g,i=>{let u=s.length;return s.push(i),l(u)}),p=p.replace(/'([^'\\]|\\.)*?'/g,i=>{let u=r.length;return r.push(i),o(u)})):(p=p.replace(/\/\/[^\n]*/g,i=>{let u=s.length;return s.push(i),l(u)}),p=p.replace(/\/\*[\s\S]*?\*\//g,i=>{let u=s.length;return s.push(i),l(u)}),p=p.replace(/'([^'\\]|\\.)*?'|"([^"\\]|\\.)*?"|`([^`\\]|\\.)*?`/g,i=>{let u=r.length;return r.push(i),o(u)})),p=M(p);let E=i=>i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),w=Y(n);if(w.length>0){let i=n==="sql"?"gi":"g",u=new RegExp(`\\b(${w.map(E).join("|")})\\b`,i);p=p.replace(u,T=>{let y=a.length;return a.push(T),m(y)})}let h=ee(n);if(h.length>0){let i=n==="sql"?"gi":"g",u=new RegExp(`\\b(${h.map(E).join("|")})\\b`,i);p=p.replace(u,T=>{let y=c.length;return c.push(T),g(y)})}return p=p.replace(/\b\d+(\.\d+)?\b/g,i=>{let u=f.length;return f.push(i),k(u)}),p=p.replace(/\u0001HLSTR([A-Za-z]+)\u0001/g,(i,u)=>{let T=x(u),y=r[T];if(y===void 0)throw new Error("Invalid string placeholder index");return`<span class="hl-str">${M(y)}</span>`}),p=p.replace(/\u0001HLCMT([A-Za-z]+)\u0001/g,(i,u)=>{let T=x(u),y=s[T];if(y===void 0)throw new Error("Invalid comment placeholder index");return`<span class="hl-cmt">${M(y)}</span>`}),p=p.replace(/\u0001HLNUM([A-Za-z]+)\u0001/g,(i,u)=>{let T=x(u),y=f[T];if(y===void 0)throw new Error("Invalid number placeholder index");return`<span class="hl-num">${y}</span>`}),p=p.replace(/\u0001HLBI([A-Za-z]+)\u0001/g,(i,u)=>{let T=x(u),y=c[T];if(y===void 0)throw new Error("Invalid builtin placeholder index");return`<span class="hl-bi">${y}</span>`}),p=p.replace(/\u0001HLKW([A-Za-z]+)\u0001/g,(i,u)=>{let T=x(u),y=a[T];if(y===void 0)throw new Error("Invalid keyword placeholder index");return`<span class="hl-kw">${y}</span>`}),p}function M(e){if(typeof e!="string")throw new TypeError("escapeHtml expects a string");return e.replace(/[&<>"']/g,t=>t==="&"?"&amp;":t==="<"?"&lt;":t===">"?"&gt;":t==='"'?"&quot;":"&apos;")}function Z(e,t){if(t){let n=t.toLowerCase();return n==="js"||n==="javascript"||n==="typescript"||n==="ts"?"javascript":n==="py"||n==="python"?"python":n==="sql"||n==="postgres"||n==="postgresql"||n==="mysql"?"sql":n==="go"||n==="golang"?"go":n==="rs"||n==="rust"?"rust":n==="sh"||n==="bash"||n==="shell"?"shell":n}return/\b(def|class)\s+\w+[\(:]/.test(e)?"python":/\b(const|let|var|function)\s+\w+/.test(e)?"javascript":/^\s*(SELECT|INSERT|UPDATE|DELETE|CREATE|ALTER|DROP)\b/mi.test(e)?"sql":/\bfn\s+\w+\(/.test(e)?"rust":/\bfunc\s+\w+\(/.test(e)?"go":"generic"}function Y(e){let t={python:["def","class","if","else","elif","for","while","return","import","from","as","try","except","finally","with","lambda","yield","async","await","raise","pass","break","continue","in","is","not","and","or"],javascript:["function","const","let","var","if","else","for","while","return","import","export","default","class","extends","async","await","yield","typeof","new","delete","this","super","static","try","catch","finally","throw","break","continue","switch","case"],sql:["SELECT","FROM","WHERE","JOIN","INNER","LEFT","RIGHT","OUTER","ON","INSERT","INTO","VALUES","UPDATE","SET","DELETE","CREATE","TABLE","ALTER","DROP","INDEX","ORDER","BY","GROUP","HAVING","LIMIT","OFFSET","AS","AND","OR","NOT","IN","LIKE","BETWEEN"],go:["func","package","import","var","const","type","struct","interface","if","else","for","range","return","defer","go","chan","select","case","switch","break","continue"],rust:["fn","let","mut","const","static","struct","enum","impl","trait","type","if","else","match","for","while","loop","return","break","continue","use","mod","pub","crate"],shell:["if","then","else","elif","fi","for","while","do","done","case","esac","function","return","exit","export","source"],generic:[]};return t[e]||t.generic}function ee(e){let t={python:["True","False","None","self","str","int","float","bool","list","dict","tuple","set","len","range","print","open","type","isinstance","super","__init__","__name__"],javascript:["true","false","null","undefined","NaN","Infinity","console","window","document","Array","Object","String","Number","Boolean","Math","Date","Promise","JSON"],sql:["NULL","TRUE","FALSE","COUNT","SUM","AVG","MIN","MAX","DISTINCT","EXISTS"],go:["true","false","nil","make","new","len","cap","append","copy","delete","panic","recover"],rust:["true","false","None","Some","Ok","Err","Vec","String","Option","Result","println","panic"],shell:["echo","cd","ls","pwd","cat","grep","sed","awk","find","chmod","chown"],generic:["true","false","null","undefined"]};return t[e]||t.generic}function S(e){if(typeof e!="string")throw new TypeError("escapeHtml expects a string");return e.replace(/[&<>"']/g,t=>t==="&"?"&amp;":t==="<"?"&lt;":t===">"?"&gt;":t==='"'?"&quot;":"&#39;")}function O(e){if(typeof e!="string")throw new TypeError("parseInline expects a string");let t=[],n=[],r=[],s=f=>`ROSECODE${f}`,a=f=>`ROSELINK${f}`,c=f=>`ROSEAUTOLINK${f}`;return e=e.replace(/`([^`]*?)`/g,(f,d)=>{let o=t.length;return t.push(S(d)),s(o)}),e=e.replace(/\[([^\]]+)\]\(([^)]+)\)/g,(f,d,o)=>{let l=o.trim();if(!(/^(https?|mailto|tel):/i.test(l)||/^[/.#]/.test(l)))return d;let g=n.length,k=S(d),x=S(l);return n.push(`<a href="${x}" target="_blank" rel="noopener noreferrer">${k}</a>`),a(g)}),e=e.replace(/\bhttps?:\/\/[^\s<>"']+/g,f=>{let d=f,o="";for(;/[),.;:!?\\\]]$/.test(d);)o=d.slice(-1)+o,d=d.slice(0,-1);if(!d)return S(f);let l=r.length,m=S(d);return r.push(`<a href="${m}" target="_blank" rel="noopener noreferrer">${m}</a>${S(o)}`),c(l)}),e=S(e),e=e.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),e=e.replace(/__([^_]+)__/g,"<strong>$1</strong>"),e=e.replace(/\*([^*]+)\*/g,"<em>$1</em>"),e=e.replace(/_([^_]+)_/g,"<em>$1</em>"),e=e.replace(/\u0001ROSELINK(\d+)\u0001/g,(f,d)=>{let o=n[Number(d)];if(o===void 0)throw new Error("Invalid link placeholder index");return o}),e=e.replace(/\u0001ROSEAUTOLINK(\d+)\u0001/g,(f,d)=>{let o=r[Number(d)];if(o===void 0)throw new Error("Invalid auto-link placeholder index");return o}),e=e.replace(/\u0001ROSECODE(\d+)\u0001/g,(f,d)=>{let o=t[Number(d)];if(o===void 0)throw new Error("Invalid code placeholder index");return`<code>${o}</code>`}),e}function K(e){if(typeof e!="string")throw new TypeError("markdownToHtml expects a string");let t=1e5;if(e.length>t){let E=e.slice(0,t),w=`<div class="markdown-error">Content exceeds ${t} characters, showing truncated...`;return w+=`</div><pre>${S(E)}</pre>`,w}e=e.replace(/\r\n?/g,`
`);let n=e.split(`
`),r="",s=!1,a=!1,c=!1,f=!1,d=[],o=[],l="",m=[];function g(){d.length>0&&(r+=`<p>${O(d.join(" "))}</p>
`,d=[])}function k(){c&&(r+=`<blockquote>${o.join(`<br />
`)}</blockquote>
`,o=[],c=!1)}function x(){if(!f)return;let E=m.join(`
`),w=l?` class="language-${S(l)}"`:"",h=Q(E,l);r+=`<pre><code${w}>${h}</code></pre>
`,l="",m=[],f=!1}function p(){s&&(r+=`</ul>
`,s=!1),a&&(r+=`</ol>
`,a=!1)}for(let E=0;E<n.length;E++){let w=n[E],h=w.match(/^```([^\s`]+)?\s*$/);if(h){g(),p(),k(),f?x():(f=!0,l=(h[1]||"").trim(),m=[]);continue}if(f){m.push(w);continue}if(!w.trim()){g(),p(),k();continue}if(/^(\-\-\-|\*\*\*|___)\s*$/.test(w.trim())){g(),p(),k(),r+=`<hr />
`;continue}if(/^\s*>\s?/.test(w)){g(),p(),c||(c=!0);let y=w.replace(/^\s*>\s?/,"");o.push(O(y));continue}let i=w.match(/^(#{1,6})\s+(.*)$/);if(i){g(),p(),k();let y=i[1].length,I=i[2].trim();r+=`<h${y}>${O(I)}</h${y}>
`;continue}let u=w.match(/^\s*(\d+)\.\s+(.*)$/);if(u){g(),k(),s&&(r+=`</ul>
`,s=!1),a||(r+=`<ol>
`,a=!0),r+=`<li>${O(u[2])}</li>
`;continue}let T=w.match(/^\s*[-*+]\s+(.*)$/);if(T){g(),k(),a&&(r+=`</ol>
`,a=!1),s||(r+=`<ul>
`,s=!0),r+=`<li>${O(T[1])}</li>
`;continue}k(),p(),d.push(w)}return x(),g(),p(),k(),r.trim()}document.addEventListener("alpine:init",()=>{if(!window.TRANSPORT?.search)throw new Error("TRANSPORT.search not found");Alpine.store("search",{...window.TRANSPORT.search,clearLens(){this.lens_id=""}}),Alpine.store("threads",{...window.TRANSPORT.threads,setCurrentThread(e){this.currentThreadId=e},clearCurrentThread(){this.currentThreadId=null},setDeleting(e){this.deleting=e},isDeleting(e){return this.deleting&&this.currentThreadId===e}}),Alpine.magic("markdown",()=>K),Alpine.data("askButton",R),Alpine.data("responseMessage",P),Alpine.data("searchForm",z),Alpine.data("lensToken",F),Alpine.data("importPage",U),Alpine.data("threadMessagesPage",V),Alpine.data("threadsListPage",J),Alpine.data("deleteConfirmPopover",X)});})();
