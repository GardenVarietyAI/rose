(()=>{var U=()=>({disabled:!1,label:"Ask",async ask(){let e=this.$el.closest("form")?.querySelector('[name="q"]:not([disabled])')?.value?.trim()||"";if(!e||this.disabled)return;let t=this.$store?.search?.lens_ids,n=Array.isArray(t)&&t[0]||"",s=this.$store?.search?.factsheet_ids,r=Array.isArray(s)?s:[];this.disabled=!0;try{let u=await(await fetch("/v1/ask",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:e,lens_ids:n?[n]:[],factsheet_ids:r})})).json();if(!u?.thread_id)throw new Error("Missing thread_id");window.location.href="/v1/threads/"+u.thread_id}catch(i){alert("Error: "+(i?.message||String(i)))}finally{this.disabled=!1}}});var B=()=>({uuid:null,accepted:!1,collapsed:!1,expanded:!1,editing:!1,draft:"",original:"",editable:!1,saving:!1,init(){this.uuid=this.$el.dataset.uuid,this.accepted=this.$el.classList.contains("accepted");let e=this.$refs?.sourceContent;this.editable=!!e;let t=this.$el.querySelector(".message-content");if(t&&!this.editable){let s=t.textContent?.trim()||"";t.innerHTML=this.$markdown(s)}if(!this.editable)return;let n=e.content?.textContent;this.original=(n??t?.innerText??"").trimEnd(),this.draft=this.original},startEdit(){this.editable&&(this.editing=!0,this.draft=this.original,this.$nextTick(()=>this.$refs?.editor?.focus()))},cancelEdit(){this.editable&&(this.editing=!1,this.draft=this.original)},async saveEdit(){if(!(!this.editable||this.saving)){this.saving=!0;try{let e=await fetch(`/v1/messages/${this.uuid}/revisions`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({content:this.draft})});if(!e.ok)throw new Error(`HTTP ${e.status}`);window.location.reload()}catch(e){console.error("Error:",e),this.saving=!1}}},async toggleAccepted(){try{let e=await fetch(`/v1/messages/${this.uuid}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({accepted:!this.accepted})});if(!e.ok)throw new Error(`HTTP ${e.status}`);this.accepted=!this.accepted}catch(e){console.error("Error:",e)}}});var N,ue,oe,ce;function G(e){return{lang:e?.lang??N?.lang,message:e?.message,abortEarly:e?.abortEarly??N?.abortEarly,abortPipeEarly:e?.abortPipeEarly??N?.abortPipeEarly}}function le(e){return ue?.get(e)}function pe(e){return oe?.get(e)}function de(e,t){return ce?.get(e)?.get(t)}function S(e){let t=typeof e;return t==="string"?`"${e}"`:t==="number"||t==="bigint"||t==="boolean"?`${e}`:t==="object"||t==="function"?(e&&Object.getPrototypeOf(e)?.constructor?.name)??"null":t}function w(e,t,n,s,r){let i=r&&"input"in r?r.input:n.value,u=r?.expected??e.expects??null,c=r?.received??S(i),a={kind:e.kind,type:e.type,input:i,expected:u,received:c,message:`Invalid ${t}: ${u?`Expected ${u} but r`:"R"}eceived ${c}`,requirement:e.requirement,path:r?.path,issues:r?.issues,lang:s.lang,abortEarly:s.abortEarly,abortPipeEarly:s.abortPipeEarly},o=e.kind==="schema",f=r?.message??e.message??de(e.reference,a.lang)??(o?pe(a.lang):null)??s.message??le(a.lang);f!==void 0&&(a.message=typeof f=="function"?f(a):f),o&&(n.typed=!1),n.issues?n.issues.push(a):n.issues=[a]}function q(e){return{version:1,vendor:"valibot",validate:t=>e["~run"]({value:t},G())}}var fe=class extends Error{constructor(e){super(e[0].message),this.name="ValiError",this.issues=e}};function P(e,t){return{kind:"validation",type:"max_value",reference:P,async:!1,expects:`<=${e instanceof Date?e.toJSON():S(e)}`,requirement:e,message:t,"~run"(n,s){return!n.typed||n.value<=this.requirement||w(this,"value",n,s,{received:n.value instanceof Date?n.value.toJSON():S(n.value)}),n}}}function O(e,t){return{kind:"validation",type:"min_length",reference:O,async:!1,expects:`>=${e}`,requirement:e,message:t,"~run"(n,s){return n.typed&&n.value.length<this.requirement&&w(this,"length",n,s,{received:`${n.value.length}`}),n}}}function C(e,t){return{kind:"validation",type:"min_value",reference:C,async:!1,expects:`>=${e instanceof Date?e.toJSON():S(e)}`,requirement:e,message:t,"~run"(n,s){return!n.typed||n.value>=this.requirement||w(this,"value",n,s,{received:n.value instanceof Date?n.value.toJSON():S(n.value)}),n}}}function he(e,t,n){return typeof e.fallback=="function"?e.fallback(t,n):e.fallback}function ye(e,t,n){return typeof e.default=="function"?e.default(t,n):e.default}function j(e,t){return{kind:"schema",type:"array",reference:j,expects:"Array",async:!1,item:e,message:t,get"~standard"(){return q(this)},"~run"(n,s){let r=n.value;if(Array.isArray(r)){n.typed=!0,n.value=[];for(let i=0;i<r.length;i++){let u=r[i],c=this.item["~run"]({value:u},s);if(c.issues){let a={type:"array",origin:"value",input:r,key:i,value:u};for(let o of c.issues)o.path?o.path.unshift(a):o.path=[a],n.issues?.push(o);if(n.issues||(n.issues=c.issues),s.abortEarly){n.typed=!1;break}}c.typed||(n.typed=!1),n.value.push(c.value)}}else w(this,"type",n,s);return n}}}function R(e){return{kind:"schema",type:"boolean",reference:R,expects:"boolean",async:!1,message:e,get"~standard"(){return q(this)},"~run"(t,n){return typeof t.value=="boolean"?t.typed=!0:w(this,"type",t,n),t}}}function L(e){return{kind:"schema",type:"number",reference:L,expects:"number",async:!1,message:e,get"~standard"(){return q(this)},"~run"(t,n){return typeof t.value!="number"||isNaN(t.value)?w(this,"type",t,n):t.typed=!0,t}}}function D(e,t){return{kind:"schema",type:"object",reference:D,expects:"Object",async:!1,entries:e,message:t,get"~standard"(){return q(this)},"~run"(n,s){let r=n.value;if(r&&typeof r=="object"){n.typed=!0,n.value={};for(let i in this.entries){let u=this.entries[i];if(i in r||(u.type==="exact_optional"||u.type==="optional"||u.type==="nullish")&&u.default!==void 0){let c=i in r?r[i]:ye(u),a=u["~run"]({value:c},s);if(a.issues){let o={type:"object",origin:"value",input:r,key:i,value:c};for(let f of a.issues)f.path?f.path.unshift(o):f.path=[o],n.issues?.push(f);if(n.issues||(n.issues=a.issues),s.abortEarly){n.typed=!1;break}}a.typed||(n.typed=!1),n.value[i]=a.value}else if(u.fallback!==void 0)n.value[i]=he(u);else if(u.type!=="exact_optional"&&u.type!=="optional"&&u.type!=="nullish"&&(w(this,"key",n,s,{input:void 0,expected:`"${i}"`,path:[{type:"object",origin:"key",input:r,key:i,value:r[i]}]}),s.abortEarly))break}}else w(this,"type",n,s);return n}}}function A(e){return{kind:"schema",type:"string",reference:A,expects:"string",async:!1,message:e,get"~standard"(){return q(this)},"~run"(t,n){return typeof t.value=="string"?t.typed=!0:w(this,"type",t,n),t}}}function J(e,t,n){let s=e["~run"]({value:t},G(n));if(s.issues)throw new fe(s.issues);return s.value}function I(...e){return{...e[0],pipe:e,get"~standard"(){return q(this)},"~run"(t,n){for(let s of e)if(s.kind!=="metadata"){if(t.issues&&(s.kind==="schema"||s.kind==="transformation")){t.typed=!1;break}t.issues&&(n.abortEarly||n.abortPipeEarly)||(t=s["~run"](t,n))}return t}}}var me=D({content:A(),lens_ids:j(I(A(),O(1))),factsheet_ids:j(I(A(),O(1))),exact:R(),limit:I(L(),C(1),P(100))});function M(e){return J(me,e)}var ve=/(?:^|[^A-Za-z0-9-])([@#])([A-Za-z0-9-]*)/g;function X(e){let t=Object.entries(e||{}).map(([s,r])=>({lensId:r,atName:String(s||"").toLowerCase()})).filter(s=>s.atName),n=Object.fromEntries(Object.entries(e||{}).map(([s,r])=>[r,s]));return{lensOptions:t,idToAtName:n}}function W(e,t){let n={},s={},r={},i={},u=[];for(let[c,a]of Object.entries(e||{})){if(!c||!a)continue;let o=String(c).toLowerCase();n[o]=a;let f=t?.[c]||t?.[o]||"";s[o]=f,r[a]=o,i[a]=f,u.push({tag:o,factsheetId:a,title:s[o]})}return{tagOptions:u.sort((c,a)=>c.tag.localeCompare(a.tag)),tagToFactsheetId:n,tagToTitle:s,factsheetIdToTag:r,factsheetIdToTitle:i}}function Z({controller:e,lensOptions:t,tagOptions:n,previous:s}){if(!e)throw new Error("controller is required");let r=e.detectMention();if(!r)return{open:!1,query:"",options:t,index:0,mention:null};let i=r.query,u=r.type==="tag"?n.filter(f=>f.tag.startsWith(i)):t.filter(f=>f.atName.startsWith(i)),c=!!s?.open&&s?.query===i,a=u.length>0,o=Math.max(u.length-1,0);return{open:a,query:i,options:u,index:c?Math.min(s?.index??0,o):0,mention:r}}function V(e){let t=window.getSelection();if(!t||!t.rangeCount)return null;let n=t.getRangeAt(0),s=n.startContainer;if(!s||!e.contains(s))return null;let r=n.cloneRange();return r.selectNodeContents(e),r.setEnd(n.startContainer,n.startOffset),r.toString().length}function H(e,t){let n=window.getSelection();if(!n)return;let s=document.createRange(),r=e.firstChild;if(!r||r.nodeType!==Node.TEXT_NODE){s.selectNodeContents(e),s.collapse(!0),n.removeAllRanges(),n.addRange(s);return}s.setStart(r,Math.max(0,Math.min(t,r.textContent?.length||0))),s.collapse(!0),n.removeAllRanges(),n.addRange(s)}function Q(e){if(!e)throw new Error("editor is required");return{getText(){return e.textContent||""},setText(t,n=null){e.textContent=t||"",n!==null&&H(e,n)},getCaretOffset(){return V(e)},detectMention(){let t=e.textContent||"",n=V(e);if(n===null)return null;let s=t.slice(0,n),r=Array.from(s.matchAll(ve));if(r.length===0)return null;let i=r[r.length-1],u=i[0].startsWith("@")||i[0].startsWith("#")?0:1,c=i.index+u,a=c+i[0].length-u;return a!==n?null:{start:c,end:a,query:i[2].toLowerCase(),raw:i[0].slice(u),type:i[1]==="#"?"tag":"lens"}},replaceRange(t,n,s,r=null){let i=e.textContent||"",u=i.slice(0,t),c=i.slice(n),a=`${u}${s}${c}`,o=r??u.length+s.length;e.textContent=a,H(e,o)}}}function K(e,t){if(typeof e!="function")throw new Error("fn must be a function");let n=Number(t);if(!Number.isFinite(n)||n<0)throw new Error("delayMs must be a non-negative number");let s=null;return(...r)=>{s!==null&&clearTimeout(s),s=setTimeout(()=>{s=null,e(...r)},n)}}function ge(e){let t=JSON.stringify(e);return btoa(unescape(encodeURIComponent(t))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function ke(){let e=window.TRANSPORT?.search;return{exact:!!e?.exact,limit:typeof e?.limit=="number"?e.limit:10}}async function Y({payload:e,formAction:t,rootSelector:n="#search-root",updateUrl:s}){if(!e)throw new Error("payload is required");if(!t)throw new Error("formAction is required");let r=await fetch("/v1/search/fragment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!r.ok)throw new Error(`Search failed (HTTP ${r.status})`);let i=await r.text(),u=document.querySelector(n);if(!u)throw new Error(`Page missing ${n} element`);u.outerHTML=i;let c=ke(),a=e.lens_ids.length>0||e.factsheet_ids.length>0||e.exact!==c.exact||e.limit!==c.limit,o=s==="sq"?new URLSearchParams(window.location.search):new URLSearchParams;s||(e.content?o.set("q",e.content):o.delete("q")),a?o.set("sq",ge({lens_ids:e.lens_ids,factsheet_ids:e.factsheet_ids,exact:e.exact,limit:e.limit})):o.delete("sq");let f=o.toString()?`${t}?${o.toString()}`:t;window.history.replaceState({},"",f)}var ee=()=>({queryValue:"",settingsOpen:!1,submitting:!1,pendingSubmit:!1,pendingUpdateUrl:!1,mentionOpen:!1,mentionIndex:0,mentionQuery:"",mentionOptions:[],activeMention:null,lensOptions:[],tagOptions:[],idToAtName:{},factsheetIdToTag:{},factsheetIdToTitle:{},errorMessage:"",editor:null,commitContentDebounced:null,showError(e){this.errorMessage=e,setTimeout(()=>this.errorMessage="",5e3)},init(){let e=this.$store.search,t=e.content,n=e.lens_map,s=e.factsheet_map,r=e.factsheet_title_map;this.queryValue=t.replace(/^@\S+\s*/,"");let i=X(n);this.lensOptions=i.lensOptions,this.mentionOptions=i.lensOptions,this.idToAtName=i.idToAtName;let u=W(s,r);this.tagOptions=u.tagOptions,this.factsheetIdToTag=u.factsheetIdToTag,this.factsheetIdToTitle=u.factsheetIdToTitle,this.editor=Q(this.$refs?.editor),this.commitContentDebounced=K(c=>{this.$store.search.setContent(c)},200),this.$nextTick(()=>{this.seedFromTransport(),t||this.$refs?.editor?.focus()})},seedFromTransport(){if(!this.editor)return;this.editor.setText(this.queryValue);let e=this.$refs?.textarea;e&&(e.value=this.queryValue);let t=this.$refs?.lensSelect;t&&(t.value=this.$store.search.lens_ids[0]||""),this.$store.search.setContent(this.queryValue)},getQueryModelFromState(){let e=this.$store.search;return M({content:this.queryValue,lens_ids:e.lens_ids,factsheet_ids:e.factsheet_ids,exact:e.exact,limit:e.limit})},async runSearch({updateUrl:e}={}){if(this.submitting){this.pendingSubmit=!0,this.pendingUpdateUrl=this.pendingUpdateUrl||e;return}let t=this.$refs?.form;if(!t)throw new Error("Form ref not found");this.submitting=!0;try{let n=this.queryValue.trim();this.queryValue=n;let s=this.$refs?.textarea;s&&(s.value=n),this.$store.search.setContent(n);let r=this.getQueryModelFromState(),i={content:n,exact:r.exact,limit:r.limit,lens_ids:r.lens_ids,factsheet_ids:r.factsheet_ids};await Y({payload:i,formAction:t.action,updateUrl:e})}catch(n){let s=n instanceof Error?n.message:String(n);this.showError(`Search failed: ${s}`)}finally{if(this.submitting=!1,this.pendingSubmit){let n=this.pendingUpdateUrl;this.pendingSubmit=!1,this.pendingUpdateUrl=!1,await this.runSearch({updateUrl:n})}}},refreshResults(){this.runSearch({updateUrl:"sq"})},clearLensSelection(){this.$store.search.clearLens();let e=this.$refs?.lensSelect;e&&(e.value=""),this.refreshResults()},handleLensSelectChange(e){let t=e?.target?.value?.trim()||"";this.$store.search.setLensId(t),this.refreshResults()},removeFactsheet(e){this.$store.search.removeFactsheetId(e),this.refreshResults()},syncToStore(){if(!this.editor)throw new Error("Editor not initialized");let e=this.editor.getText();if(e!==this.queryValue){this.queryValue=e;let t=this.$refs?.textarea;t&&(t.value=e)}if(!this.commitContentDebounced)throw new Error("commitContentDebounced not initialized");this.commitContentDebounced(this.queryValue),this.updateMentionState()},updateMentionState(){if(!this.editor)return;let e=Z({controller:this.editor,lensOptions:this.lensOptions,tagOptions:this.tagOptions,previous:{open:this.mentionOpen,query:this.mentionQuery,index:this.mentionIndex}});this.mentionOpen=e.open,this.mentionQuery=e.query,this.mentionOptions=e.options,this.mentionIndex=e.index,this.activeMention=e.mention},selectMention(e=null){if(!this.editor||!this.mentionOpen||!this.mentionOptions.length)return;let t=this.activeMention||this.editor.detectMention();if(!t)return;let n=e||this.mentionOptions[this.mentionIndex];if(!n)return;if(t.type==="tag")this.$store.search.addFactsheetId(n.factsheetId);else{this.$store.search.setLensId(n.lensId);let r=this.$refs?.lensSelect;r&&(r.value=n.lensId)}this.editor.replaceRange(t.start,t.end," ",t.start+1),this.queryValue=this.editor.getText();let s=this.$refs?.textarea;s&&(s.value=this.queryValue),this.$store.search.setContent(this.queryValue),this.mentionOpen=!1,this.mentionQuery="",this.mentionOptions=this.lensOptions,this.mentionIndex=0,this.refreshResults()},handleEditorKeydown(e){if(!this.mentionOpen){e.key==="Enter"&&(e.preventDefault(),this.submit());return}if(e.key==="ArrowDown"){e.preventDefault();let t=Math.max(this.mentionOptions.length-1,0);this.mentionIndex=Math.min(this.mentionIndex+1,t);return}if(e.key==="ArrowUp"){e.preventDefault(),this.mentionIndex=Math.max(this.mentionIndex-1,0);return}if(e.key==="Enter"||e.key===" "){e.preventDefault();let t=this.mentionOptions[this.mentionIndex];this.selectMention(t);return}e.key==="Escape"&&(e.preventDefault(),this.mentionOpen=!1,this.mentionQuery="",this.mentionOptions=this.lensOptions,this.mentionIndex=0)},async submit(){await this.runSearch()}});var be={},te=()=>({preview:!1,importing:!1,complete:!1,threads:[],parseReport:null,selectedFormat:null,banner:{visible:!1,type:"",message:"",timeout:null},get currentValidator(){return be[this.selectedFormat]},handleFormatChange(){this.threads=[],this.parseReport=null,this.preview=!1,this.closeBanner(),this.$refs.fileInput&&(this.$refs.fileInput.value="")},showBanner(e,t){this.banner.visible=!0,this.banner.type=e,this.banner.message=t,this.banner.timeout&&clearTimeout(this.banner.timeout),this.banner.timeout=setTimeout(()=>{this.banner.visible=!1},5e3)},closeBanner(){this.banner.visible=!1,this.banner.timeout&&clearTimeout(this.banner.timeout)},get selectedCount(){return this.threads.filter(e=>e.selected).length},get totalMessageCount(){return this.threads.filter(e=>e.selected).reduce((e,t)=>e+1+t.assistantMessages.length,0)},get parseReportSummary(){if(!this.parseReport)return"";let e=this.parseReport,t=[];if(t.push(`${e.parsed} records parsed`),e.skipped>0){let n=[];e.errors.invalidJSON.length>0&&n.push(`${e.errors.invalidJSON.length} invalid JSON`),e.errors.emptyContent>0&&n.push(`${e.errors.emptyContent} empty content`),e.errors.validationErrors.length>0&&n.push(`${e.errors.validationErrors.length} validation errors`),t.push(`${e.skipped} skipped: ${n.join(", ")}`)}return t.join(", ")},handleFileSelect(e){let t=e.target.files?.[0];if(!t)return;let n=new FileReader;n.onload=s=>{try{let r=s.target.result,{threads:i,report:u}=this.currentValidator.parse(r);this.threads=i,this.parseReport=u,this.preview=!0,u.skipped>0&&this.showBanner("error",this.parseReportSummary)}catch(r){console.error("Parse error:",r),this.showBanner("error",`Failed to parse file: ${r.message}`)}},n.readAsText(t)},toggleAll(){let e=this.threads.every(t=>t.selected);this.threads.forEach(t=>t.selected=!e)},cancelImport(){this.preview=!1,this.threads=[],this.parseReport=null,this.closeBanner(),this.$refs.fileInput.value=""},async executeImport(){if(!(this.importing||this.selectedCount===0)){this.importing=!0;try{let e=[];for(let r of this.threads.filter(i=>i.selected)){e.push({thread_id:r.threadId,role:r.userMessage.role,content:r.userMessage.content,model:r.userMessage.model,created_at:r.userMessage.created_at,import_external_id:r.userMessage.uuid,meta:{imported_external_id:r.userMessage.uuid,imported_external_session_id:r.userMessage.sessionId,imported_external_created_at:r.userMessage.timestamp}});for(let i of r.assistantMessages)e.push({thread_id:r.threadId,role:i.role,content:i.content,model:i.model,created_at:i.created_at,import_external_id:i.uuid,meta:{imported_external_id:i.uuid,imported_external_session_id:i.sessionId,imported_external_created_at:i.timestamp}})}let t=await fetch("/v1/import/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({import_source:this.currentValidator.importSource,messages:e})});if(!t.ok)throw new Error("Could not import records.");let n=await t.json();this.preview=!1,this.complete=!0;let s=n.skipped_duplicates>0?`Imported ${n.imported} messages (skipped ${n.skipped_duplicates} duplicates)`:`Successfully imported ${n.imported} messages`;this.showBanner("success",s)}catch(e){console.error("Import error:",e),this.showBanner("error",`Failed to import: ${e.message}`),this.importing=!1}}}});var ne=()=>({pending:!1,assistantEventSource:null,jobPollTimeout:null,jobPollAttempt:0,createPlaceholder(e){let t=this.$refs.placeholderTemplate.content.cloneNode(!0),n=t.querySelector(".message");return n.dataset.tempId=e,t},parseHtmlElement(e){let t=document.createElement("template");return t.innerHTML=String(e).trim(),t.content.firstElementChild},cleanupAssistantStream(){this.assistantEventSource&&this.assistantEventSource.close(),this.assistantEventSource=null},cleanupJobPoll(){this.jobPollTimeout&&clearTimeout(this.jobPollTimeout),this.jobPollTimeout=null,this.jobPollAttempt=0},async pollJobStatus(e,t){try{let n=await fetch(`/v1/threads/${e}/activity`,{headers:{Accept:"application/json"}});if(!n.ok)return;if((await n.json())?.job_events?.[0]?.status==="failed"){let u=this.$refs.responses.querySelector(`[data-temp-id="${t}"]`);u&&u.remove(),this.cleanupJobPoll();return}this.jobPollAttempt+=1;let i=Math.min(1e3*Math.pow(2,this.jobPollAttempt),3e4);this.jobPollTimeout=setTimeout(()=>this.pollJobStatus(e,t),i)}catch(n){console.error("Error polling job status:",n),this.jobPollAttempt+=1;let s=Math.min(1e3*Math.pow(2,this.jobPollAttempt),3e4);this.jobPollTimeout=setTimeout(()=>this.pollJobStatus(e,t),s)}},startEventStreams(e,t,{afterAssistantUuid:n=null}={}){if(this.assistantEventSource)return;let s=new URL(`/v1/threads/${e}/stream`,window.location.origin);s.searchParams.set("role","assistant"),n&&s.searchParams.set("after_uuid",n),this.assistantEventSource=new EventSource(s),this.assistantEventSource.addEventListener("assistant",async r=>{try{let u=JSON.parse(r?.data||"{}")?.uuid;if(!u)return;let c=await fetch(`/v1/messages/${u}/fragment`,{headers:{Accept:"text/html"}});if(!c.ok)return;let a=await c.text(),o=this.parseHtmlElement(a),f=this.$refs.responses.querySelector(`[data-temp-id="${t}"]`);f&&o&&f.replaceWith(o),this.cleanupJobPoll()}finally{this.cleanupAssistantStream()}}),this.assistantEventSource.addEventListener("error",()=>this.cleanupAssistantStream()),this.jobPollAttempt=0,this.pollJobStatus(e,t)},init(){if(!this.$refs.responses||this.$refs.responses.children.length)return;let e=this.$el?.dataset?.threadId;if(!e)return;let t="initial",n=this.createPlaceholder(t);this.$refs.responses.prepend(n),this.startEventStreams(e,t)},async regenerate(e){if(this.pending)return;let t=e?.currentTarget,n=t?.dataset?.threadId,s=t?.dataset?.model,r=t?.dataset?.promptContent;if(!n||!r)return;this.pending=!0;let i=Math.random().toString(36).slice(2,10),u=this.createPlaceholder(i);this.$refs.responses.prepend(u);try{let a=this.$refs.responses.querySelector(".message[data-uuid]")?.dataset?.uuid||null,o=await fetch("/v1/ask",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:r,thread_id:n,lens_ids:this.$refs?.lensSelect?.value?[this.$refs.lensSelect.value]:[],factsheet_ids:[],model:s})});if(!o.ok)throw new Error(`Ask HTTP ${o.status}`);this.startEventStreams(n,i,{afterAssistantUuid:a})}catch(c){console.error("Error:",c);let a=this.$refs.responses.querySelector(`[data-temp-id="${i}"]`);a&&a.remove()}finally{this.pending=!1}}});var se=()=>({}),re=e=>({open(){this.$store.threads.setCurrentThread(e),this.$refs.popover.showPopover()},close(){this.$refs.popover.hidePopover(),this.$store.threads.clearCurrentThread()},get isDeleting(){return this.$store.threads.isDeleting(e)},async confirmDelete(){this.$store.threads.setDeleting(!0);try{let t=await fetch(`/v1/threads/${e}`,{method:"DELETE"});if(!t.ok){let n=await t.json().catch(()=>({}));throw new Error(n.detail||`HTTP ${t.status}`)}window.location.reload()}catch(t){console.error("Delete error:",t),alert(`Failed to delete thread: ${t.message}`),this.$store.threads.setDeleting(!1)}}});function ie(e,t){if(typeof e!="string")throw new TypeError("highlightCode expects a string");let n=xe(e,t),s=[],r=[],i=[],u=[],c=[],a=l=>{if(!Number.isInteger(l)||l<0)throw new TypeError("encodeIndex expects a non-negative integer");let d="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",y=d.length,h=l,$="";do $=d[h%y]+$,h=Math.floor(h/y);while(h>0);return $},o=l=>`HLSTR${a(l)}`,f=l=>`HLCMT${a(l)}`,k=l=>`HLKW${a(l)}`,v=l=>`HLBI${a(l)}`,g=l=>`HLNUM${a(l)}`,b=l=>{let d="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",y=d.length,h=0;for(let $ of String(l)){let z=d.indexOf($);if(z===-1)throw new Error("Invalid placeholder encoding");h=h*y+z}return h},p=e;n==="python"?(p=p.replace(/#[^\n]*/g,l=>{let d=r.length;return r.push(l),f(d)}),p=p.replace(/'''[\s\S]*?'''|"""[\s\S]*?"""/g,l=>{let d=s.length;return s.push(l),o(d)}),p=p.replace(/'([^'\\]|\\.)*?'|"([^"\\]|\\.)*?"/g,l=>{let d=s.length;return s.push(l),o(d)})):n==="sql"?(p=p.replace(/--[^\n]*/g,l=>{let d=r.length;return r.push(l),f(d)}),p=p.replace(/'([^'\\]|\\.)*?'/g,l=>{let d=s.length;return s.push(l),o(d)})):(p=p.replace(/\/\/[^\n]*/g,l=>{let d=r.length;return r.push(l),f(d)}),p=p.replace(/\/\*[\s\S]*?\*\//g,l=>{let d=r.length;return r.push(l),f(d)}),p=p.replace(/'([^'\\]|\\.)*?'|"([^"\\]|\\.)*?"|`([^`\\]|\\.)*?`/g,l=>{let d=s.length;return s.push(l),o(d)})),p=F(p);let x=l=>l.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),m=we(n);if(m.length>0){let l=n==="sql"?"gi":"g",d=new RegExp(`\\b(${m.map(x).join("|")})\\b`,l);p=p.replace(d,y=>{let h=i.length;return i.push(y),k(h)})}let _=Ee(n);if(_.length>0){let l=n==="sql"?"gi":"g",d=new RegExp(`\\b(${_.map(x).join("|")})\\b`,l);p=p.replace(d,y=>{let h=u.length;return u.push(y),v(h)})}return p=p.replace(/\b\d+(\.\d+)?\b/g,l=>{let d=c.length;return c.push(l),g(d)}),p=p.replace(/\u0001HLSTR([A-Za-z]+)\u0001/g,(l,d)=>{let y=b(d),h=s[y];if(h===void 0)throw new Error("Invalid string placeholder index");return`<span class="hl-str">${F(h)}</span>`}),p=p.replace(/\u0001HLCMT([A-Za-z]+)\u0001/g,(l,d)=>{let y=b(d),h=r[y];if(h===void 0)throw new Error("Invalid comment placeholder index");return`<span class="hl-cmt">${F(h)}</span>`}),p=p.replace(/\u0001HLNUM([A-Za-z]+)\u0001/g,(l,d)=>{let y=b(d),h=c[y];if(h===void 0)throw new Error("Invalid number placeholder index");return`<span class="hl-num">${h}</span>`}),p=p.replace(/\u0001HLBI([A-Za-z]+)\u0001/g,(l,d)=>{let y=b(d),h=u[y];if(h===void 0)throw new Error("Invalid builtin placeholder index");return`<span class="hl-bi">${h}</span>`}),p=p.replace(/\u0001HLKW([A-Za-z]+)\u0001/g,(l,d)=>{let y=b(d),h=i[y];if(h===void 0)throw new Error("Invalid keyword placeholder index");return`<span class="hl-kw">${h}</span>`}),p}function F(e){if(typeof e!="string")throw new TypeError("escapeHtml expects a string");return e.replace(/[&<>"']/g,t=>t==="&"?"&amp;":t==="<"?"&lt;":t===">"?"&gt;":t==='"'?"&quot;":"&apos;")}function xe(e,t){if(t){let n=t.toLowerCase();return n==="js"||n==="javascript"||n==="typescript"||n==="ts"?"javascript":n==="py"||n==="python"?"python":n==="sql"||n==="postgres"||n==="postgresql"||n==="mysql"?"sql":n==="go"||n==="golang"?"go":n==="rs"||n==="rust"?"rust":n==="sh"||n==="bash"||n==="shell"?"shell":n}return/\b(def|class)\s+\w+[\(:]/.test(e)?"python":/\b(const|let|var|function)\s+\w+/.test(e)?"javascript":/^\s*(SELECT|INSERT|UPDATE|DELETE|CREATE|ALTER|DROP)\b/mi.test(e)?"sql":/\bfn\s+\w+\(/.test(e)?"rust":/\bfunc\s+\w+\(/.test(e)?"go":"generic"}function we(e){let t={python:["def","class","if","else","elif","for","while","return","import","from","as","try","except","finally","with","lambda","yield","async","await","raise","pass","break","continue","in","is","not","and","or"],javascript:["function","const","let","var","if","else","for","while","return","import","export","default","class","extends","async","await","yield","typeof","new","delete","this","super","static","try","catch","finally","throw","break","continue","switch","case"],sql:["SELECT","FROM","WHERE","JOIN","INNER","LEFT","RIGHT","OUTER","ON","INSERT","INTO","VALUES","UPDATE","SET","DELETE","CREATE","TABLE","ALTER","DROP","INDEX","ORDER","BY","GROUP","HAVING","LIMIT","OFFSET","AS","AND","OR","NOT","IN","LIKE","BETWEEN"],go:["func","package","import","var","const","type","struct","interface","if","else","for","range","return","defer","go","chan","select","case","switch","break","continue"],rust:["fn","let","mut","const","static","struct","enum","impl","trait","type","if","else","match","for","while","loop","return","break","continue","use","mod","pub","crate"],shell:["if","then","else","elif","fi","for","while","do","done","case","esac","function","return","exit","export","source"],generic:[]};return t[e]||t.generic}function Ee(e){let t={python:["True","False","None","self","str","int","float","bool","list","dict","tuple","set","len","range","print","open","type","isinstance","super","__init__","__name__"],javascript:["true","false","null","undefined","NaN","Infinity","console","window","document","Array","Object","String","Number","Boolean","Math","Date","Promise","JSON"],sql:["NULL","TRUE","FALSE","COUNT","SUM","AVG","MIN","MAX","DISTINCT","EXISTS"],go:["true","false","nil","make","new","len","cap","append","copy","delete","panic","recover"],rust:["true","false","None","Some","Ok","Err","Vec","String","Option","Result","println","panic"],shell:["echo","cd","ls","pwd","cat","grep","sed","awk","find","chmod","chown"],generic:["true","false","null","undefined"]};return t[e]||t.generic}function E(e){if(typeof e!="string")throw new TypeError("escapeHtml expects a string");return e.replace(/[&<>"']/g,t=>t==="&"?"&amp;":t==="<"?"&lt;":t===">"?"&gt;":t==='"'?"&quot;":"&#39;")}function T(e){if(typeof e!="string")throw new TypeError("parseInline expects a string");let t=[],n=[],s=[],r=c=>`ROSECODE${c}`,i=c=>`ROSELINK${c}`,u=c=>`ROSEAUTOLINK${c}`;return e=e.replace(/`([^`]*?)`/g,(c,a)=>{let o=t.length;return t.push(E(a)),r(o)}),e=e.replace(/\[([^\]]+)\]\(([^)]+)\)/g,(c,a,o)=>{let f=o.trim();if(!(/^(https?|mailto|tel):/i.test(f)||/^[/.#]/.test(f)))return a;let v=n.length,g=E(a),b=E(f);return n.push(`<a href="${b}" target="_blank" rel="noopener noreferrer">${g}</a>`),i(v)}),e=e.replace(/\bhttps?:\/\/[^\s<>"']+/g,c=>{let a=c,o="";for(;/[),.;:!?\\\]]$/.test(a);)o=a.slice(-1)+o,a=a.slice(0,-1);if(!a)return E(c);let f=s.length,k=E(a);return s.push(`<a href="${k}" target="_blank" rel="noopener noreferrer">${k}</a>${E(o)}`),u(f)}),e=E(e),e=e.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),e=e.replace(/__([^_]+)__/g,"<strong>$1</strong>"),e=e.replace(/\*([^*]+)\*/g,"<em>$1</em>"),e=e.replace(/_([^_]+)_/g,"<em>$1</em>"),e=e.replace(/\u0001ROSELINK(\d+)\u0001/g,(c,a)=>{let o=n[Number(a)];if(o===void 0)throw new Error("Invalid link placeholder index");return o}),e=e.replace(/\u0001ROSEAUTOLINK(\d+)\u0001/g,(c,a)=>{let o=s[Number(a)];if(o===void 0)throw new Error("Invalid auto-link placeholder index");return o}),e=e.replace(/\u0001ROSECODE(\d+)\u0001/g,(c,a)=>{let o=t[Number(a)];if(o===void 0)throw new Error("Invalid code placeholder index");return`<code>${o}</code>`}),e}function ae(e){if(typeof e!="string")throw new TypeError("markdownToHtml expects a string");let t=1e5;if(e.length>t){let x=e.slice(0,t),m=`<div class="markdown-error">Content exceeds ${t} characters, showing truncated...`;return m+=`</div><pre>${E(x)}</pre>`,m}e=e.replace(/\r\n?/g,`
`);let n=e.split(`
`),s="",r=!1,i=!1,u=!1,c=!1,a=[],o=[],f="",k=[];function v(){a.length>0&&(s+=`<p>${T(a.join(" "))}</p>
`,a=[])}function g(){u&&(s+=`<blockquote>${o.join(`<br />
`)}</blockquote>
`,o=[],u=!1)}function b(){if(!c)return;let x=k.join(`
`),m=f?` class="language-${E(f)}"`:"",_=ie(x,f);s+=`<pre><code${m}>${_}</code></pre>
`,f="",k=[],c=!1}function p(){r&&(s+=`</ul>
`,r=!1),i&&(s+=`</ol>
`,i=!1)}for(let x=0;x<n.length;x++){let m=n[x],_=m.match(/^```([^\s`]+)?\s*$/);if(_){v(),p(),g(),c?b():(c=!0,f=(_[1]||"").trim(),k=[]);continue}if(c){k.push(m);continue}if(!m.trim()){v(),p(),g();continue}if(/^(\-\-\-|\*\*\*|___)\s*$/.test(m.trim())){v(),p(),g(),s+=`<hr />
`;continue}if(/^\s*>\s?/.test(m)){v(),p(),u||(u=!0);let h=m.replace(/^\s*>\s?/,"");o.push(T(h));continue}let l=m.match(/^(#{1,6})\s+(.*)$/);if(l){v(),p(),g();let h=l[1].length,$=l[2].trim();s+=`<h${h}>${T($)}</h${h}>
`;continue}let d=m.match(/^\s*(\d+)\.\s+(.*)$/);if(d){v(),g(),r&&(s+=`</ul>
`,r=!1),i||(s+=`<ol>
`,i=!0),s+=`<li>${T(d[2])}</li>
`;continue}let y=m.match(/^\s*[-*+]\s+(.*)$/);if(y){v(),g(),i&&(s+=`</ol>
`,i=!1),r||(s+=`<ul>
`,r=!0),s+=`<li>${T(y[1])}</li>
`;continue}g(),p(),a.push(m)}return b(),v(),p(),g(),s.trim()}document.addEventListener("alpine:init",()=>{if(!window.TRANSPORT?.search)throw new Error("TRANSPORT.search not found");Alpine.store("search",{...window.TRANSPORT.search,_commit(e){let t=M(e);this.content=t.content,this.lens_ids=t.lens_ids,this.factsheet_ids=t.factsheet_ids,this.exact=t.exact,this.limit=t.limit},applyQueryModel(e){this._commit(e)},setContent(e){this._commit({...this,content:String(e??"")})},setLensId(e){let t=String(e??"").trim();this._commit({...this,lens_ids:t?[t]:[]})},clearLens(){this.setLensId("")},addFactsheetId(e){let t=String(e??"").trim();t&&(this.factsheet_ids.includes(t)||this._commit({...this,factsheet_ids:[...this.factsheet_ids,t]}))},removeFactsheetId(e){let t=String(e??"").trim();t&&this._commit({...this,factsheet_ids:this.factsheet_ids.filter(n=>n!==t)})},setFactsheetIds(e){let t=Array.from(new Set((e??[]).map(n=>String(n).trim()).filter(Boolean)));this._commit({...this,factsheet_ids:t})},setExact(e){this._commit({...this,exact:!!e})},setLimit(e){this._commit({...this,limit:Number(e)})}}),Alpine.store("threads",{...window.TRANSPORT.threads,setCurrentThread(e){this.currentThreadId=e},clearCurrentThread(){this.currentThreadId=null},setDeleting(e){this.deleting=e},isDeleting(e){return this.deleting&&this.currentThreadId===e}}),Alpine.magic("markdown",()=>ae),Alpine.data("askButton",U),Alpine.data("responseMessage",B),Alpine.data("searchForm",ee),Alpine.data("importPage",te),Alpine.data("threadMessagesPage",ne),Alpine.data("threadsListPage",se),Alpine.data("deleteConfirmPopover",re)});})();
