(()=>{var M=()=>({disabled:!1,label:"Ask",async ask(){let t=this.$el.closest("form")?.querySelector('[name="q"]:not([disabled])')?.value?.trim()||"";if(!(!t||this.disabled)){this.disabled=!0;try{let o=this.$el.closest("form")?.querySelector('select[name="lens_id"]')?.value?.trim()||"",i=await(await fetch("/v1/ask",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:t,lens_id:o||void 0})})).json();if(!i?.thread_id)throw new Error("Missing thread_id");let l=o?`?lens_id=${encodeURIComponent(o)}`:"";window.location.href="/v1/threads/"+i.thread_id+l}catch(e){alert("Error: "+(e?.message||String(e)))}finally{this.disabled=!1}}}});var P=()=>({uuid:null,accepted:!1,collapsed:!1,expanded:!1,editing:!1,draft:"",original:"",editable:!1,saving:!1,init(){this.uuid=this.$el.dataset.uuid,this.accepted=this.$el.classList.contains("accepted");let t=this.$refs?.sourceContent;this.editable=!!t;let e=this.$el.querySelector(".message-content");if(e&&!this.editable){let o=e.textContent?.trim()||"";e.innerHTML=this.$markdown(o)}if(!this.editable)return;let n=t.content?.textContent;this.original=(n??e?.innerText??"").trimEnd(),this.draft=this.original},startEdit(){this.editable&&(this.editing=!0,this.draft=this.original,this.$nextTick(()=>this.$refs?.editor?.focus()))},cancelEdit(){this.editable&&(this.editing=!1,this.draft=this.original)},async saveEdit(){if(!(!this.editable||this.saving)){this.saving=!0;try{let t=await fetch(`/v1/messages/${this.uuid}/revisions`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({content:this.draft})});if(!t.ok)throw new Error(`HTTP ${t.status}`);window.location.reload()}catch(t){console.error("Error:",t),this.saving=!1}}},async toggleAccepted(){try{let t=await fetch(`/v1/messages/${this.uuid}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({accepted:!this.accepted})});if(!t.ok)throw new Error(`HTTP ${t.status}`);this.accepted=!this.accepted}catch(t){console.error("Error:",t)}}});function I(t){let e=[];for(let n of t)if(n.type==="text")if(e.length>0&&e[e.length-1].type==="text"){let o=e[e.length-1];o.value+=n.value}else e.push({type:"text",value:n.value});else e.push(n);return(e.length===0||e[e.length-1].type!=="text")&&e.push({type:"text",value:""}),e}function R(t){let e=[];for(let n of t)n.type==="text"&&n.value&&e.push(n.value);return e.join("")}function _(t,e=[]){let n=[];for(let o of e)n.push({type:"lens",lensId:o.lensId,atName:o.atName});return t&&n.push({type:"text",value:t}),I(n)}function O(t,e){let n=Math.max(0,Math.min(e.tokenIndex,t.length-1)),o=t[n],s=o.type==="text"?o.value.length:0,i=Math.max(0,Math.min(e.offset,s));return{tokenIndex:n,offset:i}}function q(t,e){let{tokens:n,caret:o}=t;if(e.type==="insertText"){let{at:s,text:i}=e,l=[...n],f=l[s.tokenIndex];if(f.type!=="text")throw new Error("Cannot insert text into non-text token");let u=f.value.slice(0,s.offset),r=f.value.slice(s.offset);l[s.tokenIndex]={type:"text",value:u+i+r};let a=I(l),h={tokenIndex:s.tokenIndex,offset:s.offset+i.length},d=O(a,h),x={type:"deleteRange",from:s,to:{tokenIndex:s.tokenIndex,offset:s.offset+i.length}};return{buffer:{tokens:a,caret:d},inverse:x}}if(e.type==="deleteRange"){let{from:s,to:i}=e,l=[...n],f=[];if(s.tokenIndex===i.tokenIndex){let p=l[s.tokenIndex];if(p.type!=="text")throw new Error("Cannot delete from non-text token");let y=p.value.slice(0,s.offset),T=p.value.slice(s.offset,i.offset),v=p.value.slice(i.offset);l[s.tokenIndex]={type:"text",value:y+v};let N=I(l),E={tokenIndex:s.tokenIndex,offset:s.offset},S=O(N,E);return{buffer:{tokens:N,caret:S},inverse:{type:"insertText",at:s,text:T}}}let u=l[s.tokenIndex],r=l[i.tokenIndex];if(u.type!=="text"||r.type!=="text")throw new Error("Cross-token delete requires text tokens at boundaries");let a=u.value.slice(0,s.offset),h=u.value.slice(s.offset),d=r.value.slice(0,i.offset),x=r.value.slice(i.offset);for(let p=s.tokenIndex;p<=i.tokenIndex;p++)f.push(l[p]);f[0]={type:"text",value:h},f[f.length-1]={type:"text",value:d};let m=[];for(let p=0;p<f.length;p++){let y=f[p];if(y.type==="text")if(m.length>0&&m[m.length-1].type==="text"){let T=m[m.length-1];m[m.length-1]={type:"text",value:T.value+y.value}}else m.push(y);else m.push(y)}for(let p=i.tokenIndex;p>=s.tokenIndex;p--)l.splice(p,1);l.splice(s.tokenIndex,0,{type:"text",value:a+x});let w=I(l),g={tokenIndex:s.tokenIndex,offset:s.offset},k=O(w,g);return{buffer:{tokens:w,caret:k},inverse:{type:"insertTokens",at:s,tokens:m}}}if(e.type==="replaceToken"){let{index:s,token:i}=e,l=[...n],f=l[s];l[s]=i;let u=I(l),r=O(u,o);return{buffer:{tokens:u,caret:r},inverse:{type:"replaceToken",index:s,token:f}}}if(e.type==="insertTokens"){let{at:s,tokens:i}=e,l=[...n],f=l[s.tokenIndex];if(f.type!=="text")throw new Error("Cannot insert tokens into non-text token");let u=f.value.slice(0,s.offset),r=f.value.slice(s.offset),a=[...i];if(a.length>0){let c=a[0];c.type==="text"?a[0]={type:"text",value:u+c.value}:u&&a.unshift({type:"text",value:u});let p=a[a.length-1];p.type==="text"?a[a.length-1]={type:"text",value:p.value+r}:r&&a.push({type:"text",value:r})}else a.push({type:"text",value:u+r});l.splice(s.tokenIndex,1,...a);let h=I(l),d=i[i.length-1],x=0,m=0;if(d&&d.type!=="text"){let c=0;for(let E=0;E<s.tokenIndex;E++){let S=n[E];S.type==="text"&&(c+=S.value.length)}c+=s.offset;let p=c;for(let E of i)E.type==="text"&&(p+=E.value.length);let y=0;for(let E of i)E.type!=="text"&&y++;let T=0,v=0,N=!1;for(let E=0;E<h.length;E++){let S=h[E];if(S.type==="text"){if(!N&&T>=c&&(N=!0),p<=T+S.value.length){x=E,m=p-T;break}T+=S.value.length}else if(N&&(v++,v===y)){x=E+1,m=0;break}}}else{let c=u.length;for(let y of i)y.type==="text"&&(c+=y.value.length);let p=0;for(let y=0;y<h.length;y++){let T=h[y];if(T.type==="text"){if(c<=p+T.value.length){x=y,m=c-p;break}p+=T.value.length}}}let g=O(h,{tokenIndex:x,offset:m});return{buffer:{tokens:h,caret:g},inverse:{type:"deleteRange",from:s,to:g}}}throw new Error(`Unknown op type: ${e.type}`)}function C(t){let e=document.createElement("div");return e.textContent=t||"",e.textContent||""}function L(t,e){e.textContent="";let n=new Map,o=0;for(let s=0;s<t.length;s++){let i=t[s];if(i.type==="lens"){let l=document.createElement("span");l.setAttribute("x-data",`lensToken('${i.lensId}', '${i.atName}')`),l.setAttribute("x-on:click","removeLens()"),l.setAttribute("data-token","lens"),e.appendChild(l),n.set(s,{node:l,textStart:o,textEnd:o})}else if(i.type==="text"){let l=document.createTextNode(C(i.value));e.appendChild(l),n.set(s,{node:l,textStart:o,textEnd:o+i.value.length}),o+=i.value.length}}return n}function j(t,e,n){let o=e.get(t.tokenIndex);if(!o)return null;if(o.node.nodeType===Node.TEXT_NODE)return{node:o.node,offset:t.offset};if(t.offset===0)return{node:n,offset:Array.from(n.childNodes).indexOf(o.node)};let s=t.tokenIndex+1,i=e.get(s);return i?{node:n,offset:Array.from(n.childNodes).indexOf(i.node)}:{node:n,offset:n.childNodes.length}}function A(t,e,n,o){for(let[s,i]of n.entries())if(i.node===t)return t.nodeType===Node.TEXT_NODE?{tokenIndex:s,offset:Math.min(e,i.textEnd-i.textStart)}:{tokenIndex:s,offset:0};if(t===o){let s=Array.from(o.childNodes);if(e>=s.length){let l=n.size-1,f=n.get(l);return f&&f.node.nodeType===Node.TEXT_NODE?{tokenIndex:l,offset:f.textEnd-f.textStart}:{tokenIndex:l,offset:0}}let i=s[e];for(let[l,f]of n.entries())if(f.node===i)return{tokenIndex:l,offset:0}}return{tokenIndex:n.size-1,offset:0}}var F=/(?:^|[^A-Za-z0-9-])@([A-Za-z0-9-]*)/g;function B(t,e){let n="",o=[],s=0,i=-1;for(let d=0;d<t.length;d++){let x=t[d];if(x.type==="text"){let m=n.length;n+=x.value,o.push({tokenIndex:d,startChar:m,endChar:n.length}),d<e.tokenIndex?s+=x.value.length:d===e.tokenIndex&&(s+=e.offset,i=o.length-1)}else o.push({tokenIndex:d,startChar:n.length,endChar:n.length}),d<e.tokenIndex&&(i=o.length-1)}if(i===-1||n.length===0)return null;let l=n.slice(0,s),f=Array.from(l.matchAll(F));if(f.length===0)return null;let u=f[f.length-1],r=u[0].startsWith("@")?0:1,a=u.index+r,h=a+u[0].length-r;if(h!==s)return null;for(let d of o)if(a>=d.startChar&&a<d.endChar)return h>d.endChar?null:{tokenIndex:d.tokenIndex,startOffset:a-d.startChar,endOffset:h-d.startChar,query:u[1].toLowerCase(),raw:u[0].slice(r)};return null}function D(t){let e=t,n={tokens:_(""),caret:{tokenIndex:0,offset:0}},o=null,s=!1,i=()=>{if(!e||!o||document.activeElement!==e)return;let r=j(n.caret,o,e);if(!r)return;let a=window.getSelection();if(!a)return;let h=document.createRange();h.setStart(r.node,r.offset),h.collapse(!0),a.removeAllRanges(),a.addRange(h)},l=()=>{if(!e||!o)return;let r=window.getSelection();if(!r||!r.rangeCount)return;let a=r.getRangeAt(0);n.caret=A(a.startContainer,a.startOffset,o,e)},f=()=>{if(!e)return;let r=[],a=new Map,h=0,d=0,x=!1;for(let c of e.childNodes){if(c.nodeType===Node.ELEMENT_NODE&&c.dataset?.token==="lens"){r.push({type:"lens",lensId:c.dataset.lensId,atName:c.dataset.atName}),a.set(d++,{node:c,textStart:h,textEnd:h});continue}if(c.nodeType===Node.TEXT_NODE){let p=c.textContent||"";r.push({type:"text",value:p}),a.set(d++,{node:c,textStart:h,textEnd:h+p.length}),h+=p.length;continue}c.nodeType===Node.ELEMENT_NODE&&c.tagName==="BR"&&(x=!0)}let m=r.some((c,p)=>c.type==="text"&&p>0&&r[p-1].type==="text"),w=r.length>0&&r[r.length-1].type==="lens";(m||w||x)&&(x=!0);let g=n.caret,k=window.getSelection();if(k&&k.rangeCount){let c=k.getRangeAt(0);g=A(c.startContainer,c.startOffset,a,e)}if(x){let c=I(r);g=O(c,g),n={tokens:c,caret:g},u()}else{let c=I(r);g=O(c,g),n={tokens:c,caret:g},o=a}},u=()=>{if(!(!e||s)){s=!0;try{o=L(n.tokens,e),i(),window.Alpine&&window.Alpine.initTree(e)}finally{s=!1}}};return{getBuffer(){return n},setBuffer(r){n=r,u()},loadFromQuery(r,a){let h=[];a?.lensId&&a?.atName&&h.push({lensId:a.lensId,atName:a.atName});let d=_(r,h),x=d.length-1,m=d[x];n={tokens:d,caret:{tokenIndex:x,offset:m?.type==="text"?m.value.length:0}},u()},syncFromDOM(){f()},syncBufferOnly(){if(!e)return;let r=[],a=new Map,h=0,d=0;for(let c of e.childNodes)if(c.nodeType===Node.ELEMENT_NODE&&c.dataset?.token==="lens")r.push({type:"lens",lensId:c.dataset.lensId,atName:c.dataset.atName}),a.set(d++,{node:c,textStart:h,textEnd:h});else if(c.nodeType===Node.TEXT_NODE){let p=c.textContent||"";r.push({type:"text",value:p}),a.set(d++,{node:c,textStart:h,textEnd:h+p.length}),h+=p.length}r.length===0&&(r.push({type:"text",value:""}),a.set(0,{node:null,textStart:0,textEnd:0}));let x=window.getSelection(),m={tokenIndex:0,offset:0};if(x&&x.rangeCount){let c=x.getRangeAt(0);m=A(c.startContainer,c.startOffset,a,e)}let w=r.length-1;m.tokenIndex=Math.max(0,Math.min(m.tokenIndex,w));let g=r[m.tokenIndex],k=g?.type==="text"?g.value.length:0;m.offset=Math.max(0,Math.min(m.offset,k)),n={tokens:r,caret:m},o=a},serialize(){return R(n.tokens)},detectMention(){return B(n.tokens,n.caret)},insertLensToken(r,a,h){if(!e)return;let d=window.getSelection();if(!d||!d.rangeCount)return;let x=o.get(r.tokenIndex);if(!x||!x.node)return;let m=x.node,w=m.textContent||"",g=w.slice(0,r.startOffset),k=w.slice(r.endOffset),c=document.createElement("span");c.setAttribute("x-data",`lensToken('${a}', '${h}')`),c.setAttribute("x-on:click","removeLens()"),c.setAttribute("data-token","lens");let p=m.parentNode;if(!p)return;if(g){let v=document.createTextNode(g);p.insertBefore(v,m)}if(p.insertBefore(c,m),k){let v=document.createTextNode(k);p.insertBefore(v,m)}else{let v=document.createTextNode(" ");p.insertBefore(v,m)}p.removeChild(m),window.Alpine&&window.Alpine.initTree(c);let y=document.createRange(),T=c.nextSibling;T&&T.nodeType===Node.TEXT_NODE&&(y.setStart(T,0),y.collapse(!0),d.removeAllRanges(),d.addRange(y)),this.syncBufferOnly()},applyOperation(r){l();let a=q(n,r);return n=a.buffer,u(),a.inverse},removeLens(r){if(!e)return;let a=e.querySelector(`[data-token="lens"][data-lens-id="${r}"]`);!a||!a.parentNode||(a.parentNode.removeChild(a),this.syncBufferOnly())},placeCaretAtEnd(){if(!e)return;let r=window.getSelection();if(!r)return;let a=e.lastChild;if(!a)return;let h=document.createRange();a.nodeType===Node.TEXT_NODE?h.setStart(a,a.textContent?.length||0):h.setStartAfter(a),h.collapse(!0),r.removeAllRanges(),r.addRange(h),this.syncBufferOnly()},onInput(r){e&&e.addEventListener("input",()=>{l(),r()})},destroy(){o=null}}}var z=()=>({queryValue:"",settingsOpen:!1,submitting:!1,mentionOpen:!1,mentionIndex:0,mentionQuery:"",mentionOptions:[],lensOptions:[],idToAtName:{},errorMessage:"",controller:null,showError(t){this.errorMessage=t,setTimeout(()=>this.errorMessage="",5e3)},init(){let t=this.$store.search.query||"",e=this.$store.search.lens_map||{};this.queryValue=t.replace(/^@\S+\s*/,""),this.buildLensState(e),this.controller=D(this.$refs?.editor),this.$watch("queryValue",n=>{this.$store.search.query=n}),this.$watch("$store.search.lens_id",(n,o)=>{let s=this.$refs?.lensSelect;s&&(s.value=n),o!==void 0&&this.controller.removeLens(o),this.syncFromStore(),o!==void 0&&this.controller&&document.activeElement===this.$refs?.editor&&this.controller.placeCaretAtEnd()}),this.$nextTick(()=>{this.syncFromStore(),t||this.$refs?.editor?.focus()})},syncFromStore(){if(!this.controller)return;this.controller.loadFromQuery(this.queryValue,this.getSelectedLens());let t=this.$refs?.textarea;t&&(t.value=this.queryValue)},syncToStore(){if(!this.controller)throw new Error("Buffer controller not initialized");this.controller.syncBufferOnly();let t=this.controller.serialize();if(t!==this.queryValue){this.queryValue=t;let e=this.$refs?.textarea;e&&(e.value=t)}this.updateMentionState()},updateMentionState(){if(!this.controller)return;let t=this.controller.detectMention();if(!t){this.mentionOpen=!1,this.mentionQuery="",this.mentionOptions=this.lensOptions,this.mentionIndex=0;return}let e=t.query,n=this.lensOptions.filter(s=>s.atName.startsWith(e)),o=this.mentionOpen&&this.mentionQuery===e;this.mentionOpen=n.length>0,this.mentionQuery=e,this.mentionOptions=n,this.mentionIndex=o?Math.min(this.mentionIndex,Math.max(n.length-1,0)):0},buildLensState(t){let e=Object.entries(t).map(([o,s])=>({lensId:s,atName:o.toLowerCase()})).filter(o=>o.atName),n=Object.fromEntries(Object.entries(t).map(([o,s])=>[s,o]));this.lensOptions=e,this.mentionOptions=e,this.idToAtName=n},getSelectedLens(){let t=this.$store.search.lens_id||"";if(!t)return null;let e=this.idToAtName[t]||"";return{lensId:t,atName:e}},selectMention(){if(!this.controller||!this.mentionOpen||!this.mentionOptions.length)return;let t=this.controller.detectMention();if(!t)return;let e=this.mentionOptions[this.mentionIndex];e&&(this.controller.insertLensToken(t,e.lensId,e.atName),this.$store.search.lens_id=e.lensId,this.queryValue=this.controller.serialize(),this.mentionOpen=!1,this.mentionQuery="",this.mentionOptions=this.lensOptions,this.mentionIndex=0)},handleEditorKeydown(t){if(!this.mentionOpen){t.key==="Enter"&&(t.preventDefault(),this.submit());return}if(t.key==="ArrowDown"){t.preventDefault();let e=Math.max(this.mentionOptions.length-1,0);this.mentionIndex=Math.min(this.mentionIndex+1,e);return}if(t.key==="ArrowUp"){t.preventDefault(),this.mentionIndex=Math.max(this.mentionIndex-1,0);return}if(t.key==="Enter"||t.key===" "){t.preventDefault(),this.selectMention();return}t.key==="Escape"&&(t.preventDefault(),this.mentionOpen=!1,this.mentionQuery="",this.mentionOptions=this.lensOptions,this.mentionIndex=0)},async submit(){if(this.submitting)return;let t=this.$refs?.form;if(!t)throw new Error("Form ref not found");this.submitting=!0;try{let n=this.$refs?.lensSelect?.value?.trim()||this.$store.search.lens_id||"",o=this.queryValue.trim(),s=Number(this.$store.search.limit);if(!s||s<1)throw new Error("Invalid search limit");let i={q:o,exact:!!this.$store.search.exact,limit:s,lens_id:n||void 0},l=await fetch("/v1/search/fragment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!l.ok)throw new Error(`Search failed (HTTP ${l.status})`);let f=await l.text(),u=document.querySelector("#search-root");if(!u)throw new Error("Page missing #search-root element");u.outerHTML=f;let r=new URLSearchParams;i.q&&r.set("q",i.q),i.exact&&r.set("exact","true"),i.limit&&r.set("limit",String(i.limit)),i.lens_id&&r.set("lens_id",i.lens_id);let a=r.toString()?`${t.action}?${r.toString()}`:t.action;window.history.replaceState({},"",a)}catch(e){let n=e instanceof Error?e.message:String(e);this.showError(`Search failed: ${n}`)}finally{this.submitting=!1}}});var H=(t,e)=>({lensId:t,rawAtName:e,init(){if(!this.lensId||!this.rawAtName)throw new Error("lensId and rawAtName are required");this.render()},render(){let n=this.$el,o=C(this.rawAtName.toLowerCase());n.className="query-token",n.dataset.token="lens",n.dataset.lensId=this.lensId,n.dataset.atName=o,n.textContent=`@${o}`,n.setAttribute("contenteditable","false"),n.style.cursor="pointer"},removeLens(){this.$store.search.clearLens()}});var V=()=>({pending:!1,assistantEventSource:null,jobPollTimeout:null,jobPollAttempt:0,createPlaceholder(t){let e=this.$refs.placeholderTemplate.content.cloneNode(!0),n=e.querySelector(".message");return n.dataset.tempId=t,e},parseHtmlElement(t){let e=document.createElement("template");return e.innerHTML=String(t).trim(),e.content.firstElementChild},cleanupAssistantStream(){this.assistantEventSource&&this.assistantEventSource.close(),this.assistantEventSource=null},cleanupJobPoll(){this.jobPollTimeout&&clearTimeout(this.jobPollTimeout),this.jobPollTimeout=null,this.jobPollAttempt=0},async pollJobStatus(t,e){try{let n=await fetch(`/v1/threads/${t}/activity`,{headers:{Accept:"application/json"}});if(!n.ok)return;if((await n.json())?.job_events?.[0]?.status==="failed"){let l=this.$refs.responses.querySelector(`[data-temp-id="${e}"]`);l&&l.remove(),this.cleanupJobPoll();return}this.jobPollAttempt+=1;let i=Math.min(1e3*Math.pow(2,this.jobPollAttempt),3e4);this.jobPollTimeout=setTimeout(()=>this.pollJobStatus(t,e),i)}catch(n){console.error("Error polling job status:",n),this.jobPollAttempt+=1;let o=Math.min(1e3*Math.pow(2,this.jobPollAttempt),3e4);this.jobPollTimeout=setTimeout(()=>this.pollJobStatus(t,e),o)}},startEventStreams(t,e,{afterAssistantUuid:n=null}={}){if(this.assistantEventSource)return;let o=new URL(`/v1/threads/${t}/stream`,window.location.origin);o.searchParams.set("role","assistant"),n&&o.searchParams.set("after_uuid",n),this.assistantEventSource=new EventSource(o),this.assistantEventSource.addEventListener("assistant",async s=>{try{let l=JSON.parse(s?.data||"{}")?.uuid;if(!l)return;let f=await fetch(`/v1/messages/${l}/fragment`,{headers:{Accept:"text/html"}});if(!f.ok)return;let u=await f.text(),r=this.parseHtmlElement(u),a=this.$refs.responses.querySelector(`[data-temp-id="${e}"]`);a&&r&&a.replaceWith(r),this.cleanupJobPoll()}finally{this.cleanupAssistantStream()}}),this.assistantEventSource.addEventListener("error",()=>this.cleanupAssistantStream()),this.jobPollAttempt=0,this.pollJobStatus(t,e)},init(){if(!this.$refs.responses||this.$refs.responses.children.length)return;let t=this.$el?.dataset?.threadId;if(!t)return;let e="initial",n=this.createPlaceholder(e);this.$refs.responses.prepend(n),this.startEventStreams(t,e)},async regenerate(t){if(this.pending)return;let e=t?.currentTarget,n=e?.dataset?.threadId,o=e?.dataset?.model,s=e?.dataset?.promptContent;if(!n||!s)return;this.pending=!0;let i=Math.random().toString(36).slice(2,10),l=this.createPlaceholder(i);this.$refs.responses.prepend(l);try{let u=this.$refs.responses.querySelector(".message[data-uuid]")?.dataset?.uuid||null,r=await fetch("/v1/ask",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:s,thread_id:n,lens_id:this.$refs?.lensSelect?.value||void 0,model:o})});if(!r.ok)throw new Error(`Ask HTTP ${r.status}`);this.startEventStreams(n,i,{afterAssistantUuid:u})}catch(f){console.error("Error:",f);let u=this.$refs.responses.querySelector(`[data-temp-id="${i}"]`);u&&u.remove()}finally{this.pending=!1}}});function $(t){if(typeof t!="string")throw new TypeError("escapeHtml expects a string");return t.replace(/[&<>"']/g,e=>e==="&"?"&amp;":e==="<"?"&lt;":e===">"?"&gt;":e==='"'?"&quot;":"&#39;")}function b(t){if(typeof t!="string")throw new TypeError("parseInline expects a string");let e=[],n=[],o=i=>`ROSECODE${i}`,s=i=>`ROSELINK${i}`;return t=t.replace(/`([^`]*?)`/g,(i,l)=>{let f=e.length;return e.push($(l)),o(f)}),t=t.replace(/\[([^\]]+)\]\(([^)]+)\)/g,(i,l,f)=>{let u=f.trim();if(!(/^(https?|mailto|tel):/i.test(u)||/^[/.#]/.test(u)))return l;let a=n.length,h=$(l),d=$(u);return n.push(`<a href="${d}" target="_blank" rel="noopener noreferrer">${h}</a>`),s(a)}),t=$(t),t=t.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),t=t.replace(/__([^_]+)__/g,"<strong>$1</strong>"),t=t.replace(/\*([^*]+)\*/g,"<em>$1</em>"),t=t.replace(/_([^_]+)_/g,"<em>$1</em>"),t=t.replace(/\u0001ROSELINK(\d+)\u0001/g,(i,l)=>{let f=n[Number(l)];if(f===void 0)throw new Error("Invalid link placeholder index");return f}),t=t.replace(/\u0001ROSECODE(\d+)\u0001/g,(i,l)=>{let f=e[Number(l)];if(f===void 0)throw new Error("Invalid code placeholder index");return`<code>${f}</code>`}),t}function J(t){if(typeof t!="string")throw new TypeError("markdownToHtml expects a string");t=t.replace(/\r\n?/g,`
`);let e=[];t=t.replace(/```([^\s`]+)?\s*\n([\s\S]*?)```/g,(h,d,x)=>{let m=e.length;return e.push({lang:(d||"").trim(),code:x}),`\0CODEBLOCK_${m}\0`});let n=t.split(`
`),o="",s=!1,i=!1,l=!1,f=[];function u(){f.length>0&&(o+=`<p>${b(f.join(" "))}</p>
`,f=[])}function r(){s&&(o+=`</ul>
`,s=!1),i&&(o+=`</ol>
`,i=!1)}function a(){l&&(o+=`</blockquote>
`,l=!1)}for(let h=0;h<n.length;h++){let d=n[h],x=d.match(/^\u0000CODEBLOCK_(\d+)\u0000$/);if(x){u(),r(),a();let k=e[Number(x[1])],c=k.lang?` class="language-${$(k.lang)}"`:"";o+=`<pre><code${c}>${$(k.code)}</code></pre>
`;continue}if(!d.trim()){u(),r(),a();continue}if(/^(\-\-\-|\*\*\*|___)\s*$/.test(d.trim())){u(),r(),a(),o+=`<hr />
`;continue}if(/^\s*>\s?/.test(d)){u(),r(),l||(o+=`<blockquote>
`,l=!0);let k=d.replace(/^\s*>\s?/,"");o+=`${b(k)}
`;continue}let m=d.match(/^(#{1,6})\s+(.*)$/);if(m){u(),r(),a();let k=m[1].length,c=m[2].trim();o+=`<h${k}>${b(c)}</h${k}>
`;continue}let w=d.match(/^\s*(\d+)\.\s+(.*)$/);if(w){u(),a(),s&&(o+=`</ul>
`,s=!1),i||(o+=`<ol>
`,i=!0),o+=`<li>${b(w[2])}</li>
`;continue}let g=d.match(/^\s*[-*+]\s+(.*)$/);if(g){u(),a(),i&&(o+=`</ol>
`,i=!1),s||(o+=`<ul>
`,s=!0),o+=`<li>${b(g[1])}</li>
`;continue}a(),r(),f.push(d)}return u(),r(),a(),o.trim()}document.addEventListener("alpine:init",()=>{if(!window.TRANSPORT?.search)throw new Error("TRANSPORT.search not found");Alpine.store("search",{...window.TRANSPORT.search,clearLens(){this.lens_id=""}}),Alpine.magic("markdown",()=>t=>J(t)),Alpine.data("askButton",M),Alpine.data("responseMessage",P),Alpine.data("searchForm",z),Alpine.data("lensToken",H),Alpine.data("threadMessagesPage",V)});})();
