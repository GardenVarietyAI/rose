(()=>{var U=()=>({disabled:!1,label:"Ask",async ask(){let e=this.$el.closest("form")?.querySelector('[name="q"]:not([disabled])')?.value?.trim()||"";if(!e||this.disabled)return;let t=this.$store?.search?.lens_ids,s=Array.isArray(t)&&t[0]||"",n=this.$store?.search?.factsheet_ids,r=Array.isArray(n)?n:[];this.disabled=!0;try{let u=await(await fetch("/v1/ask",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:e,lens_ids:s?[s]:[],factsheet_ids:r})})).json();if(!u?.thread_id)throw new Error("Missing thread_id");window.location.href="/v1/threads/"+u.thread_id}catch(i){alert("Error: "+(i?.message||String(i)))}finally{this.disabled=!1}}});var B=()=>({uuid:null,accepted:!1,collapsed:!1,expanded:!1,editing:!1,draft:"",original:"",editable:!1,saving:!1,init(){this.uuid=this.$el.dataset.uuid,this.accepted=this.$el.classList.contains("accepted");let e=this.$refs?.sourceContent;this.editable=!!e;let t=this.$el.querySelector(".message-content");if(t&&!this.editable){let n=t.textContent?.trim()||"";t.innerHTML=this.$markdown(n)}if(!this.editable)return;let s=e.content?.textContent;this.original=(s??t?.innerText??"").trimEnd(),this.draft=this.original},startEdit(){this.editable&&(this.editing=!0,this.draft=this.original,this.$nextTick(()=>this.$refs?.editor?.focus()))},cancelEdit(){this.editable&&(this.editing=!1,this.draft=this.original)},async saveEdit(){if(!(!this.editable||this.saving)){this.saving=!0;try{let e=await fetch(`/v1/messages/${this.uuid}/revisions`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({content:this.draft})});if(!e.ok)throw new Error(`HTTP ${e.status}`);window.location.reload()}catch(e){console.error("Error:",e),this.saving=!1}}},async toggleAccepted(){try{let e=await fetch(`/v1/messages/${this.uuid}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({accepted:!this.accepted})});if(!e.ok)throw new Error(`HTTP ${e.status}`);this.accepted=!this.accepted}catch(e){console.error("Error:",e)}}});var N,ae,ue,oe;function G(e){return{lang:e?.lang??N?.lang,message:e?.message,abortEarly:e?.abortEarly??N?.abortEarly,abortPipeEarly:e?.abortPipeEarly??N?.abortPipeEarly}}function ce(e){return ae?.get(e)}function le(e){return ue?.get(e)}function pe(e,t){return oe?.get(e)?.get(t)}function S(e){let t=typeof e;return t==="string"?`"${e}"`:t==="number"||t==="bigint"||t==="boolean"?`${e}`:t==="object"||t==="function"?(e&&Object.getPrototypeOf(e)?.constructor?.name)??"null":t}function w(e,t,s,n,r){let i=r&&"input"in r?r.input:s.value,u=r?.expected??e.expects??null,o=r?.received??S(i),a={kind:e.kind,type:e.type,input:i,expected:u,received:o,message:`Invalid ${t}: ${u?`Expected ${u} but r`:"R"}eceived ${o}`,requirement:e.requirement,path:r?.path,issues:r?.issues,lang:n.lang,abortEarly:n.abortEarly,abortPipeEarly:n.abortPipeEarly},c=e.kind==="schema",h=r?.message??e.message??pe(e.reference,a.lang)??(c?le(a.lang):null)??n.message??ce(a.lang);h!==void 0&&(a.message=typeof h=="function"?h(a):h),c&&(s.typed=!1),s.issues?s.issues.push(a):s.issues=[a]}function q(e){return{version:1,vendor:"valibot",validate:t=>e["~run"]({value:t},G())}}var de=class extends Error{constructor(e){super(e[0].message),this.name="ValiError",this.issues=e}};function P(e,t){return{kind:"validation",type:"max_value",reference:P,async:!1,expects:`<=${e instanceof Date?e.toJSON():S(e)}`,requirement:e,message:t,"~run"(s,n){return!s.typed||s.value<=this.requirement||w(this,"value",s,n,{received:s.value instanceof Date?s.value.toJSON():S(s.value)}),s}}}function O(e,t){return{kind:"validation",type:"min_length",reference:O,async:!1,expects:`>=${e}`,requirement:e,message:t,"~run"(s,n){return s.typed&&s.value.length<this.requirement&&w(this,"length",s,n,{received:`${s.value.length}`}),s}}}function R(e,t){return{kind:"validation",type:"min_value",reference:R,async:!1,expects:`>=${e instanceof Date?e.toJSON():S(e)}`,requirement:e,message:t,"~run"(s,n){return!s.typed||s.value>=this.requirement||w(this,"value",s,n,{received:s.value instanceof Date?s.value.toJSON():S(s.value)}),s}}}function he(e,t,s){return typeof e.fallback=="function"?e.fallback(t,s):e.fallback}function fe(e,t,s){return typeof e.default=="function"?e.default(t,s):e.default}function I(e,t){return{kind:"schema",type:"array",reference:I,expects:"Array",async:!1,item:e,message:t,get"~standard"(){return q(this)},"~run"(s,n){let r=s.value;if(Array.isArray(r)){s.typed=!0,s.value=[];for(let i=0;i<r.length;i++){let u=r[i],o=this.item["~run"]({value:u},n);if(o.issues){let a={type:"array",origin:"value",input:r,key:i,value:u};for(let c of o.issues)c.path?c.path.unshift(a):c.path=[a],s.issues?.push(c);if(s.issues||(s.issues=o.issues),n.abortEarly){s.typed=!1;break}}o.typed||(s.typed=!1),s.value.push(o.value)}}else w(this,"type",s,n);return s}}}function C(e){return{kind:"schema",type:"boolean",reference:C,expects:"boolean",async:!1,message:e,get"~standard"(){return q(this)},"~run"(t,s){return typeof t.value=="boolean"?t.typed=!0:w(this,"type",t,s),t}}}function L(e){return{kind:"schema",type:"number",reference:L,expects:"number",async:!1,message:e,get"~standard"(){return q(this)},"~run"(t,s){return typeof t.value!="number"||isNaN(t.value)?w(this,"type",t,s):t.typed=!0,t}}}function F(e,t){return{kind:"schema",type:"object",reference:F,expects:"Object",async:!1,entries:e,message:t,get"~standard"(){return q(this)},"~run"(s,n){let r=s.value;if(r&&typeof r=="object"){s.typed=!0,s.value={};for(let i in this.entries){let u=this.entries[i];if(i in r||(u.type==="exact_optional"||u.type==="optional"||u.type==="nullish")&&u.default!==void 0){let o=i in r?r[i]:fe(u),a=u["~run"]({value:o},n);if(a.issues){let c={type:"object",origin:"value",input:r,key:i,value:o};for(let h of a.issues)h.path?h.path.unshift(c):h.path=[c],s.issues?.push(h);if(s.issues||(s.issues=a.issues),n.abortEarly){s.typed=!1;break}}a.typed||(s.typed=!1),s.value[i]=a.value}else if(u.fallback!==void 0)s.value[i]=he(u);else if(u.type!=="exact_optional"&&u.type!=="optional"&&u.type!=="nullish"&&(w(this,"key",s,n,{input:void 0,expected:`"${i}"`,path:[{type:"object",origin:"key",input:r,key:i,value:r[i]}]}),n.abortEarly))break}}else w(this,"type",s,n);return s}}}function A(e){return{kind:"schema",type:"string",reference:A,expects:"string",async:!1,message:e,get"~standard"(){return q(this)},"~run"(t,s){return typeof t.value=="string"?t.typed=!0:w(this,"type",t,s),t}}}function J(e,t,s){let n=e["~run"]({value:t},G(s));if(n.issues)throw new de(n.issues);return n.value}function j(...e){return{...e[0],pipe:e,get"~standard"(){return q(this)},"~run"(t,s){for(let n of e)if(n.kind!=="metadata"){if(t.issues&&(n.kind==="schema"||n.kind==="transformation")){t.typed=!1;break}t.issues&&(s.abortEarly||s.abortPipeEarly)||(t=n["~run"](t,s))}return t}}}var ye=F({content:A(),lens_ids:I(j(A(),O(1))),factsheet_ids:I(j(A(),O(1))),exact:C(),limit:j(L(),R(1),P(100))});function M(e){return J(ye,e)}var me=/(?:^|[^A-Za-z0-9-])([@#])([A-Za-z0-9-]*)/g;function V(e){let t=window.getSelection();if(!t||!t.rangeCount)return null;let s=t.getRangeAt(0),n=s.startContainer;if(!n||!e.contains(n))return null;let r=s.cloneRange();return r.selectNodeContents(e),r.setEnd(s.startContainer,s.startOffset),r.toString().length}function H(e,t){let s=window.getSelection();if(!s)return;let n=document.createRange(),r=e.firstChild;if(!r||r.nodeType!==Node.TEXT_NODE){n.selectNodeContents(e),n.collapse(!0),s.removeAllRanges(),s.addRange(n);return}n.setStart(r,Math.max(0,Math.min(t,r.textContent?.length||0))),n.collapse(!0),s.removeAllRanges(),s.addRange(n)}function X(e){if(!e)throw new Error("editor is required");return{getText(){return e.textContent||""},setText(t,s=null){e.textContent=t||"",s!==null&&H(e,s)},getCaretOffset(){return V(e)},detectMention(){let t=e.textContent||"",s=V(e);if(s===null)return null;let n=t.slice(0,s),r=Array.from(n.matchAll(me));if(r.length===0)return null;let i=r[r.length-1],u=i[0].startsWith("@")||i[0].startsWith("#")?0:1,o=i.index+u,a=o+i[0].length-u;return a!==s?null:{start:o,end:a,query:i[2].toLowerCase(),raw:i[0].slice(u),type:i[1]==="#"?"tag":"lens"}},replaceRange(t,s,n,r=null){let i=e.textContent||"",u=i.slice(0,t),o=i.slice(s),a=`${u}${n}${o}`,c=r??u.length+n.length;e.textContent=a,H(e,c)}}}function W({controller:e,lensOptions:t,tagOptions:s,previous:n}){if(!e)throw new Error("controller is required");let r=e.detectMention();if(!r)return{open:!1,query:"",options:t,index:0,mention:null};let i=r.query,u=r.type==="tag"?s.filter(h=>h.tag.startsWith(i)):t.filter(h=>h.atName.startsWith(i)),o=!!n?.open&&n?.query===i,a=u.length>0,c=Math.max(u.length-1,0);return{open:a,query:i,options:u,index:o?Math.min(n?.index??0,c):0,mention:r}}function Z(e){let t=Object.entries(e||{}).map(([n,r])=>({lensId:r,atName:String(n||"").toLowerCase()})).filter(n=>n.atName),s=Object.fromEntries(Object.entries(e||{}).map(([n,r])=>[r,n]));return{lensOptions:t,idToAtName:s}}function Q(e,t){let s={},n={},r={},i={},u=[];for(let[o,a]of Object.entries(e||{})){if(!o||!a)continue;let c=String(o).toLowerCase();s[c]=a;let h=t?.[o]||t?.[c]||"";n[c]=h,r[a]=c,i[a]=h,u.push({tag:c,factsheetId:a,title:n[c]})}return{tagOptions:u.sort((o,a)=>o.tag.localeCompare(a.tag)),tagToFactsheetId:s,tagToTitle:n,factsheetIdToTag:r,factsheetIdToTitle:i}}function ve(e){let t=JSON.stringify(e);return btoa(unescape(encodeURIComponent(t))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}async function K({payload:e,formAction:t,rootSelector:s="#search-root",updateUrl:n=!0}){if(!e)throw new Error("payload is required");if(!t)throw new Error("formAction is required");let r=await fetch("/v1/search/fragment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!r.ok)throw new Error(`Search failed (HTTP ${r.status})`);let i=await r.text(),u=document.querySelector(s);if(!u)throw new Error(`Page missing ${s} element`);if(u.outerHTML=i,!n)return;let o=new URLSearchParams;e.content&&o.set("q",e.content),(e.lens_ids.length>0||e.factsheet_ids.length>0||e.exact||e.limit!==10)&&o.set("sq",ve({lens_ids:e.lens_ids,factsheet_ids:e.factsheet_ids,exact:e.exact,limit:e.limit}));let c=o.toString()?`${t}?${o.toString()}`:t;window.history.replaceState({},"",c)}var Y=()=>({queryValue:"",settingsOpen:!1,submitting:!1,pendingSubmit:!1,pendingUpdateUrl:!1,mentionOpen:!1,mentionIndex:0,mentionQuery:"",mentionOptions:[],activeMention:null,lensOptions:[],tagOptions:[],idToAtName:{},factsheetIdToTag:{},factsheetIdToTitle:{},selectedLensId:"",selectedFactsheetIds:[],exact:!1,limit:10,errorMessage:"",editor:null,_normalizeFactsheetIds(e){return Array.from(new Set((e||[]).map(t=>String(t).trim()).filter(Boolean)))},showError(e){this.errorMessage=e,setTimeout(()=>this.errorMessage="",5e3)},init(){let e=this.$store.search.content||"",t=this.$store.search.lens_map||{},s=this.$store.search.factsheet_map||{},n=this.$store.search.factsheet_title_map||{};this.queryValue=e.replace(/^@\S+\s*/,"");let r=Z(t);this.lensOptions=r.lensOptions,this.mentionOptions=r.lensOptions,this.idToAtName=r.idToAtName;let i=Q(s,n);this.tagOptions=i.tagOptions,this.factsheetIdToTag=i.factsheetIdToTag,this.factsheetIdToTitle=i.factsheetIdToTitle;let u=Array.isArray(this.$store.search.lens_ids)?this.$store.search.lens_ids:[];this.selectedLensId=u[0]||"",this.selectedFactsheetIds=this._normalizeFactsheetIds(Array.isArray(this.$store.search.factsheet_ids)?this.$store.search.factsheet_ids:[]),this.exact=!!this.$store.search.exact,this.limit=Number(this.$store.search.limit)||10,this.editor=X(this.$refs?.editor),this.$nextTick(()=>{this.seedFromTransport(),e||this.$refs?.editor?.focus()})},seedFromTransport(){if(!this.editor)return;this.editor.setText(this.queryValue);let e=this.$refs?.textarea;e&&(e.value=this.queryValue);let t=this.$refs?.lensSelect;t&&(t.value=this.selectedLensId||""),this.publishFromState()},getQueryModelFromState(){return M({content:this.queryValue,lens_ids:this.selectedLensId?[this.selectedLensId]:[],factsheet_ids:this.selectedFactsheetIds,exact:this.exact,limit:this.limit})},publishFromState(){let e=this.$store?.search;if(!e?.applyQueryModel)throw new Error("Search store missing applyQueryModel");let t=this.getQueryModelFromState();e.applyQueryModel(t);let s=this.$refs?.lensSelect;s&&(s.value=t.lens_ids[0]||"")},async runSearch({updateUrl:e}){if(this.submitting){this.pendingSubmit=!0,this.pendingUpdateUrl=this.pendingUpdateUrl||e;return}let t=this.$refs?.form;if(!t)throw new Error("Form ref not found");this.submitting=!0;try{let s=this.queryValue.trim();this.queryValue=s;let n=this.$refs?.textarea;n&&(n.value=s),this.publishFromState();let r=this.getQueryModelFromState(),i={content:s,exact:r.exact,limit:r.limit,lens_ids:r.lens_ids,factsheet_ids:r.factsheet_ids};await K({payload:i,formAction:t.action,updateUrl:e})}catch(s){let n=s instanceof Error?s.message:String(s);this.showError(`Search failed: ${n}`)}finally{if(this.submitting=!1,this.pendingSubmit){let s=this.pendingUpdateUrl;this.pendingSubmit=!1,this.pendingUpdateUrl=!1,await this.runSearch({updateUrl:s})}}},refreshResults(){this.runSearch({updateUrl:!1})},clearLensSelection(){this.selectedLensId="";let e=this.$refs?.lensSelect;e&&(e.value=""),this.publishFromState(),this.refreshResults()},handleLensSelectChange(e){let t=e?.target?.value?.trim()||"";this.selectedLensId=t,this.publishFromState(),this.refreshResults()},removeFactsheet(e){let t=String(e).trim();this.selectedFactsheetIds=this._normalizeFactsheetIds((this.selectedFactsheetIds||[]).filter(s=>s!==t)),this.publishFromState(),this.refreshResults()},syncToStore(){if(!this.editor)throw new Error("Editor not initialized");let e=this.editor.getText();if(e!==this.queryValue){this.queryValue=e;let t=this.$refs?.textarea;t&&(t.value=e)}this.publishFromState(),this.updateMentionState()},updateMentionState(){if(!this.editor)return;let e=W({controller:this.editor,lensOptions:this.lensOptions,tagOptions:this.tagOptions,previous:{open:this.mentionOpen,query:this.mentionQuery,index:this.mentionIndex}});this.mentionOpen=e.open,this.mentionQuery=e.query,this.mentionOptions=e.options,this.mentionIndex=e.index,this.activeMention=e.mention},selectMention(e=null){if(!this.editor||!this.mentionOpen||!this.mentionOptions.length)return;let t=this.activeMention||this.editor.detectMention();if(!t)return;let s=e||this.mentionOptions[this.mentionIndex];if(!s)return;if(t.type==="tag"){let r=String(s.factsheetId).trim();this.selectedFactsheetIds.includes(r)||(this.selectedFactsheetIds=this._normalizeFactsheetIds([...this.selectedFactsheetIds,r]))}else{this.selectedLensId=s.lensId;let r=this.$refs?.lensSelect;r&&(r.value=this.selectedLensId)}this.editor.replaceRange(t.start,t.end," ",t.start+1),this.queryValue=this.editor.getText();let n=this.$refs?.textarea;n&&(n.value=this.queryValue),this.publishFromState(),this.mentionOpen=!1,this.mentionQuery="",this.mentionOptions=this.lensOptions,this.mentionIndex=0,this.refreshResults()},handleEditorKeydown(e){if(!this.mentionOpen){e.key==="Enter"&&(e.preventDefault(),this.submit());return}if(e.key==="ArrowDown"){e.preventDefault();let t=Math.max(this.mentionOptions.length-1,0);this.mentionIndex=Math.min(this.mentionIndex+1,t);return}if(e.key==="ArrowUp"){e.preventDefault(),this.mentionIndex=Math.max(this.mentionIndex-1,0);return}if(e.key==="Enter"||e.key===" "){e.preventDefault();let t=this.mentionOptions[this.mentionIndex];this.selectMention(t);return}e.key==="Escape"&&(e.preventDefault(),this.mentionOpen=!1,this.mentionQuery="",this.mentionOptions=this.lensOptions,this.mentionIndex=0)},async submit(){await this.runSearch({updateUrl:!0})}});var ge={},ee=()=>({preview:!1,importing:!1,complete:!1,threads:[],parseReport:null,selectedFormat:null,banner:{visible:!1,type:"",message:"",timeout:null},get currentValidator(){return ge[this.selectedFormat]},handleFormatChange(){this.threads=[],this.parseReport=null,this.preview=!1,this.closeBanner(),this.$refs.fileInput&&(this.$refs.fileInput.value="")},showBanner(e,t){this.banner.visible=!0,this.banner.type=e,this.banner.message=t,this.banner.timeout&&clearTimeout(this.banner.timeout),this.banner.timeout=setTimeout(()=>{this.banner.visible=!1},5e3)},closeBanner(){this.banner.visible=!1,this.banner.timeout&&clearTimeout(this.banner.timeout)},get selectedCount(){return this.threads.filter(e=>e.selected).length},get totalMessageCount(){return this.threads.filter(e=>e.selected).reduce((e,t)=>e+1+t.assistantMessages.length,0)},get parseReportSummary(){if(!this.parseReport)return"";let e=this.parseReport,t=[];if(t.push(`${e.parsed} records parsed`),e.skipped>0){let s=[];e.errors.invalidJSON.length>0&&s.push(`${e.errors.invalidJSON.length} invalid JSON`),e.errors.emptyContent>0&&s.push(`${e.errors.emptyContent} empty content`),e.errors.validationErrors.length>0&&s.push(`${e.errors.validationErrors.length} validation errors`),t.push(`${e.skipped} skipped: ${s.join(", ")}`)}return t.join(", ")},handleFileSelect(e){let t=e.target.files?.[0];if(!t)return;let s=new FileReader;s.onload=n=>{try{let r=n.target.result,{threads:i,report:u}=this.currentValidator.parse(r);this.threads=i,this.parseReport=u,this.preview=!0,u.skipped>0&&this.showBanner("error",this.parseReportSummary)}catch(r){console.error("Parse error:",r),this.showBanner("error",`Failed to parse file: ${r.message}`)}},s.readAsText(t)},toggleAll(){let e=this.threads.every(t=>t.selected);this.threads.forEach(t=>t.selected=!e)},cancelImport(){this.preview=!1,this.threads=[],this.parseReport=null,this.closeBanner(),this.$refs.fileInput.value=""},async executeImport(){if(!(this.importing||this.selectedCount===0)){this.importing=!0;try{let e=[];for(let r of this.threads.filter(i=>i.selected)){e.push({thread_id:r.threadId,role:r.userMessage.role,content:r.userMessage.content,model:r.userMessage.model,created_at:r.userMessage.created_at,import_external_id:r.userMessage.uuid,meta:{imported_external_id:r.userMessage.uuid,imported_external_session_id:r.userMessage.sessionId,imported_external_created_at:r.userMessage.timestamp}});for(let i of r.assistantMessages)e.push({thread_id:r.threadId,role:i.role,content:i.content,model:i.model,created_at:i.created_at,import_external_id:i.uuid,meta:{imported_external_id:i.uuid,imported_external_session_id:i.sessionId,imported_external_created_at:i.timestamp}})}let t=await fetch("/v1/import/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({import_source:this.currentValidator.importSource,messages:e})});if(!t.ok)throw new Error("Could not import records.");let s=await t.json();this.preview=!1,this.complete=!0;let n=s.skipped_duplicates>0?`Imported ${s.imported} messages (skipped ${s.skipped_duplicates} duplicates)`:`Successfully imported ${s.imported} messages`;this.showBanner("success",n)}catch(e){console.error("Import error:",e),this.showBanner("error",`Failed to import: ${e.message}`),this.importing=!1}}}});var te=()=>({pending:!1,assistantEventSource:null,jobPollTimeout:null,jobPollAttempt:0,createPlaceholder(e){let t=this.$refs.placeholderTemplate.content.cloneNode(!0),s=t.querySelector(".message");return s.dataset.tempId=e,t},parseHtmlElement(e){let t=document.createElement("template");return t.innerHTML=String(e).trim(),t.content.firstElementChild},cleanupAssistantStream(){this.assistantEventSource&&this.assistantEventSource.close(),this.assistantEventSource=null},cleanupJobPoll(){this.jobPollTimeout&&clearTimeout(this.jobPollTimeout),this.jobPollTimeout=null,this.jobPollAttempt=0},async pollJobStatus(e,t){try{let s=await fetch(`/v1/threads/${e}/activity`,{headers:{Accept:"application/json"}});if(!s.ok)return;if((await s.json())?.job_events?.[0]?.status==="failed"){let u=this.$refs.responses.querySelector(`[data-temp-id="${t}"]`);u&&u.remove(),this.cleanupJobPoll();return}this.jobPollAttempt+=1;let i=Math.min(1e3*Math.pow(2,this.jobPollAttempt),3e4);this.jobPollTimeout=setTimeout(()=>this.pollJobStatus(e,t),i)}catch(s){console.error("Error polling job status:",s),this.jobPollAttempt+=1;let n=Math.min(1e3*Math.pow(2,this.jobPollAttempt),3e4);this.jobPollTimeout=setTimeout(()=>this.pollJobStatus(e,t),n)}},startEventStreams(e,t,{afterAssistantUuid:s=null}={}){if(this.assistantEventSource)return;let n=new URL(`/v1/threads/${e}/stream`,window.location.origin);n.searchParams.set("role","assistant"),s&&n.searchParams.set("after_uuid",s),this.assistantEventSource=new EventSource(n),this.assistantEventSource.addEventListener("assistant",async r=>{try{let u=JSON.parse(r?.data||"{}")?.uuid;if(!u)return;let o=await fetch(`/v1/messages/${u}/fragment`,{headers:{Accept:"text/html"}});if(!o.ok)return;let a=await o.text(),c=this.parseHtmlElement(a),h=this.$refs.responses.querySelector(`[data-temp-id="${t}"]`);h&&c&&h.replaceWith(c),this.cleanupJobPoll()}finally{this.cleanupAssistantStream()}}),this.assistantEventSource.addEventListener("error",()=>this.cleanupAssistantStream()),this.jobPollAttempt=0,this.pollJobStatus(e,t)},init(){if(!this.$refs.responses||this.$refs.responses.children.length)return;let e=this.$el?.dataset?.threadId;if(!e)return;let t="initial",s=this.createPlaceholder(t);this.$refs.responses.prepend(s),this.startEventStreams(e,t)},async regenerate(e){if(this.pending)return;let t=e?.currentTarget,s=t?.dataset?.threadId,n=t?.dataset?.model,r=t?.dataset?.promptContent;if(!s||!r)return;this.pending=!0;let i=Math.random().toString(36).slice(2,10),u=this.createPlaceholder(i);this.$refs.responses.prepend(u);try{let a=this.$refs.responses.querySelector(".message[data-uuid]")?.dataset?.uuid||null,c=await fetch("/v1/ask",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:r,thread_id:s,lens_ids:this.$refs?.lensSelect?.value?[this.$refs.lensSelect.value]:[],factsheet_ids:[],model:n})});if(!c.ok)throw new Error(`Ask HTTP ${c.status}`);this.startEventStreams(s,i,{afterAssistantUuid:a})}catch(o){console.error("Error:",o);let a=this.$refs.responses.querySelector(`[data-temp-id="${i}"]`);a&&a.remove()}finally{this.pending=!1}}});var se=()=>({}),ne=e=>({open(){this.$store.threads.setCurrentThread(e),this.$refs.popover.showPopover()},close(){this.$refs.popover.hidePopover(),this.$store.threads.clearCurrentThread()},get isDeleting(){return this.$store.threads.isDeleting(e)},async confirmDelete(){this.$store.threads.setDeleting(!0);try{let t=await fetch(`/v1/threads/${e}`,{method:"DELETE"});if(!t.ok){let s=await t.json().catch(()=>({}));throw new Error(s.detail||`HTTP ${t.status}`)}window.location.reload()}catch(t){console.error("Delete error:",t),alert(`Failed to delete thread: ${t.message}`),this.$store.threads.setDeleting(!1)}}});function re(e,t){if(typeof e!="string")throw new TypeError("highlightCode expects a string");let s=ke(e,t),n=[],r=[],i=[],u=[],o=[],a=l=>{if(!Number.isInteger(l)||l<0)throw new TypeError("encodeIndex expects a non-negative integer");let d="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",y=d.length,f=l,$="";do $=d[f%y]+$,f=Math.floor(f/y);while(f>0);return $},c=l=>`HLSTR${a(l)}`,h=l=>`HLCMT${a(l)}`,k=l=>`HLKW${a(l)}`,v=l=>`HLBI${a(l)}`,g=l=>`HLNUM${a(l)}`,b=l=>{let d="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",y=d.length,f=0;for(let $ of String(l)){let z=d.indexOf($);if(z===-1)throw new Error("Invalid placeholder encoding");f=f*y+z}return f},p=e;s==="python"?(p=p.replace(/#[^\n]*/g,l=>{let d=r.length;return r.push(l),h(d)}),p=p.replace(/'''[\s\S]*?'''|"""[\s\S]*?"""/g,l=>{let d=n.length;return n.push(l),c(d)}),p=p.replace(/'([^'\\]|\\.)*?'|"([^"\\]|\\.)*?"/g,l=>{let d=n.length;return n.push(l),c(d)})):s==="sql"?(p=p.replace(/--[^\n]*/g,l=>{let d=r.length;return r.push(l),h(d)}),p=p.replace(/'([^'\\]|\\.)*?'/g,l=>{let d=n.length;return n.push(l),c(d)})):(p=p.replace(/\/\/[^\n]*/g,l=>{let d=r.length;return r.push(l),h(d)}),p=p.replace(/\/\*[\s\S]*?\*\//g,l=>{let d=r.length;return r.push(l),h(d)}),p=p.replace(/'([^'\\]|\\.)*?'|"([^"\\]|\\.)*?"|`([^`\\]|\\.)*?`/g,l=>{let d=n.length;return n.push(l),c(d)})),p=D(p);let x=l=>l.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),m=be(s);if(m.length>0){let l=s==="sql"?"gi":"g",d=new RegExp(`\\b(${m.map(x).join("|")})\\b`,l);p=p.replace(d,y=>{let f=i.length;return i.push(y),k(f)})}let _=xe(s);if(_.length>0){let l=s==="sql"?"gi":"g",d=new RegExp(`\\b(${_.map(x).join("|")})\\b`,l);p=p.replace(d,y=>{let f=u.length;return u.push(y),v(f)})}return p=p.replace(/\b\d+(\.\d+)?\b/g,l=>{let d=o.length;return o.push(l),g(d)}),p=p.replace(/\u0001HLSTR([A-Za-z]+)\u0001/g,(l,d)=>{let y=b(d),f=n[y];if(f===void 0)throw new Error("Invalid string placeholder index");return`<span class="hl-str">${D(f)}</span>`}),p=p.replace(/\u0001HLCMT([A-Za-z]+)\u0001/g,(l,d)=>{let y=b(d),f=r[y];if(f===void 0)throw new Error("Invalid comment placeholder index");return`<span class="hl-cmt">${D(f)}</span>`}),p=p.replace(/\u0001HLNUM([A-Za-z]+)\u0001/g,(l,d)=>{let y=b(d),f=o[y];if(f===void 0)throw new Error("Invalid number placeholder index");return`<span class="hl-num">${f}</span>`}),p=p.replace(/\u0001HLBI([A-Za-z]+)\u0001/g,(l,d)=>{let y=b(d),f=u[y];if(f===void 0)throw new Error("Invalid builtin placeholder index");return`<span class="hl-bi">${f}</span>`}),p=p.replace(/\u0001HLKW([A-Za-z]+)\u0001/g,(l,d)=>{let y=b(d),f=i[y];if(f===void 0)throw new Error("Invalid keyword placeholder index");return`<span class="hl-kw">${f}</span>`}),p}function D(e){if(typeof e!="string")throw new TypeError("escapeHtml expects a string");return e.replace(/[&<>"']/g,t=>t==="&"?"&amp;":t==="<"?"&lt;":t===">"?"&gt;":t==='"'?"&quot;":"&apos;")}function ke(e,t){if(t){let s=t.toLowerCase();return s==="js"||s==="javascript"||s==="typescript"||s==="ts"?"javascript":s==="py"||s==="python"?"python":s==="sql"||s==="postgres"||s==="postgresql"||s==="mysql"?"sql":s==="go"||s==="golang"?"go":s==="rs"||s==="rust"?"rust":s==="sh"||s==="bash"||s==="shell"?"shell":s}return/\b(def|class)\s+\w+[\(:]/.test(e)?"python":/\b(const|let|var|function)\s+\w+/.test(e)?"javascript":/^\s*(SELECT|INSERT|UPDATE|DELETE|CREATE|ALTER|DROP)\b/mi.test(e)?"sql":/\bfn\s+\w+\(/.test(e)?"rust":/\bfunc\s+\w+\(/.test(e)?"go":"generic"}function be(e){let t={python:["def","class","if","else","elif","for","while","return","import","from","as","try","except","finally","with","lambda","yield","async","await","raise","pass","break","continue","in","is","not","and","or"],javascript:["function","const","let","var","if","else","for","while","return","import","export","default","class","extends","async","await","yield","typeof","new","delete","this","super","static","try","catch","finally","throw","break","continue","switch","case"],sql:["SELECT","FROM","WHERE","JOIN","INNER","LEFT","RIGHT","OUTER","ON","INSERT","INTO","VALUES","UPDATE","SET","DELETE","CREATE","TABLE","ALTER","DROP","INDEX","ORDER","BY","GROUP","HAVING","LIMIT","OFFSET","AS","AND","OR","NOT","IN","LIKE","BETWEEN"],go:["func","package","import","var","const","type","struct","interface","if","else","for","range","return","defer","go","chan","select","case","switch","break","continue"],rust:["fn","let","mut","const","static","struct","enum","impl","trait","type","if","else","match","for","while","loop","return","break","continue","use","mod","pub","crate"],shell:["if","then","else","elif","fi","for","while","do","done","case","esac","function","return","exit","export","source"],generic:[]};return t[e]||t.generic}function xe(e){let t={python:["True","False","None","self","str","int","float","bool","list","dict","tuple","set","len","range","print","open","type","isinstance","super","__init__","__name__"],javascript:["true","false","null","undefined","NaN","Infinity","console","window","document","Array","Object","String","Number","Boolean","Math","Date","Promise","JSON"],sql:["NULL","TRUE","FALSE","COUNT","SUM","AVG","MIN","MAX","DISTINCT","EXISTS"],go:["true","false","nil","make","new","len","cap","append","copy","delete","panic","recover"],rust:["true","false","None","Some","Ok","Err","Vec","String","Option","Result","println","panic"],shell:["echo","cd","ls","pwd","cat","grep","sed","awk","find","chmod","chown"],generic:["true","false","null","undefined"]};return t[e]||t.generic}function E(e){if(typeof e!="string")throw new TypeError("escapeHtml expects a string");return e.replace(/[&<>"']/g,t=>t==="&"?"&amp;":t==="<"?"&lt;":t===">"?"&gt;":t==='"'?"&quot;":"&#39;")}function T(e){if(typeof e!="string")throw new TypeError("parseInline expects a string");let t=[],s=[],n=[],r=o=>`ROSECODE${o}`,i=o=>`ROSELINK${o}`,u=o=>`ROSEAUTOLINK${o}`;return e=e.replace(/`([^`]*?)`/g,(o,a)=>{let c=t.length;return t.push(E(a)),r(c)}),e=e.replace(/\[([^\]]+)\]\(([^)]+)\)/g,(o,a,c)=>{let h=c.trim();if(!(/^(https?|mailto|tel):/i.test(h)||/^[/.#]/.test(h)))return a;let v=s.length,g=E(a),b=E(h);return s.push(`<a href="${b}" target="_blank" rel="noopener noreferrer">${g}</a>`),i(v)}),e=e.replace(/\bhttps?:\/\/[^\s<>"']+/g,o=>{let a=o,c="";for(;/[),.;:!?\\\]]$/.test(a);)c=a.slice(-1)+c,a=a.slice(0,-1);if(!a)return E(o);let h=n.length,k=E(a);return n.push(`<a href="${k}" target="_blank" rel="noopener noreferrer">${k}</a>${E(c)}`),u(h)}),e=E(e),e=e.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),e=e.replace(/__([^_]+)__/g,"<strong>$1</strong>"),e=e.replace(/\*([^*]+)\*/g,"<em>$1</em>"),e=e.replace(/_([^_]+)_/g,"<em>$1</em>"),e=e.replace(/\u0001ROSELINK(\d+)\u0001/g,(o,a)=>{let c=s[Number(a)];if(c===void 0)throw new Error("Invalid link placeholder index");return c}),e=e.replace(/\u0001ROSEAUTOLINK(\d+)\u0001/g,(o,a)=>{let c=n[Number(a)];if(c===void 0)throw new Error("Invalid auto-link placeholder index");return c}),e=e.replace(/\u0001ROSECODE(\d+)\u0001/g,(o,a)=>{let c=t[Number(a)];if(c===void 0)throw new Error("Invalid code placeholder index");return`<code>${c}</code>`}),e}function ie(e){if(typeof e!="string")throw new TypeError("markdownToHtml expects a string");let t=1e5;if(e.length>t){let x=e.slice(0,t),m=`<div class="markdown-error">Content exceeds ${t} characters, showing truncated...`;return m+=`</div><pre>${E(x)}</pre>`,m}e=e.replace(/\r\n?/g,`
`);let s=e.split(`
`),n="",r=!1,i=!1,u=!1,o=!1,a=[],c=[],h="",k=[];function v(){a.length>0&&(n+=`<p>${T(a.join(" "))}</p>
`,a=[])}function g(){u&&(n+=`<blockquote>${c.join(`<br />
`)}</blockquote>
`,c=[],u=!1)}function b(){if(!o)return;let x=k.join(`
`),m=h?` class="language-${E(h)}"`:"",_=re(x,h);n+=`<pre><code${m}>${_}</code></pre>
`,h="",k=[],o=!1}function p(){r&&(n+=`</ul>
`,r=!1),i&&(n+=`</ol>
`,i=!1)}for(let x=0;x<s.length;x++){let m=s[x],_=m.match(/^```([^\s`]+)?\s*$/);if(_){v(),p(),g(),o?b():(o=!0,h=(_[1]||"").trim(),k=[]);continue}if(o){k.push(m);continue}if(!m.trim()){v(),p(),g();continue}if(/^(\-\-\-|\*\*\*|___)\s*$/.test(m.trim())){v(),p(),g(),n+=`<hr />
`;continue}if(/^\s*>\s?/.test(m)){v(),p(),u||(u=!0);let f=m.replace(/^\s*>\s?/,"");c.push(T(f));continue}let l=m.match(/^(#{1,6})\s+(.*)$/);if(l){v(),p(),g();let f=l[1].length,$=l[2].trim();n+=`<h${f}>${T($)}</h${f}>
`;continue}let d=m.match(/^\s*(\d+)\.\s+(.*)$/);if(d){v(),g(),r&&(n+=`</ul>
`,r=!1),i||(n+=`<ol>
`,i=!0),n+=`<li>${T(d[2])}</li>
`;continue}let y=m.match(/^\s*[-*+]\s+(.*)$/);if(y){v(),g(),i&&(n+=`</ol>
`,i=!1),r||(n+=`<ul>
`,r=!0),n+=`<li>${T(y[1])}</li>
`;continue}g(),p(),a.push(m)}return b(),v(),p(),g(),n.trim()}document.addEventListener("alpine:init",()=>{if(!window.TRANSPORT?.search)throw new Error("TRANSPORT.search not found");Alpine.store("search",{...window.TRANSPORT.search,applyQueryModel(e){let t=M(e);this.content=t.content,this.lens_ids=t.lens_ids,this.factsheet_ids=t.factsheet_ids,this.exact=t.exact,this.limit=t.limit}}),Alpine.store("threads",{...window.TRANSPORT.threads,setCurrentThread(e){this.currentThreadId=e},clearCurrentThread(){this.currentThreadId=null},setDeleting(e){this.deleting=e},isDeleting(e){return this.deleting&&this.currentThreadId===e}}),Alpine.magic("markdown",()=>ie),Alpine.data("askButton",U),Alpine.data("responseMessage",B),Alpine.data("searchForm",Y),Alpine.data("importPage",ee),Alpine.data("threadMessagesPage",te),Alpine.data("threadsListPage",se),Alpine.data("deleteConfirmPopover",ne)});})();
